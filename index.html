<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAM Client Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#000000', 800: '#0a0a0a', 700: '#111111', 600: '#1a1a1a', 500: '#222222' },
                        accent: { cyan: '#00d4ff', purple: '#a855f7', green: '#10b981', yellow: '#fbbf24', red: '#ef4444' }
                    },
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #000000; color: #ffffff; }
        .gradient-text { background: linear-gradient(135deg, #00d4ff 0%, #a855f7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .card { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.08); }
        .tab-active { background: linear-gradient(135deg, rgba(0,212,255,0.1) 0%, rgba(168,85,247,0.1) 100%); border-left: 3px solid #00d4ff; }
        .scrollbar::-webkit-scrollbar { width: 6px; }
        .scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .section-title { font-size: 0.875rem; font-weight: 600; color: #a855f7; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; }
        .saving { opacity: 0.6; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext } = React;

        // Supabase Configuration
        const SUPABASE_URL = 'https://ecmhhonjazfbletyvncw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjbWhob25qYXpmYmxldHl2bmN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDMwMjYsImV4cCI6MjA4MTUxOTAyNn0.3LZ8dAOX_ZpoUNkgY_jSeC10SaCknfPfBaZsDRjFt7c';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Auth Context
        const AuthContext = createContext(null);
        const useAuth = () => useContext(AuthContext);

        const URLS = {
            clients: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRimOKUGksj-OVBSCpb9UGnkQU3Wu547GpcaUk4RT0oo5KM0fnVo2sk8mRpy4cwO5j9CckDORzmou-d/pub?gid=133498635&single=true&output=csv',
            setupTiming: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4LTw-15NE0j25eIOpY_bTPSAipW7-F2eXnL0xtdXMWCZtK9z3MYWxHr6ltnMChLk-YDLzwiXAfvwE/pub?gid=646836237&single=true&output=csv'
        };

        const pn = v => parseFloat(String(v||'0').replace(/[$,%]/g,'').replace(/,/g,''))||0;
        const fmt = v => '$'+(pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});
        const fmtD = v => '$'+(pn(v)).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        const fmtN = v => (pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});
        const fmtP = v => (pn(v)).toFixed(1)+'%';
        const clean = v => (v && v.toString().trim()) ? v.toString().trim() : '‚Äî';
        const getDisplayName = (email) => email ? email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : 'Unknown';

        const mapClient = r => ({
            client: r['Client']||'', adAccount: r['Ad Account Name']||'', state: r['State']||'', 
            campaign: r['CAMPAIGN']||'', callingStatus: r['Calling/Non-calling']||'', startDate: r['Start Date']||'',
            days: pn(r['Days Running']), weeks: pn(r['Weeks Running']), months: pn(r['Months Running']),
            spend: pn(r['Total Ad Spend']), sellerSpend: pn(r['Seller Ad Spend']), buyerSpend: pn(r['Buyer Ad Spend']),
            dailyBudget: pn(r['Daily Ad Spend Budget']), spendPerDay: pn(r['Ad Spend Per Day']),
            leads: pn(r['Total Leads']), cpl: pn(r['Cost Per Lead']),
            sellerLeads: pn(r['Seller Leads']), sellerCPL: pn(r['Cost Per Seller Lead']), sellerLeadsWeek: pn(r['Seller Leads/Week']),
            buyerLeads: pn(r['Buyer Leads']), listingLeads: pn(r['Listing Leads']),
            appts: pn(r['Total Appts']), apptsWeek: pn(r['Appt per Week']), appts7: pn(r['Appts in the Last 7 Days']),
            sellerAppts: pn(r['Seller Appts']), sellerLeadToAppt: pn(r['Seller Lead > Appt']), sellerApptCost: pn(r['Cost per Seller Appts']),
            buyerAppts: pn(r['Buyer Appts']), buyerApptCost: pn(r['Cost per Buyer Appt']),
            deals: pn(r['Potential Deals']), listings: pn(r['Listing']), buyerSigned: pn(r['Buyer Signed']), leadsPerListing: pn(r['Leads/Listing'])
        });

        const mapSetupTiming = r => ({
            client: r['VAM'] || '', csmRep: r['CSM'] || '', lastForm: r['Last Form'] || '', lastFormDate: r['Date'] || '',
            status: r['Status'] || '', concern: r['Concern'] || '', referral: r['Referral'] || '', testimonial: r['Testmonial'] || '',
            lender: r['Status_1'] || '', state: r['State'] || '', campaign: r['Campaign'] || '', contractCategory: r['Contract Category'] || '',
            spanish: r['Spanish'] || '', mrr: r['MRR'] || '', fulfilled: r['Fullfilled'] || '', info: r['Info'] || '',
            daysLeft: r['Days left'] || '', duePayment: r['Due Payment'] || '', lastCsmNote: r['Last CSM Rep - Note - date'] || '',
            upcomingCsmDate: r['upcoming CSM rep - date'] || '', paidDate: r['Paid date'] || '', onboardedDate: r['Onboarded date'] || '',
            launchCallDate: r['Launch call date'] || '', adLiveDate: r[' Ad Live date'] || r['Ad Live date'] || '',
            billingCycle: r['Billing cycle'] || '', freeTrialDays: r['Free trial Days'] || '', adsOnPauseDays: r['ADs on pause total days'] || '',
            closings: r['Closings'] || '', signed: r['Signed'] || '', appts: r[' Appts '] || r['Appts'] || '',
            behindSchedule: r['Behind schedule'] || '', missing: r['Missing'] || '', shuPercent: r['SHU%'] || '',
            calling: r['Calling'] || '', dialer: r['Dialer'] || '', sLeads: r['S Leads'] || '', bLeads: r['B Leads'] || '',
            cpl: r['CPL'] || '', cpa: r['CPA'] || '', sAppts: r['(S)appts'] || '', bAppts: r['(B)appts'] || '',
            shu: r['SHU'] || '', ns: r['NS'] || '', stageOnCrm: r['Stage on CRM'] || '', timezone: r['Timezone'] || '',
            onboardingRep: r['Rep'] || '', redFlags: r['Red flags'] || '', crmFees: r['CRM Fees'] || '',
            adSpendFees: r['ad spend fees'] || '', responsiveness: r['Responsivness'] || '', leadGenExp: r['Lead gen exp'] || '',
            callingExpectations: r['Calling expectaions'] || '', fathom1: r['Fathom'] || '', adsOnPauseDaysDetail: r['ads on pause days'] || '',
            adAccountName: r['Ad Account name'] || '', adSpend: r['Ad Spend'] || '', radius: r['radius'] || '',
            city: r['City'] || '', target: r['Target'] || '', launch: r['Launch'] || '', adsRep: r['Rep'] || '',
            readiness: r['Readiness'] || '', personality: r['Personality'] || '', expectations: r['Expectations'] || '',
            unresolvedConcerns: r['Unresolved Concerns'] || '', firstCheckin: r['1st Check-in'] || '', firstCsm: r['1st CSM'] || '',
            revenueContracted: r['Revenue Contracted'] || '', contractLength: r['Contract length'] || '',
            moPaymentsCollected: r['mo payments collected'] || '', billingAdjust: r['Billing adjust'] || '',
            platform: r['Platform'] || '', nameEmail: r['Name/email'] || '', contractNotes: r['contract notes'] || '',
            paymentNotes: r['Payment notes'] || '', amountCollected: r['Amount collected'] || '', b2b: r['B2B'] || '',
            closedOn: r['Closed on'] || '', commission: r['commision'] || '', setterCloser: r['Setter & Closer'] || '',
        });

        const getHealth = cpl => { if(!cpl) return 'Gray'; if(cpl<=25) return 'Green'; if(cpl<=50) return 'Yellow'; return 'Red'; };
        const healthColors = { Green:'bg-emerald-500', Yellow:'bg-amber-500', Red:'bg-red-500', Gray:'bg-gray-500' };
        const healthText = { Green:'text-emerald-400', Yellow:'text-amber-400', Red:'text-red-400', Gray:'text-gray-400' };
        const Badge = ({health}) => <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${healthColors[health]}/20 ${healthText[health]} border border-current/30`}>{health}</span>;

        // ========== LOGIN PAGE ==========
        const LoginPage = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    let result;
                    if (isSignUp) {
                        result = await supabase.auth.signUp({ email, password });
                        if (result.error) throw result.error;
                        setError('Check your email for confirmation link!');
                        setLoading(false);
                        return;
                    } else {
                        result = await supabase.auth.signInWithPassword({ email, password });
                        if (result.error) throw result.error;
                        onLogin(result.data.user);
                    }
                } catch (err) {
                    setError(err.message);
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="card rounded-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold gradient-text mb-2">VAM Client Hub</h1>
                            <p className="text-gray-500">Sign in to access the dashboard</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">Email</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-cyan" placeholder="you@company.com" required />
                            </div>
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">Password</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-cyan" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                            </div>
                            {error && <div className={`p-3 rounded-lg text-sm ${error.includes('Check your email') ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}`}>{error}</div>}
                            <button type="submit" disabled={loading} className="w-full py-3 bg-gradient-to-r from-accent-cyan to-accent-purple text-black font-semibold rounded-lg hover:opacity-90 disabled:opacity-50">
                                {loading ? 'Please wait...' : (isSignUp ? 'Create Account' : 'Sign In')}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button onClick={() => setIsSignUp(!isSignUp)} className="text-gray-500 hover:text-white text-sm">
                                {isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== COMPONENTS ==========
        const tabs = [
            { id: 'info', name: 'Client Information', icon: 'üë§' },
            { id: 'performance', name: 'Performance', icon: 'üìà' },
            { id: 'meetings', name: 'Meeting Notes', icon: 'üéôÔ∏è' },
            { id: 'strategy', name: 'Strategy & Notes', icon: 'üìù' },
            { id: 'activity', name: 'Activity Log', icon: 'üìã' },
        ];

        const DataRow = ({label, value, highlight, color}) => {
            const displayVal = clean(value);
            const isEmpty = displayVal === '‚Äî';
            return (
                <div className={`flex justify-between items-center p-2 rounded ${isEmpty ? '' : 'hover:bg-dark-600/50'}`}>
                    <span className="text-gray-400 text-sm">{label}</span>
                    <span className={`font-medium text-sm ${isEmpty ? 'text-gray-600' : highlight ? (color || 'text-accent-cyan') : 'text-white'}`}>{displayVal}</span>
                </div>
            );
        };

        const Section = ({title, icon, children}) => (
            <div className="card rounded-xl p-5">
                <div className="section-title flex items-center gap-2">{icon} {title}</div>
                <div className="grid gap-1">{children}</div>
            </div>
        );

        // ========== CLIENT INFO TAB ==========
        const ClientInfoTab = ({c, s}) => {
            if(!c) return <div className="card rounded-xl p-12 text-center text-gray-500">Select a client to view details</div>;
            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="card rounded-xl p-5 text-center border-l-4 border-accent-cyan"><div className="text-2xl font-bold text-white">{fmt(c.spend)}</div><div className="text-sm text-gray-400">Total Spend</div></div>
                        <div className="card rounded-xl p-5 text-center border-l-4 border-accent-cyan"><div className="text-2xl font-bold text-accent-cyan">{fmtN(c.leads)}</div><div className="text-sm text-gray-400">Total Leads</div></div>
                        <div className="card rounded-xl p-5 text-center border-l-4 border-accent-purple"><div className="text-2xl font-bold text-white">{fmtD(c.cpl)}</div><div className="text-sm text-gray-400">Cost Per Lead</div></div>
                        <div className="card rounded-xl p-5 text-center border-l-4 border-accent-purple"><div className="text-2xl font-bold text-accent-purple">{fmtN(c.appts)}</div><div className="text-sm text-gray-400">Appointments</div></div>
                    </div>
                    {(s?.duePayment?.includes?.('OVERDUE') || s?.redFlags || s?.unresolvedConcerns) && (
                        <div className="space-y-3">
                            {s?.duePayment?.includes?.('OVERDUE') && <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4"><span className="text-red-400 font-semibold">üí≥ PAYMENT OVERDUE</span></div>}
                            {s?.redFlags && <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4"><span className="text-red-400 font-semibold">üö© Red Flags:</span> <span className="text-gray-300">{s.redFlags}</span></div>}
                            {s?.unresolvedConcerns && <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4"><span className="text-amber-400 font-semibold">‚ö†Ô∏è Concerns:</span> <span className="text-gray-300">{s.unresolvedConcerns}</span></div>}
                        </div>
                    )}
                    <div className="grid lg:grid-cols-2 gap-6">
                        <Section title="CSM & Status" icon="üë§">
                            <DataRow label="CSM Rep" value={s?.csmRep} highlight color="text-accent-purple"/>
                            <DataRow label="Status" value={s?.status}/><DataRow label="Concern" value={s?.concern}/>
                            <DataRow label="Referral" value={s?.referral}/><DataRow label="Lender" value={s?.lender}/>
                            <DataRow label="Last CSM Note" value={s?.lastCsmNote}/>
                        </Section>
                        <Section title="Client Details" icon="üìã">
                            <DataRow label="State" value={s?.state || c.state}/><DataRow label="Campaign" value={s?.campaign || c.campaign}/>
                            <DataRow label="Contract Category" value={s?.contractCategory} highlight/>
                            <DataRow label="MRR" value={s?.mrr} highlight color="text-accent-green"/>
                            <DataRow label="Fulfilled" value={s?.fulfilled} highlight color="text-accent-green"/>
                            <DataRow label="Days Left" value={s?.daysLeft} highlight color={pn(s?.daysLeft) < 0 ? 'text-red-400' : 'text-accent-cyan'}/>
                            <DataRow label="Due Payment" value={s?.duePayment} highlight color={s?.duePayment?.includes?.('OVERDUE') ? 'text-red-400' : 'text-accent-green'}/>
                        </Section>
                    </div>
                    <Section title="Key Dates" icon="üìÖ">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                            <div className="bg-dark-700 rounded-xl p-4 text-center"><div className="text-2xl mb-1">üí∞</div><div className="text-lg font-bold text-white">{clean(s?.paidDate)}</div><div className="text-xs text-gray-400">Paid</div></div>
                            <div className="bg-dark-700 rounded-xl p-4 text-center"><div className="text-2xl mb-1">üöÄ</div><div className="text-lg font-bold text-white">{clean(s?.onboardedDate)}</div><div className="text-xs text-gray-400">Onboarded</div></div>
                            <div className="bg-dark-700 rounded-xl p-4 text-center"><div className="text-2xl mb-1">üìû</div><div className="text-lg font-bold text-white">{clean(s?.launchCallDate)}</div><div className="text-xs text-gray-400">Launch Call</div></div>
                            <div className="bg-dark-700 rounded-xl p-4 text-center"><div className="text-2xl mb-1">üì¢</div><div className="text-lg font-bold text-white">{clean(s?.adLiveDate)}</div><div className="text-xs text-gray-400">Ads Live</div></div>
                        </div>
                    </Section>
                    <div className="grid lg:grid-cols-2 gap-6">
                        <Section title="Performance" icon="üìä">
                            <DataRow label="Closings" value={s?.closings} highlight color="text-accent-green"/>
                            <DataRow label="Signed" value={s?.signed} highlight color="text-accent-green"/>
                            <DataRow label="SHU%" value={s?.shuPercent}/><DataRow label="Behind Schedule" value={s?.behindSchedule}/>
                        </Section>
                        <Section title="Calling & Leads" icon="üìû">
                            <DataRow label="Calling" value={s?.calling}/><DataRow label="Dialer" value={s?.dialer}/>
                            <DataRow label="S Leads" value={s?.sLeads} highlight color="text-accent-cyan"/>
                            <DataRow label="B Leads" value={s?.bLeads} highlight color="text-accent-cyan"/>
                        </Section>
                    </div>
                    <div className="grid lg:grid-cols-2 gap-6">
                        <Section title="Onboarding" icon="üéØ">
                            <DataRow label="Stage on CRM" value={s?.stageOnCrm}/><DataRow label="Timezone" value={s?.timezone}/>
                            <DataRow label="Red Flags" value={s?.redFlags} highlight color="text-red-400"/>
                            <DataRow label="CRM Fees" value={s?.crmFees}/><DataRow label="Ad Spend Fees" value={s?.adSpendFees}/>
                        </Section>
                        <Section title="Ads & Targeting" icon="üì¢">
                            <DataRow label="Ad Account" value={s?.adAccountName || c.adAccount}/>
                            <DataRow label="Ad Spend" value={s?.adSpend} highlight color="text-accent-cyan"/>
                            <DataRow label="City" value={s?.city}/><DataRow label="Target" value={s?.target}/>
                        </Section>
                    </div>
                    <div className="grid lg:grid-cols-2 gap-6">
                        <Section title="Client Profile" icon="üß†">
                            <DataRow label="Personality" value={s?.personality}/><DataRow label="Expectations" value={s?.expectations}/>
                            <DataRow label="Unresolved Concerns" value={s?.unresolvedConcerns} highlight color="text-amber-400"/>
                        </Section>
                        <Section title="Billing & Contract" icon="üí≥">
                            <DataRow label="Revenue Contracted" value={s?.revenueContracted} highlight color="text-accent-green"/>
                            <DataRow label="Contract Length" value={s?.contractLength}/>
                            <DataRow label="Platform" value={s?.platform}/><DataRow label="Amount Collected" value={s?.amountCollected} highlight color="text-accent-green"/>
                        </Section>
                    </div>
                </div>
            );
        };

        // ========== PERFORMANCE TAB ==========
        const PerformanceTab = ({c}) => {
            if(!c) return <div className="card rounded-xl p-12 text-center text-gray-500">Select a client to view details</div>;
            return (
                <div className="space-y-6">
                    <div className="grid md:grid-cols-4 gap-4">
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-white">{fmt(c.spend)}</div><div className="text-sm text-gray-400">Total Spend</div></div>
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-white">{fmtD(c.dailyBudget)}</div><div className="text-sm text-gray-400">Daily Budget</div></div>
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-accent-cyan">{fmtD(c.spendPerDay)}</div><div className="text-sm text-gray-400">Actual/Day</div></div>
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-accent-purple">{c.weeks}</div><div className="text-sm text-gray-400">Weeks</div></div>
                    </div>
                    <div className="grid md:grid-cols-4 gap-4">
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-accent-cyan">{fmtN(c.leads)}</div><div className="text-sm text-gray-400">Total Leads</div></div>
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-white">{fmtN(c.sellerLeads)}</div><div className="text-sm text-gray-400">Seller Leads</div></div>
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-white">{fmtN(c.buyerLeads)}</div><div className="text-sm text-gray-400">Buyer Leads</div></div>
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-accent-purple">{fmtN(c.listingLeads)}</div><div className="text-sm text-gray-400">Listing Leads</div></div>
                    </div>
                    <div className="grid md:grid-cols-4 gap-4">
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-accent-purple">{fmtN(c.appts)}</div><div className="text-sm text-gray-400">Total Appts</div></div>
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-accent-cyan">{fmtN(c.appts7)}</div><div className="text-sm text-gray-400">Last 7 Days</div></div>
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-white">{c.apptsWeek.toFixed(1)}</div><div className="text-sm text-gray-400">Appts/Week</div></div>
                        <div className="card rounded-xl p-5 text-center"><div className="text-2xl font-bold text-accent-green">{fmtP(c.sellerLeadToAppt)}</div><div className="text-sm text-gray-400">Lead‚ÜíAppt</div></div>
                    </div>
                    <div className="grid md:grid-cols-3 gap-4">
                        <div className="card rounded-xl p-6 text-center"><div className="text-3xl font-bold text-accent-green">{fmtN(c.deals)}</div><div className="text-sm text-gray-400">Potential Deals</div></div>
                        <div className="card rounded-xl p-6 text-center"><div className="text-3xl font-bold text-accent-yellow">{fmtN(c.listings)}</div><div className="text-sm text-gray-400">Listings</div></div>
                        <div className="card rounded-xl p-6 text-center"><div className="text-3xl font-bold text-accent-purple">{fmtN(c.buyerSigned)}</div><div className="text-sm text-gray-400">Buyer Signed</div></div>
                    </div>
                </div>
            );
        };

        // ========== MEETING NOTES TAB WITH AI SUMMARY ==========
        const MeetingsTab = ({c}) => {
            const { user } = useAuth();
            const [transcript, setTranscript] = useState('');
            const [meetingDate, setMeetingDate] = useState(new Date().toISOString().split('T')[0]);
            const [meetingType, setMeetingType] = useState('check-in');
            const [summary, setSummary] = useState(null);
            const [processing, setProcessing] = useState(false);
            const [meetings, setMeetings] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedMeeting, setSelectedMeeting] = useState(null);

            useEffect(() => {
                if (c?.client) loadMeetings();
            }, [c?.client]);

            const loadMeetings = async () => {
                if (!c?.client) return;
                setLoading(true);
                try {
                    const { data } = await supabase
                        .from('meeting_notes')
                        .select('*')
                        .eq('client_name', c.client)
                        .order('meeting_date', { ascending: false });
                    if (data) setMeetings(data);
                } catch (err) {
                    console.error('Load meetings error:', err);
                }
                setLoading(false);
            };

            const processTranscript = async () => {
                if (!transcript.trim()) return;
                setProcessing(true);
                setSummary(null);

                try {
                    // Call Claude API for summarization
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1500,
                            messages: [{
                                role: 'user',
                                content: `You are a meeting summarizer for a real estate marketing company (Veriad Marketing). Analyze this client meeting transcript and extract key information.

Client Name: ${c?.client || 'Unknown'}
Meeting Type: ${meetingType}
Date: ${meetingDate}

TRANSCRIPT:
${transcript}

Please provide a structured summary in the following JSON format:
{
  "summary": "2-3 sentence overview of the meeting",
  "clientSentiment": "positive/neutral/negative/concerned",
  "keyPoints": ["point 1", "point 2", "point 3"],
  "clientConcerns": ["concern 1", "concern 2"],
  "actionItems": [
    {"task": "description", "owner": "VAM/Client", "priority": "high/medium/low"}
  ],
  "clientWins": ["win 1", "win 2"],
  "followUpDate": "suggested follow-up date or null",
  "adPerformanceNotes": "any notes about ad performance mentioned",
  "leadQualityFeedback": "any feedback about lead quality",
  "upsellOpportunities": ["opportunity 1"],
  "riskLevel": "low/medium/high",
  "nextSteps": "recommended next steps"
}

Return ONLY valid JSON, no other text.`
                            }]
                        })
                    });

                    const data = await response.json();
                    const content = data.content?.[0]?.text || '';
                    
                    // Parse the JSON response
                    const parsed = JSON.parse(content);
                    setSummary(parsed);

                } catch (err) {
                    console.error('AI processing error:', err);
                    // Fallback to basic extraction if AI fails
                    setSummary({
                        summary: "Meeting transcript received. AI processing unavailable - please review manually.",
                        clientSentiment: "neutral",
                        keyPoints: ["Transcript uploaded for manual review"],
                        clientConcerns: [],
                        actionItems: [],
                        clientWins: [],
                        followUpDate: null,
                        adPerformanceNotes: "",
                        leadQualityFeedback: "",
                        upsellOpportunities: [],
                        riskLevel: "medium",
                        nextSteps: "Review transcript manually"
                    });
                }
                setProcessing(false);
            };

            const saveMeeting = async () => {
                if (!summary || !c?.client || !user) return;
                try {
                    const { data, error } = await supabase.from('meeting_notes').insert({
                        client_name: c.client,
                        meeting_date: meetingDate,
                        meeting_type: meetingType,
                        transcript: transcript,
                        summary: summary.summary,
                        client_sentiment: summary.clientSentiment,
                        key_points: summary.keyPoints,
                        client_concerns: summary.clientConcerns,
                        action_items: summary.actionItems,
                        client_wins: summary.clientWins,
                        follow_up_date: summary.followUpDate,
                        ad_performance_notes: summary.adPerformanceNotes,
                        lead_quality_feedback: summary.leadQualityFeedback,
                        risk_level: summary.riskLevel,
                        next_steps: summary.nextSteps,
                        user_id: user.id,
                        user_email: user.email
                    }).select().single();

                    if (error) throw error;
                    
                    setMeetings([data, ...meetings]);
                    setTranscript('');
                    setSummary(null);
                    
                    // Log activity
                    await supabase.from('activity_log').insert({
                        user_id: user.id,
                        user_email: user.email,
                        client_name: c.client,
                        action: 'Added meeting notes',
                        details: `${meetingType} - ${meetingDate}`
                    });

                    alert('Meeting saved successfully!');
                } catch (err) {
                    console.error('Save error:', err);
                    alert('Error saving meeting');
                }
            };

            const deleteMeeting = async (id) => {
                if (!confirm('Delete this meeting?')) return;
                try {
                    await supabase.from('meeting_notes').delete().eq('id', id);
                    setMeetings(meetings.filter(m => m.id !== id));
                    if (selectedMeeting?.id === id) setSelectedMeeting(null);
                } catch (err) {
                    console.error('Delete error:', err);
                }
            };

            if (!c) return <div className="card rounded-xl p-12 text-center text-gray-500">Select a client to view meeting notes</div>;

            const sentimentColors = {
                positive: 'bg-green-500/20 text-green-400 border-green-500/30',
                neutral: 'bg-gray-500/20 text-gray-400 border-gray-500/30',
                negative: 'bg-red-500/20 text-red-400 border-red-500/30',
                concerned: 'bg-amber-500/20 text-amber-400 border-amber-500/30'
            };

            const riskColors = {
                low: 'bg-green-500/20 text-green-400',
                medium: 'bg-amber-500/20 text-amber-400',
                high: 'bg-red-500/20 text-red-400'
            };

            return (
                <div className="space-y-6">
                    {/* New Meeting Input */}
                    <div className="card rounded-xl p-6">
                        <h3 className="text-lg font-bold text-white mb-4">üéôÔ∏è New Meeting Transcript</h3>
                        <div className="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">Meeting Date</label>
                                <input type="date" value={meetingDate} onChange={e => setMeetingDate(e.target.value)} className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 text-white" />
                            </div>
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">Meeting Type</label>
                                <select value={meetingType} onChange={e => setMeetingType(e.target.value)} className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 text-white">
                                    <option value="check-in">Check-in Call</option>
                                    <option value="onboarding">Onboarding</option>
                                    <option value="launch">Launch Call</option>
                                    <option value="review">Performance Review</option>
                                    <option value="concern">Concern/Issue Call</option>
                                    <option value="upsell">Upsell Discussion</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <textarea
                            value={transcript}
                            onChange={e => setTranscript(e.target.value)}
                            placeholder="Paste your meeting transcript here (from Fathom, Otter, Zoom, etc.)..."
                            className="w-full bg-dark-700 border border-dark-600 rounded-lg p-4 text-white min-h-[200px] focus:outline-none focus:border-accent-cyan"
                        />
                        <div className="flex gap-4 mt-4">
                            <button
                                onClick={processTranscript}
                                disabled={!transcript.trim() || processing}
                                className="px-6 py-3 bg-gradient-to-r from-accent-cyan to-accent-purple text-black font-semibold rounded-lg disabled:opacity-50 flex items-center gap-2"
                            >
                                {processing ? (
                                    <><span className="pulse">ü§ñ</span> Analyzing...</>
                                ) : (
                                    <>ü§ñ Analyze with AI</>
                                )}
                            </button>
                            {summary && (
                                <button onClick={saveMeeting} className="px-6 py-3 bg-accent-green text-black font-semibold rounded-lg">
                                    üíæ Save Meeting
                                </button>
                            )}
                        </div>
                    </div>

                    {/* AI Summary Results */}
                    {summary && (
                        <div className="card rounded-xl p-6 border border-accent-cyan/30">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-bold text-white">‚ú® AI Summary</h3>
                                <div className="flex gap-2">
                                    <span className={`px-3 py-1 rounded-full text-xs font-semibold border ${sentimentColors[summary.clientSentiment]}`}>
                                        {summary.clientSentiment?.toUpperCase()}
                                    </span>
                                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${riskColors[summary.riskLevel]}`}>
                                        {summary.riskLevel?.toUpperCase()} RISK
                                    </span>
                                </div>
                            </div>
                            
                            <p className="text-gray-300 mb-6">{summary.summary}</p>
                            
                            <div className="grid md:grid-cols-2 gap-6">
                                {summary.keyPoints?.length > 0 && (
                                    <div>
                                        <h4 className="text-sm font-semibold text-accent-cyan mb-2">üìå Key Points</h4>
                                        <ul className="space-y-1">
                                            {summary.keyPoints.map((p, i) => <li key={i} className="text-gray-300 text-sm">‚Ä¢ {p}</li>)}
                                        </ul>
                                    </div>
                                )}
                                
                                {summary.clientConcerns?.length > 0 && (
                                    <div>
                                        <h4 className="text-sm font-semibold text-amber-400 mb-2">‚ö†Ô∏è Client Concerns</h4>
                                        <ul className="space-y-1">
                                            {summary.clientConcerns.map((c, i) => <li key={i} className="text-gray-300 text-sm">‚Ä¢ {c}</li>)}
                                        </ul>
                                    </div>
                                )}
                                
                                {summary.clientWins?.length > 0 && (
                                    <div>
                                        <h4 className="text-sm font-semibold text-green-400 mb-2">üéâ Client Wins</h4>
                                        <ul className="space-y-1">
                                            {summary.clientWins.map((w, i) => <li key={i} className="text-gray-300 text-sm">‚Ä¢ {w}</li>)}
                                        </ul>
                                    </div>
                                )}
                                
                                {summary.actionItems?.length > 0 && (
                                    <div>
                                        <h4 className="text-sm font-semibold text-accent-purple mb-2">‚úÖ Action Items</h4>
                                        <ul className="space-y-2">
                                            {summary.actionItems.map((a, i) => (
                                                <li key={i} className="text-sm flex items-start gap-2">
                                                    <span className={`px-2 py-0.5 rounded text-xs ${a.priority === 'high' ? 'bg-red-500/20 text-red-400' : a.priority === 'medium' ? 'bg-amber-500/20 text-amber-400' : 'bg-gray-500/20 text-gray-400'}`}>
                                                        {a.priority}
                                                    </span>
                                                    <span className="text-gray-300">{a.task}</span>
                                                    <span className="text-gray-500">({a.owner})</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </div>

                            {(summary.adPerformanceNotes || summary.leadQualityFeedback) && (
                                <div className="grid md:grid-cols-2 gap-4 mt-6 pt-4 border-t border-dark-600">
                                    {summary.adPerformanceNotes && (
                                        <div>
                                            <h4 className="text-sm font-semibold text-gray-400 mb-1">Ad Performance Notes</h4>
                                            <p className="text-gray-300 text-sm">{summary.adPerformanceNotes}</p>
                                        </div>
                                    )}
                                    {summary.leadQualityFeedback && (
                                        <div>
                                            <h4 className="text-sm font-semibold text-gray-400 mb-1">Lead Quality Feedback</h4>
                                            <p className="text-gray-300 text-sm">{summary.leadQualityFeedback}</p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {summary.nextSteps && (
                                <div className="mt-4 pt-4 border-t border-dark-600">
                                    <h4 className="text-sm font-semibold text-accent-cyan mb-1">üéØ Next Steps</h4>
                                    <p className="text-gray-300">{summary.nextSteps}</p>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Past Meetings */}
                    <div className="card rounded-xl p-6">
                        <h3 className="text-lg font-bold text-white mb-4">üìö Meeting History</h3>
                        {loading ? (
                            <div className="text-center py-8 text-gray-500">Loading meetings...</div>
                        ) : meetings.length === 0 ? (
                            <div className="text-center py-8 text-gray-500">No meetings recorded yet</div>
                        ) : (
                            <div className="space-y-3">
                                {meetings.map(m => (
                                    <div key={m.id} className={`bg-dark-700 rounded-xl p-4 cursor-pointer transition-all ${selectedMeeting?.id === m.id ? 'ring-2 ring-accent-cyan' : 'hover:bg-dark-600'}`} onClick={() => setSelectedMeeting(selectedMeeting?.id === m.id ? null : m)}>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="text-white font-semibold">{m.meeting_type?.replace('-', ' ').replace(/\b\w/g, c => c.toUpperCase())}</span>
                                                    <span className={`px-2 py-0.5 rounded text-xs ${sentimentColors[m.client_sentiment]}`}>{m.client_sentiment}</span>
                                                    <span className={`px-2 py-0.5 rounded text-xs ${riskColors[m.risk_level]}`}>{m.risk_level} risk</span>
                                                </div>
                                                <div className="text-gray-500 text-sm">{new Date(m.meeting_date).toLocaleDateString()} ‚Ä¢ by {getDisplayName(m.user_email)}</div>
                                            </div>
                                            <button onClick={(e) => { e.stopPropagation(); deleteMeeting(m.id); }} className="text-gray-600 hover:text-red-400">‚úï</button>
                                        </div>
                                        <p className="text-gray-400 text-sm mt-2">{m.summary}</p>
                                        
                                        {selectedMeeting?.id === m.id && (
                                            <div className="mt-4 pt-4 border-t border-dark-600 space-y-4">
                                                {m.key_points?.length > 0 && (
                                                    <div>
                                                        <h5 className="text-xs font-semibold text-accent-cyan mb-1">Key Points</h5>
                                                        <ul className="text-sm text-gray-300">{m.key_points.map((p,i) => <li key={i}>‚Ä¢ {p}</li>)}</ul>
                                                    </div>
                                                )}
                                                {m.action_items?.length > 0 && (
                                                    <div>
                                                        <h5 className="text-xs font-semibold text-accent-purple mb-1">Action Items</h5>
                                                        <ul className="text-sm text-gray-300">{m.action_items.map((a,i) => <li key={i}>‚Ä¢ [{a.priority}] {a.task} ({a.owner})</li>)}</ul>
                                                    </div>
                                                )}
                                                {m.next_steps && (
                                                    <div>
                                                        <h5 className="text-xs font-semibold text-gray-400 mb-1">Next Steps</h5>
                                                        <p className="text-sm text-gray-300">{m.next_steps}</p>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ========== STRATEGY TAB ==========
        const StrategyTab = ({c}) => {
            const { user } = useAuth();
            const [notes, setNotes] = useState([]);
            const [newNote, setNewNote] = useState('');
            const [strategy, setStrategy] = useState('');
            const [actionItems, setActionItems] = useState('');
            const [loading, setLoading] = useState(false);
            const [saving, setSaving] = useState(false);
            const [saveStatus, setSaveStatus] = useState('');
            const [lastEditedBy, setLastEditedBy] = useState('');

            useEffect(() => { if (c?.client) loadData(); }, [c?.client]);

            const loadData = async () => {
                if (!c?.client) return;
                setLoading(true);
                try {
                    const { data: notesData } = await supabase.from('client_notes').select('*').eq('client_name', c.client).order('created_at', { ascending: false });
                    if (notesData) setNotes(notesData);
                    const { data: strategyData } = await supabase.from('client_strategy').select('*').eq('client_name', c.client).single();
                    if (strategyData) {
                        setStrategy(strategyData.strategy_text || '');
                        setActionItems(strategyData.action_items || '');
                        setLastEditedBy(strategyData.last_edited_by || '');
                    } else {
                        setStrategy(''); setActionItems(''); setLastEditedBy('');
                    }
                } catch (err) { console.error('Load error:', err); }
                setLoading(false);
            };

            useEffect(() => {
                if (!c?.client || loading) return;
                const timer = setTimeout(() => saveStrategy(), 1000);
                return () => clearTimeout(timer);
            }, [strategy, actionItems]);

            const saveStrategy = async () => {
                if (!c?.client || !user) return;
                setSaving(true); setSaveStatus('Saving...');
                try {
                    await supabase.from('client_strategy').upsert({
                        client_name: c.client, strategy_text: strategy, action_items: actionItems,
                        user_id: user.id, user_email: user.email, last_edited_by: user.email, updated_at: new Date().toISOString()
                    }, { onConflict: 'client_name' });
                    setLastEditedBy(user.email);
                    setSaveStatus('‚úì Saved');
                    setTimeout(() => setSaveStatus(''), 2000);
                } catch (err) { console.error('Save error:', err); setSaveStatus('Error'); }
                setSaving(false);
            };

            const addNote = async () => {
                if (!newNote.trim() || !c?.client || !user) return;
                setSaving(true);
                try {
                    const { data, error } = await supabase.from('client_notes').insert({
                        client_name: c.client, note_text: newNote, user_id: user.id, user_email: user.email, created_by: user.email
                    }).select().single();
                    if (error) throw error;
                    setNotes([data, ...notes]);
                    setNewNote('');
                    await supabase.from('activity_log').insert({ user_id: user.id, user_email: user.email, client_name: c.client, action: 'Added note', details: newNote.substring(0, 100) });
                } catch (err) { console.error('Add note error:', err); }
                setSaving(false);
            };

            const deleteNote = async (id) => {
                if (!confirm('Delete this note?')) return;
                await supabase.from('client_notes').delete().eq('id', id);
                setNotes(notes.filter(n => n.id !== id));
            };

            if (!c) return <div className="card rounded-xl p-12 text-center text-gray-500">Select a client to view details</div>;

            return (
                <div className="space-y-6">
                    <div className="card rounded-xl p-6">
                        <div className="flex justify-between items-center mb-3">
                            <h4 className="font-semibold text-white">üìù Strategy Notes</h4>
                            <div className="flex items-center gap-4">
                                {lastEditedBy && <span className="text-xs text-gray-500">Last edited by <span className="text-accent-purple">{getDisplayName(lastEditedBy)}</span></span>}
                                <span className="text-sm text-gray-500">{saveStatus}</span>
                            </div>
                        </div>
                        <textarea value={strategy} onChange={e => setStrategy(e.target.value)} className={`w-full bg-dark-700 border border-dark-600 rounded-lg p-4 text-white min-h-[120px] focus:outline-none focus:border-accent-cyan ${saving ? 'saving' : ''}`} placeholder="Document the current strategy..." disabled={loading} />
                    </div>
                    <div className="card rounded-xl p-6">
                        <h4 className="font-semibold text-white mb-3">‚úÖ Action Items</h4>
                        <textarea value={actionItems} onChange={e => setActionItems(e.target.value)} className={`w-full bg-dark-700 border border-dark-600 rounded-lg p-4 text-white min-h-[100px] focus:outline-none focus:border-accent-cyan ${saving ? 'saving' : ''}`} placeholder="List action items..." disabled={loading} />
                    </div>
                    <div className="card rounded-xl p-6">
                        <h4 className="font-semibold text-white mb-3">üí¨ Quick Notes</h4>
                        <div className="flex gap-4 mb-4">
                            <input type="text" value={newNote} onChange={e => setNewNote(e.target.value)} onKeyPress={e => e.key === 'Enter' && addNote()} className="flex-1 bg-dark-700 border border-dark-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-cyan" placeholder="Add a quick note..." disabled={loading || saving} />
                            <button onClick={addNote} disabled={loading || saving || !newNote.trim()} className="px-6 py-3 bg-accent-cyan text-black font-semibold rounded-lg disabled:opacity-50">Add</button>
                        </div>
                        {loading ? <div className="text-center py-8 text-gray-500">Loading...</div> : (
                            <div className="space-y-2 max-h-96 overflow-y-auto scrollbar">
                                {notes.length === 0 && <div className="text-gray-500 text-center py-4">No notes yet</div>}
                                {notes.map((n) => (
                                    <div key={n.id} className="bg-dark-700 rounded-lg p-3 group">
                                        <div className="flex justify-between items-start">
                                            <div className="flex items-center gap-2">
                                                <span className="text-accent-purple text-sm font-medium">{getDisplayName(n.user_email || n.created_by)}</span>
                                                <span className="text-gray-600 text-xs">{new Date(n.created_at).toLocaleString()}</span>
                                            </div>
                                            <button onClick={() => deleteNote(n.id)} className="text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100">‚úï</button>
                                        </div>
                                        <p className="text-white mt-1">{n.note_text}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ========== ACTIVITY TAB ==========
        const ActivityTab = ({c}) => {
            const [activities, setActivities] = useState([]);
            const [loading, setLoading] = useState(false);
            const [filter, setFilter] = useState('all');

            useEffect(() => { loadActivities(); }, [c?.client, filter]);

            const loadActivities = async () => {
                setLoading(true);
                try {
                    let query = supabase.from('activity_log').select('*').order('created_at', { ascending: false }).limit(100);
                    if (c?.client && filter === 'client') query = query.eq('client_name', c.client);
                    const { data } = await query;
                    if (data) setActivities(data);
                } catch (err) { console.error('Load activities error:', err); }
                setLoading(false);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-bold text-white">üìã Activity Log</h2>
                        <div className="flex gap-2">
                            <button onClick={() => setFilter('all')} className={`px-4 py-2 rounded-lg text-sm ${filter === 'all' ? 'bg-accent-cyan text-black' : 'bg-dark-700 text-gray-400'}`}>All Activity</button>
                            {c && <button onClick={() => setFilter('client')} className={`px-4 py-2 rounded-lg text-sm ${filter === 'client' ? 'bg-accent-cyan text-black' : 'bg-dark-700 text-gray-400'}`}>This Client</button>}
                        </div>
                    </div>
                    {loading ? <div className="text-center py-12 text-gray-500">Loading...</div> : (
                        <div className="card rounded-xl overflow-hidden">
                            <div className="max-h-[600px] overflow-y-auto scrollbar">
                                {activities.length === 0 ? <div className="text-center py-12 text-gray-500">No activity yet</div> : (
                                    <table className="w-full">
                                        <thead className="bg-dark-700 sticky top-0">
                                            <tr>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase">Time</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase">User</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase">Client</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase">Action</th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase">Details</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-dark-600">
                                            {activities.map((a) => (
                                                <tr key={a.id} className="hover:bg-dark-700/50">
                                                    <td className="px-4 py-3 text-sm text-gray-400">{new Date(a.created_at).toLocaleString()}</td>
                                                    <td className="px-4 py-3"><span className="text-accent-purple font-medium">{getDisplayName(a.user_email)}</span></td>
                                                    <td className="px-4 py-3 text-white">{a.client_name}</td>
                                                    <td className="px-4 py-3"><span className={`px-2 py-1 rounded text-xs ${a.action.includes('Added') ? 'bg-green-500/20 text-green-400' : a.action.includes('Deleted') ? 'bg-red-500/20 text-red-400' : 'bg-accent-cyan/20 text-accent-cyan'}`}>{a.action}</span></td>
                                                    <td className="px-4 py-3 text-gray-400 text-sm max-w-xs truncate">{a.details}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ========== MAIN APP ==========
        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [clients, setClients] = useState([]);
            const [setupData, setSetupData] = useState([]);
            const [selected, setSelected] = useState(null);
            const [tab, setTab] = useState('info');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user || null);
                    setAuthLoading(false);
                });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setUser(session?.user || null);
                });
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const params = new URLSearchParams(window.location.search);
                const clientParam = params.get('client');
                Promise.all([
                    fetch(URLS.clients).then(r=>r.text()).then(csv=>{
                        const lines = csv.split('\n');
                        return Papa.parse(lines.slice(2).join('\n'), {header:true, skipEmptyLines:true}).data.map(mapClient).filter(r=>r.client);
                    }).catch(()=>[]),
                    fetch(URLS.setupTiming).then(r=>r.text()).then(csv=>{
                        const lines = csv.split('\n');
                        return Papa.parse([lines[0], ...lines.slice(2)].join('\n'), {header:true, skipEmptyLines:true}).data.map(mapSetupTiming).filter(r=>r.client && !r.client.includes('Active Clients'));
                    }).catch(()=>[])
                ]).then(([c, s]) => { 
                    setClients(c); setSetupData(s);
                    if(clientParam) {
                        const found = c.find(client => client.client.toLowerCase() === decodeURIComponent(clientParam).toLowerCase());
                        if(found) setSelected(found);
                    }
                    setLoading(false); 
                });
            }, [user]);

            const handleLogout = async () => { await supabase.auth.signOut(); setUser(null); };

            const getSetupInfo = (client) => {
                if(!client) return null;
                const name = client.client.toLowerCase().trim();
                return setupData.find(s => {
                    const sn = (s.client || '').toLowerCase().trim();
                    return sn === name || sn.includes(name) || name.includes(sn) || name.split(' ').filter(p => p.length > 2).some(p => sn.includes(p));
                });
            };

            if (authLoading) return <div className="min-h-screen flex items-center justify-center text-4xl">‚è≥</div>;
            if (!user) return <LoginPage onLogin={setUser} />;
            if (loading) return <div className="min-h-screen flex items-center justify-center text-4xl">‚è≥</div>;

            const s = getSetupInfo(selected);
            const renderTab = () => {
                switch(tab) {
                    case 'info': return <ClientInfoTab c={selected} s={s}/>;
                    case 'performance': return <PerformanceTab c={selected}/>;
                    case 'meetings': return <MeetingsTab c={selected}/>;
                    case 'strategy': return <StrategyTab c={selected}/>;
                    case 'activity': return <ActivityTab c={selected}/>;
                    default: return <ClientInfoTab c={selected} s={s}/>;
                }
            };

            return (
                <AuthContext.Provider value={{ user }}>
                    <div className="flex min-h-screen">
                        <aside className="w-64 bg-dark-800 border-r border-dark-600 flex flex-col">
                            <div className="p-5 border-b border-dark-600">
                                <h1 className="text-xl font-bold gradient-text">VAM Client Hub</h1>
                                <div className="flex items-center gap-2 mt-2">
                                    <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                    <span className="text-xs text-gray-400">{getDisplayName(user.email)}</span>
                                </div>
                            </div>
                            <div className="p-4">
                                <select value={selected?.client||''} onChange={e=>setSelected(clients.find(c=>c.client===e.target.value))} className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-3 text-white cursor-pointer focus:outline-none focus:border-accent-cyan">
                                    <option value="">Select a client...</option>
                                    {clients.map(c=><option key={c.client} value={c.client}>{c.client}</option>)}
                                </select>
                            </div>
                            <nav className="flex-1 py-2">
                                {tabs.map(t=>(<button key={t.id} onClick={()=>setTab(t.id)} className={`w-full flex items-center gap-3 px-5 py-3 text-left ${tab===t.id?'tab-active text-white':'text-gray-400 hover:text-white hover:bg-dark-700'}`}><span>{t.icon}</span><span className="text-sm font-medium">{t.name}</span></button>))}
                            </nav>
                            <div className="p-4 border-t border-dark-600 space-y-2">
                                <a href="dashboard.html" className="block w-full text-center py-2 bg-dark-700 hover:bg-dark-600 text-gray-300 rounded-lg text-sm">‚Üí Media Buyer Overview</a>
                                <button onClick={handleLogout} className="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg text-sm">Logout</button>
                            </div>
                        </aside>
                        <main className="flex-1 flex flex-col">
                            <header className="bg-dark-800/80 backdrop-blur border-b border-dark-600 px-8 py-4">
                                {selected ? (
                                    <div className="flex items-center gap-3 flex-wrap">
                                        <h2 className="text-xl font-bold text-white">{selected.client}</h2>
                                        <Badge health={getHealth(selected.cpl)}/>
                                        <span className="text-gray-400">Day {selected.days}</span>
                                        {s?.csmRep && <span className="text-accent-purple text-sm">CSM: {s.csmRep}</span>}
                                        {s?.mrr && <span className="text-accent-green text-sm">MRR: {s.mrr}</span>}
                                    </div>
                                ) : <h2 className="text-xl text-gray-500">Select a client</h2>}
                            </header>
                            <div className="flex-1 overflow-y-auto p-8 scrollbar">{renderTab()}</div>
                        </main>
                    </div>
                </AuthContext.Provider>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
</body>
</html>
