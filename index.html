<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAM Client Success Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 950: '#000000', 900: '#0a0a0a', 800: '#171717', 700: '#262626', 600: '#404040' },
                        light: { 50: '#fafafa', 100: '#f5f5f5', 200: '#e5e5e5', 300: '#d4d4d4', 400: '#a3a3a3' },
                        brand: { cyan: '#06b6d4', purple: '#8b5cf6', blue: '#3b82f6' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Dark Mode (default) */
        body.dark { background: #000000; color: #f5f5f5; }
        body.dark .card { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; }
        body.dark .sidebar { background: #0a0a0a; border-color: #262626; }
        body.dark .header-bar { background: rgba(10,10,10,0.9); border-color: #262626; }
        body.dark .input-field { background: #171717; border-color: #262626; color: #f5f5f5; }
        body.dark .text-primary { color: #f5f5f5; }
        body.dark .text-secondary { color: #a3a3a3; }
        body.dark .text-muted { color: #525252; }
        body.dark .hover-bg:hover { background: #171717; }
        body.dark .divider { border-color: #262626; }
        
        /* Light Mode */
        body.light { background: #ffffff; color: #171717; }
        body.light .card { background: #fafafa; border: 1px solid #e5e5e5; border-radius: 12px; }
        body.light .sidebar { background: #fafafa; border-color: #e5e5e5; }
        body.light .header-bar { background: rgba(250,250,250,0.9); border-color: #e5e5e5; }
        body.light .input-field { background: #ffffff; border-color: #d4d4d4; color: #171717; }
        body.light .text-primary { color: #171717; }
        body.light .text-secondary { color: #525252; }
        body.light .text-muted { color: #a3a3a3; }
        body.light .hover-bg:hover { background: #f5f5f5; }
        body.light .divider { border-color: #e5e5e5; }
        body.light .tab-active { background: linear-gradient(135deg, rgba(6,182,212,0.1), rgba(139,92,246,0.1)); }
        
        .tab-active { background: linear-gradient(135deg, rgba(6,182,212,0.15), rgba(139,92,246,0.15)); border-left: 3px solid #06b6d4; }
        .scrollbar::-webkit-scrollbar { width: 4px; }
        .scrollbar::-webkit-scrollbar-thumb { background: #404040; border-radius: 2px; }
        .section-title { font-size: 0.75rem; font-weight: 600; color: #8b5cf6; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; }
        @keyframes loading-bar { 0% { width: 0%; } 20% { width: 25%; } 50% { width: 60%; } 80% { width: 85%; } 100% { width: 95%; } }
        .loading-bar { animation: loading-bar 3s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen dark">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;

        const SUPABASE_URL = 'https://ecmhhonjazfbletyvncw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjbWhob25qYXpmYmxldHl2bmN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDMwMjYsImV4cCI6MjA4MTUxOTAyNn0.3LZ8dAOX_ZpoUNkgY_jSeC10SaCknfPfBaZsDRjFt7c';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const AuthContext = createContext(null);
        const ThemeContext = createContext(null);
        const useAuth = () => useContext(AuthContext);

        const URLS = {
            clientAdsPerformance: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4LTw-15NE0j25eIOpY_bTPSAipW7-F2eXnL0xtdXMWCZtK9z3MYWxHr6ltnMChLk-YDLzwiXAfvwE/pub?gid=964722332&single=true&output=csv',
            setupTiming: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4LTw-15NE0j25eIOpY_bTPSAipW7-F2eXnL0xtdXMWCZtK9z3MYWxHr6ltnMChLk-YDLzwiXAfvwE/pub?gid=646836237&single=true&output=csv'
        };

        const pn = v => parseFloat(String(v||'0').replace(/[$,%]/g,'').replace(/,/g,''))||0;
        const fmt = v => '$'+(pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});
        const fmtD = v => '$'+(pn(v)).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        const fmtN = v => (pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});
        const fmtP = v => (pn(v)).toFixed(1)+'%';
        const clean = v => (v && v.toString().trim()) ? v.toString().trim() : '‚Äî';
        const getDisplayName = (email, user) => {
            // First try to get full_name from user metadata
            if (user?.user_metadata?.full_name) return user.user_metadata.full_name;
            if (user?.user_metadata?.name) return user.user_metadata.name;
            // Fall back to email parsing
            return email ? email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : 'Unknown';
        };

        // Safe parsing helpers for meeting data from Supabase
        const toArr = (v) => {
            if (v == null) return [];
            if (Array.isArray(v)) return v;
            if (typeof v === 'string') {
                try { const p = JSON.parse(v); return Array.isArray(p) ? p : []; } catch { return []; }
            }
            return [];
        };
        const safeStr = (v) => {
            if (v == null) return '';
            if (typeof v === 'string') return v;
            if (typeof v === 'number' || typeof v === 'boolean') return String(v);
            try { return JSON.stringify(v); } catch { return String(v); }
        };
        const getExtra = (m) => {
            if (!m.ad_performance_notes) return {};
            try {
                return typeof m.ad_performance_notes === 'string'
                    ? JSON.parse(m.ad_performance_notes)
                    : m.ad_performance_notes;
            } catch { return {}; }
        };
        const pickArr = (...sources) => {
            for (const s of sources) { const a = toArr(s); if (a.length > 0) return a; }
            return [];
        };

        // API Key Management - stored in browser localStorage for security
        const API_KEY_STORAGE_KEY = 'anthropic_api_key';
        const getAnthropicApiKey = () => localStorage.getItem(API_KEY_STORAGE_KEY);
        const setAnthropicApiKey = (key) => localStorage.setItem(API_KEY_STORAGE_KEY, key);
        const promptForApiKey = () => {
            const key = window.prompt('Enter your Anthropic API key:\n(Get one from https://console.anthropic.com/settings/keys)');
            if (key && key.trim().startsWith('sk-ant-')) {
                setAnthropicApiKey(key.trim());
                return key.trim();
            }
            return null;
        };

        // Map Client Ads Performance sheet - headers in row 2 (A2:BA2)
        const mapClient = r => {
            const sellerLeads = pn(r['Lifetime Seller Leads']);
            const buyerLeads = pn(r['Lifetime Buyer Leads']);
            const listingLeads = pn(r['Listing Leads']);
            const totalLeads = sellerLeads + buyerLeads + listingLeads;
            const spend = pn(r['Total Ad Spend']);
            const sellerAppts7 = pn(r['Seller Appts in the Last 7 Days']);
            const buyerAppts7 = pn(r['Buyer Appts in the Last 7 Days']);
            
            return {
                client: r['Client']||'', 
                adAccount: r['Ad Account Name']||'',
                dailySetAdSpend: pn(r['Daily Set Ad Spend']),
                state: r['State']||'', 
                campaign: r['CAMPAIGN']||'',
                callingStatus: r['Calling/Non-calling']||'',
                startDate: r['CORRECT SETUP TIMING START DATE']||r['OLD Start Date']||'',
                leadySync: r['Leady Sync']||'',
                months: pn(r['Months Running']),
                weeks: pn(r['Weeks Running']),
                days: pn(r['Days Running']),
                spend: spend, 
                spendPerMonth: pn(r['Ad Spend Per Month']),
                spendPerDay: pn(r['Ad Spend Per Day']),
                // Last 3 Days - Seller
                last3DaySellerLeads: pn(r['Last 3 Day Seller Leads']),
                last3DaySellerSpend: pn(r['Last 3 Days Seller Ad Spend']),
                last3DaySellerCPL: pn(r['Last 3 Days Seller CPL']),
                // Last 7 Days - Seller
                last7DaySellerLeads: pn(r['Last 7 Day Seller Leads']),
                last7DaySellerSpend: pn(r['Last 7 Day Seller Spend']),
                last7DaySellerCPL: pn(r['Last 7 Days Seller CPL']),
                // Lifetime - Seller
                sellerLeads: sellerLeads,
                sellerSpend: pn(r['Lifetime Seller Ad Spend']),
                sellerCPL: pn(r['Lifetime Seller CPL']),
                // Last 3 Days - Buyer
                last3DayBuyerLeads: pn(r['Last 3 Day Buyer Leads']),
                last3DayBuyerSpend: pn(r['Last 3 Days Buyer Ad Spend']),
                last3DayBuyerCPL: pn(r['Last 3 Days Buyer CPL']),
                // Last 7 Days - Buyer
                last7DayBuyerLeads: pn(r['Last 7 Day Buyer Leads']),
                last7DayBuyerSpend: pn(r['Last 7 Day Buyer Spend']),
                last7DayBuyerCPL: pn(r['Last 7 Days Buyer CPL']),
                // Lifetime - Buyer
                buyerLeads: buyerLeads,
                buyerSpend: pn(r['Lifetime Buyer Ad Spend']),
                buyerCPL: pn(r['Lifetime Buyer CPL']),
                // Other lead types
                listingLeads: listingLeads,
                mortgageLeads: pn(r['Mortgage Leads']),
                agentAttraction: pn(r['Agent Attraction']),
                // Appointments
                appts: pn(r['Total Appts (Seller + Buyers)']),
                sellerAppts: pn(r['Total Seller Appts']),
                sellerAppts7: sellerAppts7,
                avgSellerApptsWeek: pn(r['Avg Seller Appts per Week']),
                sellerLeadToAppt: pn(r['Seller Lead To Appt Ratio']),
                costPerSellerAppt: pn(r['Total Ad Spend Cost Per Seller Appts']),
                buyerAppts: pn(r['Total Buyer Appts']),
                buyerAppts7: buyerAppts7,
                avgBuyerApptsWeek: pn(r['Avg Buyer Appts per Week']),
                buyerLeadToAppt: pn(r['Buyer Lead To Appt Ratio']),
                costPerBuyerAppt: pn(r['Ad Spend Cost Per Buyer Appts']),
                // Deals
                deals: pn(r['Potential Deals']),
                listings: pn(r['Listing']),
                buyerSigned: pn(r['Buyer Signed']),
                leadsPerListing: pn(r['Leads/Listing']),
                leadsPerDeal: pn(r['Leads/Potential Deal']),
                leadsPerSignedBuyer: pn(r['Leads/Signed Buyer']),
                // Computed totals
                leads: totalLeads,
                cpl: totalLeads > 0 ? spend / totalLeads : 0,
                appts7: sellerAppts7 + buyerAppts7,
                last3DayLeads: pn(r['Last 3 Day Seller Leads']) + pn(r['Last 3 Day Buyer Leads']),
                last7DayLeads: pn(r['Last 7 Day Seller Leads']) + pn(r['Last 7 Day Buyer Leads'])
            };
        };

        // Full setup timing mapping
        const mapSetupTiming = r => ({
            client: r['VAM'] || '', csmRep: r['CSM'] || '', lastForm: r['Last Form'] || '', lastFormDate: r['Date'] || '',
            status: r['Status'] || '', concern: r['Concern'] || '', referral: r['Referral'] || '', testimonial: r['Testmonial'] || '',
            lender: r['Status_1'] || '', state: r['State'] || '', campaign: r['Campaign'] || '', contractCategory: r['Contract Category'] || '',
            spanish: r['Spanish'] || '', mrr: r['MRR'] || '', fulfilled: r['Fullfilled'] || '', info: r['Info'] || '',
            daysLeft: r['Days left'] || '', duePayment: r['Due Payment'] || '', lastCsmNote: r['Last CSM Rep - Note - date'] || '',
            upcomingCsmDate: r['upcoming CSM rep - date'] || '', paidDate: r['Paid date'] || '', onboardedDate: r['Onboarded date'] || '',
            launchCallDate: r['Launch call date'] || '', adLiveDate: r[' Ad Live date'] || r['Ad Live date'] || '',
            billingCycle: r['Billing cycle'] || '', freeTrialDays: r['Free trial Days'] || '', adsOnPauseDays: r['ADs on pause total days'] || '',
            closings: r['Closings'] || '', signed: r['Signed'] || '', appts: r[' Appts '] || r['Appts'] || '',
            behindSchedule: r['Behind schedule'] || '', missing: r['Missing'] || '', shuPercent: r['SHU%'] || '',
            calling: r['Calling'] || '', dialer: r['Dialer'] || '', sLeads: r['S Leads'] || '', bLeads: r['B Leads'] || '',
            cpl: r['CPL'] || '', cpa: r['CPA'] || '', sAppts: r['(S)appts'] || '', bAppts: r['(B)appts'] || '',
            shu: r['SHU'] || '', ns: r['NS'] || '', stageOnCrm: r['Stage on CRM'] || '', timezone: r['Timezone'] || '',
            onboardingRep: r['Rep'] || '', redFlags: r['Red flags'] || '', crmFees: r['CRM Fees'] || '',
            adSpendFees: r['ad spend fees'] || '', responsiveness: r['Responsivness'] || '', leadGenExp: r['Lead gen exp'] || '',
            callingExpectations: r['Calling expectaions'] || '', fathom1: r['Fathom'] || '', adsOnPauseDaysDetail: r['ads on pause days'] || '',
            adAccountName: r['Ad Account name'] || '', adSpend: r['Ad Spend'] || '', radius: r['radius'] || '',
            city: r['City'] || '', target: r['Target'] || '', launch: r['Launch'] || '', adsRep: r['Rep'] || '',
            readiness: r['Readiness'] || '', personality: r['Personality'] || '', expectations: r['Expectations'] || '',
            unresolvedConcerns: r['Unresolved Concerns'] || '', firstCheckin: r['1st Check-in'] || '', firstCsm: r['1st CSM'] || '',
            revenueContracted: r['Revenue Contracted'] || '', contractLength: r['Contract length'] || '',
            moPaymentsCollected: r['mo payments collected'] || '', billingAdjust: r['Billing adjust'] || '',
            platform: r['Platform'] || '', nameEmail: r['Name/email'] || '', contractNotes: r['contract notes'] || '',
            paymentNotes: r['Payment notes'] || '', amountCollected: r['Amount collected'] || '', b2b: r['B2B'] || '',
            closedOn: r['Closed on'] || '', commission: r['commision'] || '', setterCloser: r['Setter & Closer'] || '',
            contractEndDate: r['Contract End Date'] || '', daysLeftForEndOfContract: r['Days left for end of Contract'] || '',
        });

        const getHealth = cpl => { if(!cpl) return 'gray'; if(cpl<=25) return 'green'; if(cpl<=50) return 'yellow'; return 'red'; };
        const healthColors = { green: 'bg-emerald-500', yellow: 'bg-amber-500', red: 'bg-red-500', gray: 'bg-slate-500' };

        const getHealthScore = (c, s) => {
            if (!c) return 0;
            let score = 50;
            if (c.cpl <= 15) score += 25; else if (c.cpl <= 25) score += 20; else if (c.cpl <= 35) score += 10; else if (c.cpl <= 50) score += 5;
            if (c.appts7 >= 5) score += 15; else if (c.appts7 >= 3) score += 10; else if (c.appts7 >= 1) score += 5;
            if (c.deals > 0 || c.listings > 0) score += 10;
            if (s?.duePayment?.includes('OVERDUE')) score -= 15;
            if (s?.redFlags) score -= 10;
            return Math.max(0, Math.min(100, score));
        };

        const getHealthColor = (score) => {
            if (score >= 80) return { text: 'text-emerald-400', bg: 'bg-emerald-500', label: 'Healthy' };
            if (score >= 60) return { text: 'text-amber-400', bg: 'bg-amber-500', label: 'Needs Attention' };
            return { text: 'text-red-400', bg: 'bg-red-500', label: 'At Risk' };
        };

        // UPDATED TABS
        const tabs = [
            { id: 'overview', name: 'Overview', icon: 'üìä', desc: 'General overview of all clients' },
            { id: 'redflags', name: 'Red Flags', icon: 'üö©', desc: 'Clients needing attention' },
            { id: 'health', name: 'Client Health', icon: '‚ù§Ô∏è', desc: 'Overview of client status and metrics' },
            { id: 'notes', name: 'Notes & Activity', icon: 'üìù', desc: 'Notes, meetings, and activity log' },
            { id: 'timeline', name: 'Renewals Timeline', icon: 'üìÖ', desc: 'Upcoming client contract renewals' },
        ];

        // ========== LOGIN ==========
        const LoginPage = ({ onLogin }) => {
            const [isSignUp, setIsSignUp] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [fullName, setFullName] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setSuccess('');
                
                try {
                    if (isSignUp) {
                        // Sign up new user
                        const result = await supabase.auth.signUp({ 
                            email, 
                            password,
                            options: {
                                data: {
                                    full_name: fullName,
                                    name: fullName
                                }
                            }
                        });
                        if (result.error) throw result.error;
                        
                        // Check if email confirmation is required
                        if (result.data?.user?.identities?.length === 0) {
                            setError('This email is already registered. Please sign in instead.');
                        } else {
                            setSuccess('Account created! Please check your email to confirm, then sign in.');
                            setIsSignUp(false);
                        }
                    } else {
                        // Sign in existing user
                        const result = await supabase.auth.signInWithPassword({ email, password });
                        if (result.error) throw result.error;
                        onLogin(result.data.user);
                    }
                } catch (err) { 
                    setError(err.message); 
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="card p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold bg-gradient-to-r from-brand-cyan to-brand-purple bg-clip-text text-transparent">VAM Client Success Hub</h1>
                            <p className="text-slate-500 mt-2">{isSignUp ? 'Create your account' : 'Sign in to continue'}</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {isSignUp && (
                                <input 
                                    type="text" 
                                    value={fullName} 
                                    onChange={e => setFullName(e.target.value)} 
                                    className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white" 
                                    placeholder="Full Name" 
                                    required 
                                />
                            )}
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white" placeholder="Email" required />
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white" placeholder="Password" required minLength={6} />
                            {error && <div className="p-3 rounded-xl bg-red-500/10 text-red-400 text-sm">{error}</div>}
                            {success && <div className="p-3 rounded-xl bg-emerald-500/10 text-emerald-400 text-sm">{success}</div>}
                            <button type="submit" disabled={loading} className="w-full py-3 bg-gradient-to-r from-brand-cyan to-brand-purple text-white font-semibold rounded-xl">
                                {loading ? (isSignUp ? 'Creating Account...' : 'Signing in...') : (isSignUp ? 'Create Account' : 'Sign In')}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button 
                                onClick={() => { setIsSignUp(!isSignUp); setError(''); setSuccess(''); }} 
                                className="text-brand-cyan hover:text-brand-purple text-sm transition-colors"
                            >
                                {isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== DATA ROW & SECTION COMPONENTS ==========
        const DataRow = ({label, value, highlight, color, trend, icon}) => {
            const displayVal = clean(value);
            const isEmpty = displayVal === '‚Äî';
            const trendIcon = trend === 'up' ? '‚ÜóÔ∏è' : trend === 'down' ? '‚ÜòÔ∏è' : null;
            const trendColor = trend === 'up' ? 'text-emerald-400' : trend === 'down' ? 'text-red-400' : '';
            return (
                <div className="flex justify-between items-center py-2.5 border-b border-dark-700/50 last:border-0">
                    <span className="text-slate-400 text-sm flex items-center gap-2">
                        {icon && <span className="text-base">{icon}</span>}
                        {label}
                    </span>
                    <span className={`text-sm font-medium flex items-center gap-2 ${isEmpty ? 'text-slate-600' : highlight ? (color || 'text-brand-cyan') : 'text-white'}`}>
                        {displayVal}
                        {trendIcon && <span className={`text-xs ${trendColor}`}>{trendIcon}</span>}
                    </span>
                </div>
            );
        };

        const Section = ({title, children, cols = 1}) => (
            <div className="card p-6">
                <div className="section-title mb-4">{title}</div>
                <div className={cols === 2 ? 'grid md:grid-cols-2 gap-x-8 gap-y-1' : ''}>{children}</div>
            </div>
        );

        // ========== COLLAPSIBLE SECTION COMPONENT ==========
        const CollapsibleSection = ({title, summary, children, defaultOpen = false, icon}) => {
            const [isOpen, setIsOpen] = useState(defaultOpen);
            return (
                <div className="card overflow-hidden">
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full p-5 flex items-center justify-between hover:bg-dark-800/50 transition-colors"
                    >
                        <div className="flex items-center gap-3">
                            {icon && <span className="text-xl">{icon}</span>}
                            <div className="text-left">
                                <div className="font-semibold text-white">{title}</div>
                                {summary && <div className="text-sm text-slate-400 mt-1">{summary}</div>}
                            </div>
                        </div>
                        <span className={`text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}>‚ñº</span>
                    </button>
                    {isOpen && (
                        <div className="px-6 pb-6 pt-2 border-t border-dark-700">
                            {children}
                        </div>
                    )}
                </div>
            );
        };

        // ========== PRIORITY ACTION BANNER ==========
        const PriorityActionBanner = ({c, s}) => {
            if (!c) return null;

            // Determine the highest priority action
            const actions = [];

            // Payment overdue - highest priority
            if (s?.duePayment?.includes('OVERDUE')) {
                actions.push({
                    priority: 1,
                    icon: 'üí≥',
                    title: 'Payment Overdue',
                    description: 'Reach out to discuss payment status and resolve billing issues.',
                    action: 'Schedule Payment Call',
                    color: 'red'
                });
            }

            // No leads in 3 days
            const last3DayLeads = (c.last3DaySellerLeads || 0) + (c.last3DayBuyerLeads || 0);
            if (last3DayLeads === 0 && c.days >= 3) {
                actions.push({
                    priority: 2,
                    icon: 'üìâ',
                    title: 'No Leads in 3 Days',
                    description: 'Check ad account status, budget delivery, and campaign performance.',
                    action: 'Review Ad Account',
                    color: 'amber'
                });
            }

            // High CPL
            if (c.cpl > 50) {
                actions.push({
                    priority: 3,
                    icon: 'üìä',
                    title: 'High Cost Per Lead',
                    description: `CPL is $${c.cpl.toFixed(2)} (target is under $50). Review ad creative and targeting.`,
                    action: 'Optimize Campaigns',
                    color: 'amber'
                });
            }

            // No appointments
            if (c.appts === 0 && c.leads >= 20) {
                actions.push({
                    priority: 4,
                    icon: 'üìû',
                    title: 'No Appointments Despite Leads',
                    description: `${c.leads} leads but no appointments. Check lead quality and follow-up process.`,
                    action: 'Schedule Quality Call',
                    color: 'amber'
                });
            }

            // Red flags from setup
            if (s?.redFlags) {
                actions.push({
                    priority: 5,
                    icon: 'üö©',
                    title: 'Red Flags Noted',
                    description: s.redFlags,
                    action: 'Address Concerns',
                    color: 'red'
                });
            }

            // If healthy, show positive action
            if (actions.length === 0) {
                const score = getHealthScore(c, s);
                if (score >= 80) {
                    actions.push({
                        priority: 10,
                        icon: 'üåü',
                        title: 'Client Performing Well',
                        description: 'Great metrics! Consider asking for a testimonial or discussing expansion opportunities.',
                        action: 'Request Testimonial',
                        color: 'emerald'
                    });
                } else {
                    actions.push({
                        priority: 10,
                        icon: 'üìã',
                        title: 'Schedule Regular Check-In',
                        description: 'No urgent issues. Maintain relationship with a routine check-in call.',
                        action: 'Schedule Check-In',
                        color: 'cyan'
                    });
                }
            }

            const topAction = actions.sort((a, b) => a.priority - b.priority)[0];
            const colorMap = {
                red: 'border-red-500 bg-red-500/10',
                amber: 'border-amber-500 bg-amber-500/10',
                emerald: 'border-emerald-500 bg-emerald-500/10',
                cyan: 'border-brand-cyan bg-brand-cyan/10'
            };
            const textColorMap = {
                red: 'text-red-400',
                amber: 'text-amber-400',
                emerald: 'text-emerald-400',
                cyan: 'text-brand-cyan'
            };

            return (
                <div className={`card p-6 border-l-4 ${colorMap[topAction.color]}`}>
                    <div className="flex items-start justify-between gap-4">
                        <div className="flex items-start gap-4">
                            <span className="text-3xl">{topAction.icon}</span>
                            <div>
                                <div className="text-xs font-semibold text-brand-purple uppercase tracking-wider mb-1">Priority Action</div>
                                <h3 className={`text-lg font-bold ${textColorMap[topAction.color]}`}>{topAction.title}</h3>
                                <p className="text-slate-400 mt-1">{topAction.description}</p>
                            </div>
                        </div>
                        <button className={`px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap ${colorMap[topAction.color]} ${textColorMap[topAction.color]} hover:opacity-80 transition-opacity`}>
                            {topAction.action}
                        </button>
                    </div>
                </div>
            );
        };

        // ========== HEALTH SCORE CARD ==========
        const HealthScoreCard = ({c, s}) => {
            if (!c) return null;

            const score = getHealthScore(c, s);
            const {text, bg, label} = getHealthColor(score);

            // Calculate component scores
            const cplScore = c.cpl <= 15 ? 25 : c.cpl <= 25 ? 20 : c.cpl <= 35 ? 10 : c.cpl <= 50 ? 5 : 0;
            const apptScore = c.appts7 >= 5 ? 15 : c.appts7 >= 3 ? 10 : c.appts7 >= 1 ? 5 : 0;
            const dealScore = (c.deals > 0 || c.listings > 0) ? 10 : 0;
            const paymentPenalty = s?.duePayment?.includes('OVERDUE') ? -15 : 0;
            const flagPenalty = s?.redFlags ? -10 : 0;

            const components = [
                { name: 'CPL', score: cplScore, max: 25, icon: 'üí∞', status: cplScore >= 20 ? 'good' : cplScore >= 10 ? 'warning' : 'bad' },
                { name: 'Appointments', score: apptScore, max: 15, icon: 'üìÖ', status: apptScore >= 10 ? 'good' : apptScore >= 5 ? 'warning' : 'bad' },
                { name: 'Deals', score: dealScore, max: 10, icon: 'üéØ', status: dealScore > 0 ? 'good' : 'warning' },
                { name: 'Payment', score: paymentPenalty === 0 ? 15 : 0, max: 15, icon: 'üí≥', status: paymentPenalty === 0 ? 'good' : 'bad' },
            ];

            const statusColors = {
                good: 'text-emerald-400 bg-emerald-500/20 border-emerald-500/30',
                warning: 'text-amber-400 bg-amber-500/20 border-amber-500/30',
                bad: 'text-red-400 bg-red-500/20 border-red-500/30'
            };
            const statusIcons = { good: '‚úì', warning: '‚ö†', bad: '‚úó' };

            return (
                <div className="card p-6">
                    <div className="flex items-center justify-between mb-6">
                        <div>
                            <div className="text-xs font-semibold text-brand-purple uppercase tracking-wider mb-1">Health Score</div>
                            <div className="flex items-center gap-3">
                                <span className={`text-4xl font-bold ${text}`}>{score}</span>
                                <span className="text-slate-500">/100</span>
                                <span className={`px-3 py-1 rounded-full text-sm font-medium ${text} ${bg}/20`}>{label}</span>
                            </div>
                        </div>
                        <div className="w-24 h-24 relative">
                            <svg className="w-full h-full transform -rotate-90">
                                <circle cx="48" cy="48" r="40" fill="none" stroke="currentColor" className="text-dark-700" strokeWidth="8"/>
                                <circle cx="48" cy="48" r="40" fill="none" stroke="currentColor" className={text} strokeWidth="8" strokeLinecap="round"
                                    strokeDasharray={`${score * 2.51} 251`}/>
                            </svg>
                            <div className={`absolute inset-0 flex items-center justify-center text-2xl font-bold ${text}`}>{score}</div>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                        {components.map((comp, i) => (
                            <div key={i} className={`p-3 rounded-xl border ${statusColors[comp.status]} text-center`}>
                                <div className="text-lg mb-1">{comp.icon}</div>
                                <div className="text-xs font-medium mb-1">{comp.name}</div>
                                <div className="flex items-center justify-center gap-1">
                                    <span className="font-bold">{comp.score}</span>
                                    <span className="text-xs opacity-60">/{comp.max}</span>
                                    <span className="ml-1">{statusIcons[comp.status]}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ========== SMART INSIGHTS PANEL ==========
        const SmartInsightsPanel = ({c, s}) => {
            if (!c) return null;

            const insights = [];
            const last3DayLeads = (c.last3DaySellerLeads || 0) + (c.last3DayBuyerLeads || 0);
            const last7DayLeads = (c.last7DaySellerLeads || 0) + (c.last7DayBuyerLeads || 0);

            // Lead volume trends
            if (last7DayLeads > 0 && c.leads > 0) {
                const weeklyRate = last7DayLeads / 7;
                const overallRate = c.leads / Math.max(c.days, 1);
                if (weeklyRate > overallRate * 1.2) {
                    insights.push({
                        icon: 'üìà',
                        type: 'positive',
                        text: `Lead volume up ${Math.round((weeklyRate/overallRate - 1) * 100)}% compared to average - campaigns are improving`
                    });
                } else if (weeklyRate < overallRate * 0.8) {
                    insights.push({
                        icon: 'üìâ',
                        type: 'warning',
                        text: `Lead volume down ${Math.round((1 - weeklyRate/overallRate) * 100)}% from average - may need campaign review`
                    });
                }
            }

            // Leads but no appointments
            if (c.leads >= 30 && c.appts === 0) {
                insights.push({
                    icon: 'üîç',
                    type: 'warning',
                    text: `${c.leads} leads but no appointments - investigate lead quality or follow-up process`
                });
            } else if (c.leads >= 50 && c.appts > 0 && c.leads / c.appts > 20) {
                insights.push({
                    icon: 'üìä',
                    type: 'info',
                    text: `Lead-to-appointment ratio is 1:${Math.round(c.leads / c.appts)} - below typical 1:10 benchmark`
                });
            }

            // CPL trends
            const last7CPL = c.last7DaySellerCPL || c.last7DayBuyerCPL || 0;
            if (last7CPL > 0 && c.cpl > 0) {
                if (last7CPL < c.cpl * 0.85) {
                    insights.push({
                        icon: 'üí∞',
                        type: 'positive',
                        text: `Recent CPL ($${last7CPL.toFixed(2)}) is ${Math.round((1 - last7CPL/c.cpl) * 100)}% lower than lifetime average - campaigns optimizing well`
                    });
                } else if (last7CPL > c.cpl * 1.2) {
                    insights.push({
                        icon: '‚ö†Ô∏è',
                        type: 'warning',
                        text: `Recent CPL ($${last7CPL.toFixed(2)}) is ${Math.round((last7CPL/c.cpl - 1) * 100)}% higher than average - review ad performance`
                    });
                }
            }

            // Good conversion rate
            if (c.sellerLeadToAppt >= 15) {
                insights.push({
                    icon: 'üåü',
                    type: 'positive',
                    text: `Seller lead-to-appointment rate of ${c.sellerLeadToAppt.toFixed(1)}% is excellent - client is converting well`
                });
            }

            // Deals/Closings success
            if (c.deals > 0) {
                const costPerDeal = c.spend / c.deals;
                insights.push({
                    icon: 'üéØ',
                    type: 'positive',
                    text: `${c.deals} potential deals at $${Math.round(costPerDeal).toLocaleString()} cost per deal`
                });
            }

            // Missing leady sync
            if (!c.leadySync || c.leadySync === 'No') {
                insights.push({
                    icon: 'üîó',
                    type: 'info',
                    text: 'Leady sync not configured - consider setting up for automated lead tracking'
                });
            }

            // Long running without results
            if (c.days > 30 && c.leads < 10) {
                insights.push({
                    icon: '‚è∞',
                    type: 'warning',
                    text: `${c.days} days running with only ${c.leads} leads - significant campaign issues`
                });
            }

            if (insights.length === 0) {
                insights.push({
                    icon: '‚úÖ',
                    type: 'positive',
                    text: 'No significant issues detected - client metrics are within normal ranges'
                });
            }

            const typeColors = {
                positive: 'border-emerald-500/30 bg-emerald-500/5',
                warning: 'border-amber-500/30 bg-amber-500/5',
                info: 'border-brand-cyan/30 bg-brand-cyan/5'
            };

            return (
                <div className="card p-6">
                    <div className="section-title flex items-center gap-2">
                        <span>üí°</span> Smart Insights
                    </div>
                    <div className="space-y-3 mt-4">
                        {insights.slice(0, 5).map((insight, i) => (
                            <div key={i} className={`p-4 rounded-xl border ${typeColors[insight.type]}`}>
                                <div className="flex items-start gap-3">
                                    <span className="text-xl">{insight.icon}</span>
                                    <p className="text-slate-300 text-sm leading-relaxed">{insight.text}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ========== QUICK ACTIONS ==========
        const QuickActions = ({c, s, onAction}) => {
            if (!c) return null;

            const actions = [
                { icon: 'üìû', label: 'Schedule Check-In', action: 'checkin' },
                { icon: 'üìä', label: 'Request Report', action: 'report' },
                { icon: 'üí¨', label: 'Add Note', action: 'note' },
                { icon: 'üéØ', label: 'Review Ads', action: 'ads' },
                { icon: 'üìß', label: 'Send Resources', action: 'resources' },
                { icon: '‚ö†Ô∏è', label: 'Flag for Review', action: 'flag' },
            ];

            return (
                <div className="card p-5">
                    <div className="section-title">Quick Actions</div>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 mt-3">
                        {actions.map((action, i) => (
                            <button
                                key={i}
                                onClick={() => onAction && onAction(action.action)}
                                className="p-3 rounded-xl bg-dark-800 hover:bg-dark-700 transition-colors text-center group"
                            >
                                <div className="text-xl mb-1 group-hover:scale-110 transition-transform">{action.icon}</div>
                                <div className="text-xs text-slate-400 group-hover:text-white transition-colors">{action.label}</div>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // ========== PERFORMANCE TABS (Seller/Buyer) ==========
        const PerformanceTabs = ({c}) => {
            const [activeTab, setActiveTab] = useState('seller');
            if (!c) return null;

            const tabs = [
                { id: 'seller', label: 'Seller', icon: 'üè†' },
                { id: 'buyer', label: 'Buyer', icon: 'üõí' },
                { id: 'other', label: 'Other Leads', icon: 'üìä' },
                { id: 'deals', label: 'Deals', icon: 'üéØ' }
            ];

            const sellerContent = (
                <div className="grid md:grid-cols-2 gap-x-8 gap-y-1">
                    <DataRow label="Lifetime Leads" value={fmtN(c.sellerLeads)} highlight color="text-brand-cyan" icon="üìä"/>
                    <DataRow label="Lifetime CPL" value={fmtD(c.sellerCPL)} highlight icon="üí∞"/>
                    <DataRow label="Last 7 Day Leads" value={fmtN(c.last7DaySellerLeads)} trend={c.last7DaySellerLeads > c.last3DaySellerLeads * 2 ? 'up' : null}/>
                    <DataRow label="Last 7 Day CPL" value={fmtD(c.last7DaySellerCPL)}/>
                    <DataRow label="Last 3 Day Leads" value={fmtN(c.last3DaySellerLeads)}/>
                    <DataRow label="Last 3 Day CPL" value={fmtD(c.last3DaySellerCPL)}/>
                    <DataRow label="Total Appointments" value={fmtN(c.sellerAppts)} highlight color="text-brand-purple" icon="üìÖ"/>
                    <DataRow label="Appts (Last 7 Days)" value={fmtN(c.sellerAppts7)}/>
                    <DataRow label="Avg Appts/Week" value={c.avgSellerApptsWeek?.toFixed(1)}/>
                    <DataRow label="Lead‚ÜíAppt Rate" value={fmtP(c.sellerLeadToAppt)} highlight color={c.sellerLeadToAppt >= 15 ? 'text-emerald-400' : 'text-white'}/>
                    <DataRow label="Cost Per Appt" value={fmtD(c.costPerSellerAppt)}/>
                </div>
            );

            const buyerContent = (
                <div className="grid md:grid-cols-2 gap-x-8 gap-y-1">
                    <DataRow label="Lifetime Leads" value={fmtN(c.buyerLeads)} highlight color="text-brand-cyan" icon="üìä"/>
                    <DataRow label="Lifetime CPL" value={fmtD(c.buyerCPL)} highlight icon="üí∞"/>
                    <DataRow label="Last 7 Day Leads" value={fmtN(c.last7DayBuyerLeads)}/>
                    <DataRow label="Last 7 Day CPL" value={fmtD(c.last7DayBuyerCPL)}/>
                    <DataRow label="Last 3 Day Leads" value={fmtN(c.last3DayBuyerLeads)}/>
                    <DataRow label="Last 3 Day CPL" value={fmtD(c.last3DayBuyerCPL)}/>
                    <DataRow label="Total Appointments" value={fmtN(c.buyerAppts)} highlight color="text-brand-purple" icon="üìÖ"/>
                    <DataRow label="Appts (Last 7 Days)" value={fmtN(c.buyerAppts7)}/>
                    <DataRow label="Avg Appts/Week" value={c.avgBuyerApptsWeek?.toFixed(1)}/>
                    <DataRow label="Lead‚ÜíAppt Rate" value={fmtP(c.buyerLeadToAppt)} highlight color={c.buyerLeadToAppt >= 15 ? 'text-emerald-400' : 'text-white'}/>
                    <DataRow label="Cost Per Appt" value={fmtD(c.costPerBuyerAppt)}/>
                </div>
            );

            const otherContent = (
                <div className="grid md:grid-cols-2 gap-x-8 gap-y-1">
                    <DataRow label="Listing Leads" value={fmtN(c.listingLeads)} highlight icon="üìã"/>
                    <DataRow label="Mortgage Leads" value={fmtN(c.mortgageLeads)} icon="üè¶"/>
                    <DataRow label="Agent Attraction" value={fmtN(c.agentAttraction)} icon="üë•"/>
                </div>
            );

            const dealsContent = (
                <div className="grid md:grid-cols-2 gap-x-8 gap-y-1">
                    <DataRow label="Potential Deals" value={fmtN(c.deals)} highlight color="text-emerald-400" icon="üéØ"/>
                    <DataRow label="Listings" value={fmtN(c.listings)} highlight color="text-amber-400" icon="üè†"/>
                    <DataRow label="Buyer Signed" value={fmtN(c.buyerSigned)} highlight color="text-emerald-400" icon="‚úçÔ∏è"/>
                    <DataRow label="Leads per Listing" value={c.leadsPerListing?.toFixed(1)}/>
                    <DataRow label="Leads per Deal" value={c.leadsPerDeal?.toFixed(1)}/>
                    <DataRow label="Leads per Signed Buyer" value={c.leadsPerSignedBuyer?.toFixed(1)}/>
                </div>
            );

            return (
                <div className="card overflow-hidden">
                    <div className="flex border-b border-dark-700">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`flex-1 px-4 py-4 text-sm font-medium transition-colors flex items-center justify-center gap-2
                                    ${activeTab === tab.id
                                        ? 'bg-gradient-to-r from-brand-cyan/10 to-brand-purple/10 text-white border-b-2 border-brand-cyan'
                                        : 'text-slate-400 hover:text-white hover:bg-dark-800'}`}
                            >
                                <span>{tab.icon}</span>
                                <span className="hidden md:inline">{tab.label}</span>
                            </button>
                        ))}
                    </div>
                    <div className="p-6">
                        {activeTab === 'seller' && sellerContent}
                        {activeTab === 'buyer' && buyerContent}
                        {activeTab === 'other' && otherContent}
                        {activeTab === 'deals' && dealsContent}
                    </div>
                </div>
            );
        };

        // ========== TREND METRIC CARD ==========
        const TrendMetricCard = ({label, value, icon, trend, trendValue, color = 'brand-cyan'}) => {
            const trendIcon = trend === 'up' ? '‚ÜóÔ∏è' : trend === 'down' ? '‚ÜòÔ∏è' : '‚Üí';
            const trendColor = trend === 'up' ? 'text-emerald-400' : trend === 'down' ? 'text-red-400' : 'text-slate-400';

            return (
                <div className={`card p-5 border-l-4 border-${color}`}>
                    <div className="flex items-start justify-between">
                        <div>
                            <div className="text-3xl font-bold text-white">{value}</div>
                            <div className="text-sm text-slate-400 mt-1">{label}</div>
                        </div>
                        {icon && <span className="text-2xl">{icon}</span>}
                    </div>
                    {trendValue && (
                        <div className={`mt-3 text-sm ${trendColor} flex items-center gap-1`}>
                            <span>{trendIcon}</span>
                            <span>{trendValue}</span>
                        </div>
                    )}
                </div>
            );
        };

        // ========== CLIENT HEALTH TAB - FULL DETAILS ==========
        const ClientHealthTab = ({ c, s, isMissingFromAdsSheet }) => {
            if (!c && !isMissingFromAdsSheet) return <div className="card p-12 text-center text-slate-500">Select a client to view details</div>;

            // If client is missing from Ads Performance sheet
            if (isMissingFromAdsSheet) {
                return (
                    <div className="space-y-6">
                        <div className="card p-8 border-l-4 border-purple-500">
                            <div className="flex items-center gap-4 mb-4">
                                <span className="text-4xl">üìã</span>
                                <div>
                                    <h3 className="text-xl font-bold text-purple-400">Missing from Client Ads Performance Sheet</h3>
                                    <p className="text-slate-400">This client needs to be added to the Client Ads Performance tracking sheet.</p>
                                </div>
                            </div>
                            <div className="bg-purple-500/10 rounded-xl p-4 mt-4">
                                <p className="text-white font-medium mb-2">Action Required:</p>
                                <ol className="text-slate-300 space-y-1 text-sm">
                                    <li>1. Open the Client Ads Performance Google Sheet</li>
                                    <li>2. Add a new row for this client</li>
                                    <li>3. Fill in their ad account details and metrics</li>
                                    <li>4. Refresh this dashboard to see their data</li>
                                </ol>
                            </div>
                        </div>
                        {s && (
                            <Section title="üìã Available Info from Setup Timing">
                                <DataRow label="CSM Rep" value={s?.csmRep} highlight color="text-brand-purple"/>
                                <DataRow label="Status" value={s?.status}/>
                                <DataRow label="MRR" value={s?.mrr} highlight color="text-emerald-400"/>
                                <DataRow label="Due Payment" value={s?.duePayment}/>
                            </Section>
                        )}
                    </div>
                );
            }

            // Calculate trend data
            const last3DayLeads = (c.last3DaySellerLeads || 0) + (c.last3DayBuyerLeads || 0);
            const last7DayLeads = (c.last7DaySellerLeads || 0) + (c.last7DayBuyerLeads || 0);
            const avgDailyLeads = c.leads / Math.max(c.days, 1);
            const recent7DayAvg = last7DayLeads / 7;
            const leadTrend = recent7DayAvg > avgDailyLeads * 1.1 ? 'up' : recent7DayAvg < avgDailyLeads * 0.9 ? 'down' : null;

            const last7CPL = c.last7DaySellerCPL || c.last7DayBuyerCPL || 0;
            const cplTrend = last7CPL > 0 && c.cpl > 0 ? (last7CPL < c.cpl * 0.9 ? 'up' : last7CPL > c.cpl * 1.1 ? 'down' : null) : null;

            return (
                <div className="space-y-6">
                    {/* Priority Action Banner - Most Important */}
                    <PriorityActionBanner c={c} s={s} />

                    {/* Health Score + Quick Stats Row */}
                    <div className="grid lg:grid-cols-2 gap-6">
                        <HealthScoreCard c={c} s={s} />

                        {/* Quick Stats with Trends */}
                        <div className="grid grid-cols-2 gap-4">
                            <div className="card p-5 border-l-4 border-brand-cyan">
                                <div className="flex items-start justify-between">
                                    <div>
                                        <div className="text-3xl font-bold text-white">{fmt(c.spend)}</div>
                                        <div className="text-sm text-slate-400 mt-1">Total Spend</div>
                                    </div>
                                    <span className="text-2xl">üí∞</span>
                                </div>
                            </div>
                            <div className="card p-5 border-l-4 border-brand-cyan">
                                <div className="flex items-start justify-between">
                                    <div>
                                        <div className="text-3xl font-bold text-brand-cyan">{fmtN(c.leads)}</div>
                                        <div className="text-sm text-slate-400 mt-1">Total Leads</div>
                                    </div>
                                    <span className="text-2xl">üìä</span>
                                </div>
                                {leadTrend && (
                                    <div className={`mt-2 text-sm flex items-center gap-1 ${leadTrend === 'up' ? 'text-emerald-400' : 'text-red-400'}`}>
                                        <span>{leadTrend === 'up' ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'}</span>
                                        <span>{leadTrend === 'up' ? 'Trending up' : 'Trending down'} vs avg</span>
                                    </div>
                                )}
                            </div>
                            <div className="card p-5 border-l-4 border-brand-purple">
                                <div className="flex items-start justify-between">
                                    <div>
                                        <div className={`text-3xl font-bold ${c.cpl > 50 ? 'text-red-400' : c.cpl > 35 ? 'text-amber-400' : 'text-white'}`}>{fmtD(c.cpl)}</div>
                                        <div className="text-sm text-slate-400 mt-1">Cost Per Lead</div>
                                    </div>
                                    <span className="text-2xl">üìà</span>
                                </div>
                                {cplTrend && (
                                    <div className={`mt-2 text-sm flex items-center gap-1 ${cplTrend === 'up' ? 'text-emerald-400' : 'text-red-400'}`}>
                                        <span>{cplTrend === 'up' ? '‚ÜòÔ∏è' : '‚ÜóÔ∏è'}</span>
                                        <span>{cplTrend === 'up' ? 'Improving!' : 'Increasing'}</span>
                                    </div>
                                )}
                            </div>
                            <div className="card p-5 border-l-4 border-brand-purple">
                                <div className="flex items-start justify-between">
                                    <div>
                                        <div className="text-3xl font-bold text-brand-purple">{fmtN(c.appts)}</div>
                                        <div className="text-sm text-slate-400 mt-1">Appointments</div>
                                    </div>
                                    <span className="text-2xl">üìÖ</span>
                                </div>
                                {c.leads > 0 && (
                                    <div className="mt-2 text-sm text-slate-400">
                                        {(c.appts / c.leads * 100).toFixed(1)}% conversion
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Quick Actions */}
                    <QuickActions c={c} s={s} />

                    {/* Smart Insights */}
                    <SmartInsightsPanel c={c} s={s} />

                    {/* Recent Performance - Last 3/7 Days */}
                    <div className="grid md:grid-cols-2 gap-6">
                        <div className="card p-6 border-l-4 border-amber-500">
                            <div className="section-title mb-4">üìä Last 3 Days</div>
                            <div className="grid grid-cols-2 gap-6">
                                <div>
                                    <div className="text-3xl font-bold text-white">{fmtN(last3DayLeads)}</div>
                                    <div className="text-sm text-slate-400 mt-1">Leads</div>
                                    {last3DayLeads === 0 && c.days >= 3 && (
                                        <div className="mt-2 text-xs text-amber-400">‚ö†Ô∏è No leads</div>
                                    )}
                                </div>
                                <div>
                                    <div className="text-3xl font-bold text-brand-cyan">{fmtD(c.last3DaySellerCPL || c.last3DayBuyerCPL || 0)}</div>
                                    <div className="text-sm text-slate-400 mt-1">CPL</div>
                                </div>
                            </div>
                        </div>
                        <div className="card p-6 border-l-4 border-brand-cyan">
                            <div className="section-title mb-4">üìà Last 7 Days</div>
                            <div className="grid grid-cols-2 gap-6">
                                <div>
                                    <div className="text-3xl font-bold text-white">{fmtN(last7DayLeads)}</div>
                                    <div className="text-sm text-slate-400 mt-1">Leads</div>
                                </div>
                                <div>
                                    <div className="text-3xl font-bold text-brand-cyan">{fmtD(last7CPL)}</div>
                                    <div className="text-sm text-slate-400 mt-1">CPL</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Performance Tabs - Seller/Buyer/Other/Deals */}
                    <PerformanceTabs c={c} />

                    {/* Collapsible Sections for Additional Details */}
                    <CollapsibleSection
                        title="CSM & Client Status"
                        icon="üë§"
                        summary={`${s?.csmRep || 'No CSM'} ‚Ä¢ ${s?.status || 'Status unknown'} ‚Ä¢ MRR: ${s?.mrr || '‚Äî'}`}
                        defaultOpen={false}
                    >
                        <div className="grid md:grid-cols-2 gap-x-8 gap-y-1">
                            <DataRow label="CSM Rep" value={s?.csmRep} highlight color="text-brand-purple" icon="üë§"/>
                            <DataRow label="Status" value={s?.status} icon="üìã"/>
                            <DataRow label="Concern" value={s?.concern} icon="‚ö†Ô∏è"/>
                            <DataRow label="Referral" value={s?.referral} icon="ü§ù"/>
                            <DataRow label="Testimonial" value={s?.testimonial} icon="‚≠ê"/>
                            <DataRow label="Lender" value={s?.lender} icon="üè¶"/>
                            <DataRow label="Last CSM Note" value={s?.lastCsmNote} icon="üìù"/>
                            <DataRow label="Upcoming CSM Date" value={s?.upcomingCsmDate} icon="üìÖ"/>
                        </div>
                    </CollapsibleSection>

                    <CollapsibleSection
                        title="Client & Contract Details"
                        icon="üìã"
                        summary={`${s?.state || c.state || 'No state'} ‚Ä¢ ${s?.contractCategory || 'No category'} ‚Ä¢ Days Left: ${s?.daysLeft || '‚Äî'}`}
                        defaultOpen={false}
                    >
                        <div className="grid md:grid-cols-2 gap-x-8 gap-y-1">
                            <DataRow label="State" value={s?.state || c.state} icon="üìç"/>
                            <DataRow label="Campaign" value={s?.campaign || c.campaign} icon="üéØ"/>
                            <DataRow label="Contract Category" value={s?.contractCategory} highlight icon="üìÑ"/>
                            <DataRow label="MRR" value={s?.mrr} highlight color="text-emerald-400" icon="üí∞"/>
                            <DataRow label="Fulfilled" value={s?.fulfilled} highlight color="text-emerald-400" icon="‚úÖ"/>
                            <DataRow label="Days Left" value={s?.daysLeft} highlight color={pn(s?.daysLeft) < 0 ? 'text-red-400' : 'text-brand-cyan'} icon="‚è≥"/>
                            <DataRow label="Due Payment" value={s?.duePayment} highlight color={s?.duePayment?.includes('OVERDUE') ? 'text-red-400' : 'text-emerald-400'} icon="üí≥"/>
                            <DataRow label="Spanish" value={s?.spanish} icon="üåê"/>
                        </div>
                    </CollapsibleSection>

                    <CollapsibleSection
                        title="Key Dates"
                        icon="üìÖ"
                        summary={`Paid: ${clean(s?.paidDate)} ‚Ä¢ Ads Live: ${clean(s?.adLiveDate)}`}
                        defaultOpen={false}
                    >
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="bg-dark-800 rounded-xl p-5 text-center">
                                <div className="text-2xl mb-2">üí∞</div>
                                <div className="text-lg font-bold text-white">{clean(s?.paidDate)}</div>
                                <div className="text-sm text-slate-400 mt-1">Paid</div>
                            </div>
                            <div className="bg-dark-800 rounded-xl p-5 text-center">
                                <div className="text-2xl mb-2">üöÄ</div>
                                <div className="text-lg font-bold text-white">{clean(s?.onboardedDate)}</div>
                                <div className="text-sm text-slate-400 mt-1">Onboarded</div>
                            </div>
                            <div className="bg-dark-800 rounded-xl p-5 text-center">
                                <div className="text-2xl mb-2">üìû</div>
                                <div className="text-lg font-bold text-white">{clean(s?.launchCallDate)}</div>
                                <div className="text-sm text-slate-400 mt-1">Launch Call</div>
                            </div>
                            <div className="bg-dark-800 rounded-xl p-5 text-center">
                                <div className="text-2xl mb-2">üì¢</div>
                                <div className="text-lg font-bold text-white">{clean(s?.adLiveDate)}</div>
                                <div className="text-sm text-slate-400 mt-1">Ads Live</div>
                            </div>
                        </div>
                    </CollapsibleSection>

                    <CollapsibleSection
                        title="Ad Account & Spend"
                        icon="üì¢"
                        summary={`${c.adAccount || 'No account'} ‚Ä¢ ${fmt(c.spend)} total ‚Ä¢ ${c.days} days running`}
                        defaultOpen={false}
                    >
                        <div className="grid md:grid-cols-2 gap-x-8 gap-y-1">
                            <DataRow label="Ad Account" value={c.adAccount} highlight icon="üì±"/>
                            <DataRow label="Daily Set Ad Spend" value={fmtD(c.dailySetAdSpend)} icon="üíµ"/>
                            <DataRow label="Total Ad Spend" value={fmt(c.spend)} highlight color="text-brand-cyan" icon="üí∞"/>
                            <DataRow label="Ad Spend Per Month" value={fmt(c.spendPerMonth)} icon="üìÜ"/>
                            <DataRow label="Ad Spend Per Day" value={fmtD(c.spendPerDay)} icon="üìÖ"/>
                            <DataRow label="Days Running" value={c.days} icon="‚è±Ô∏è"/>
                            <DataRow label="Weeks Running" value={c.weeks} icon="üìä"/>
                            <DataRow label="Months Running" value={c.months} icon="üóìÔ∏è"/>
                            <DataRow label="Calling Status" value={c.callingStatus} icon="üìû"/>
                            <DataRow label="Leady Sync" value={c.leadySync} icon="üîó"/>
                        </div>
                    </CollapsibleSection>

                    <CollapsibleSection
                        title="Setup Timing Performance"
                        icon="üìä"
                        summary={`Closings: ${s?.closings || '‚Äî'} ‚Ä¢ Signed: ${s?.signed || '‚Äî'}`}
                        defaultOpen={false}
                    >
                        <div className="grid md:grid-cols-2 gap-x-8 gap-y-1">
                            <DataRow label="Closings" value={s?.closings} highlight color="text-emerald-400" icon="üèÜ"/>
                            <DataRow label="Signed" value={s?.signed} highlight color="text-emerald-400" icon="‚úçÔ∏è"/>
                            <DataRow label="SHU%" value={s?.shuPercent} icon="üìà"/>
                            <DataRow label="Behind Schedule" value={s?.behindSchedule} icon="‚è∞"/>
                            <DataRow label="Missing" value={s?.missing} icon="‚ùì"/>
                            <DataRow label="Calling" value={s?.calling} icon="üìû"/>
                            <DataRow label="Dialer" value={s?.dialer} icon="üì±"/>
                            <DataRow label="S Leads" value={s?.sLeads} highlight color="text-brand-cyan" icon="üè†"/>
                            <DataRow label="B Leads" value={s?.bLeads} highlight color="text-brand-cyan" icon="üõí"/>
                            <DataRow label="CPL" value={s?.cpl} icon="üí≤"/>
                            <DataRow label="CPA" value={s?.cpa} icon="üí∞"/>
                        </div>
                    </CollapsibleSection>
                </div>
            );
        };

        // ========== CALL SCRIPTS TAB ==========
        const CallScriptsTab = ({ c, s }) => {
            const clientName = (c && c.client) ? c.client : '[Client]';
            const totalLeads = (c && c.leads) ? c.leads : 'X';
            const cplValue = fmtD((c && c.cpl) ? c.cpl : 0);
            const sellerLeadsVal = (c && c.sellerLeads) ? c.sellerLeads : 'X';
            const buyerLeadsVal = (c && c.buyerLeads) ? c.buyerLeads : 'X';
            const apptsVal = (c && c.appts) ? c.appts : 'X';
            const convRate = fmtP((c && c.sellerLeadToAppt) ? c.sellerLeadToAppt : 0);

            const scripts = [
                { 
                    name: 'Check-In Call', 
                    icon: 'üìû', 
                    content: 'Hi ' + clientName + ', this is [Your Name] from Veriad Marketing! How are you doing today?\n\n[Wait for response]\n\nGreat! I wanted to check in and see how things are going with your leads. Have you been able to connect with any of them this week?\n\n[Listen and take notes]\n\nThat\'s great to hear! Let me pull up your account... I can see you\'ve gotten ' + totalLeads + ' leads so far with a CPL of ' + cplValue + '.\n\n[If good CPL]: Your cost per lead is looking really solid!\n[If high CPL]: I noticed your CPL is a bit higher than we\'d like. Let me look into optimizing your campaigns.\n\nAny questions for me?' 
                },
                { 
                    name: 'Concern/Complaint Call', 
                    icon: 'üòü', 
                    content: 'Hi ' + clientName + ', thank you for reaching out. I understand you have some concerns and I want to make sure we address them properly.\n\nCan you tell me more about what\'s been happening?\n\n[Listen carefully, don\'t interrupt]\n\nI really appreciate you sharing that with me. I can understand how that would be frustrating.\n\nHere\'s what I\'d like to do:\n1. [Immediate action you can take]\n2. [Follow-up action]\n3. [Timeline for resolution]\n\nDoes that sound like a good plan?' 
                },
                { 
                    name: 'Lead Quality Issue', 
                    icon: 'üéØ', 
                    content: 'Hi ' + clientName + ', I wanted to follow up on the lead quality feedback you shared.\n\nI\'ve reviewed your recent leads and here\'s what I found:\n- Total leads: ' + totalLeads + '\n- Seller leads: ' + sellerLeadsVal + '\n- Buyer leads: ' + buyerLeadsVal + '\n\nA few questions to help me optimize:\n1. What percentage of leads are answering when you call?\n2. Are they motivated sellers/buyers?\n3. What\'s your typical follow-up process?\n\n[Based on answers, suggest optimization]' 
                },
                { 
                    name: 'Upsell/Expansion', 
                    icon: 'üìà', 
                    content: 'Hi ' + clientName + ', I\'ve been looking at your results and I\'m really impressed!\n\nYou\'ve generated ' + totalLeads + ' leads and ' + apptsVal + ' appointments. That\'s a ' + convRate + ' conversion rate!\n\nI wanted to discuss an opportunity to scale your success. Have you considered:\n- Adding buyer leads to your campaign?\n- Expanding to additional zip codes?\n- Increasing your daily budget?\n\nWhat do you think would help you close more deals?' 
                },
            ];

            return (
                <div className="space-y-4">
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-2">üìû Call Scripts</h3>
                        <p className="text-slate-400 text-sm">Phone scripts customized for {clientName}. Click to expand.</p>
                    </div>
                    {scripts.map((script, i) => (
                        <details key={i} className="card">
                            <summary className="p-4 cursor-pointer flex items-center gap-3 hover:bg-dark-800 rounded-xl">
                                <span className="text-xl">{script.icon}</span>
                                <span className="font-medium text-white">{script.name}</span>
                            </summary>
                            <div className="p-4 pt-0 border-t border-dark-700">
                                <pre className="whitespace-pre-wrap text-sm text-slate-300 font-sans leading-relaxed">{script.content}</pre>
                                <button onClick={() => navigator.clipboard.writeText(script.content)} className="mt-4 px-4 py-2 bg-brand-cyan/20 text-brand-cyan rounded-lg text-sm">üìã Copy Script</button>
                            </div>
                        </details>
                    ))}
                </div>
            );
        };

        // ========== LIVE CALL HELP TAB ==========
        const LiveCallHelpTab = ({ c, s }) => {
            const [situation, setSituation] = useState('');
            const [response, setResponse] = useState('');
            const [loading, setLoading] = useState(false);

            const cplText = 'Your CPL is ' + fmtD(c?.cpl || 0) + '. We can: 1) Review targeting, 2) Test new creative, 3) Adjust budget, 4) Check landing page.';

            const quickResponses = [
                { q: 'Client says leads are bad', a: 'I understand your concern. Let me ask: How quickly are you calling these leads? Studies show calling within 5 minutes increases contact rate by 400%. Also, are you using the scripts we provided?' },
                { q: 'Client wants to cancel', a: 'I hear you, and I want to make sure we find the right solution. Before we discuss cancellation, can you help me understand what specific results you were hoping for?' },
                { q: 'Client not answering leads', a: 'Try: 1) Call within 5 minutes, 2) Try different times of day, 3) Send a text first, 4) Follow up at least 6-8 times.' },
                { q: 'CPL is too high', a: cplText },
            ];

            const getAIHelp = async () => {
                if (!situation.trim()) return;
                setLoading(true);
                try {
                    const promptText = `You are a CSM (Customer Success Manager) helping on a live call with a real estate lead generation client.

Client: ${c?.client || 'Unknown'}
Leads: ${c?.leads || 0}
CPL: ${fmtD(c?.cpl || 0)}
Appointments: ${c?.appts || 0}

The CSM needs help with this situation: "${situation}"

Provide a brief, practical response that the CSM can use immediately on the call. Be direct and actionable. Keep it under 200 words.`;

                    const res = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            max_tokens: 500,
                            messages: [{ role: 'user', content: promptText }]
                        })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error.message);
                    setResponse(data.content?.[0]?.text || 'Could not generate response.');
                } catch (err) { setResponse('AI unavailable: ' + err.message + '. Try quick responses below.'); }
                setLoading(false);
            };

            return (
                <div className="space-y-6">
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üéß Live Call Help</h3>
                        <textarea value={situation} onChange={e => setSituation(e.target.value)} placeholder="Describe the situation..." className="w-full bg-dark-800 border border-dark-700 rounded-xl p-4 text-white min-h-[100px]" />
                        <button onClick={getAIHelp} disabled={loading || !situation.trim()} className="mt-3 px-6 py-3 bg-gradient-to-r from-brand-cyan to-brand-purple text-white font-semibold rounded-xl disabled:opacity-50">
                            {loading ? 'ü§ñ Thinking...' : 'ü§ñ Get AI Help'}
                        </button>
                        {response && <div className="mt-4 p-4 bg-dark-800 rounded-xl text-sm text-slate-300">{response}</div>}
                    </div>
                    <div className="card p-6">
                        <h4 className="font-semibold text-white mb-4">‚ö° Quick Responses</h4>
                        <div className="space-y-3">
                            {quickResponses.map((qr, i) => (
                                <details key={i} className="bg-dark-800 rounded-xl">
                                    <summary className="p-3 cursor-pointer text-brand-cyan text-sm">{qr.q}</summary>
                                    <div className="p-3 pt-0 text-sm text-slate-300">{qr.a}</div>
                                </details>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // ========== STRATEGY TAB ==========
        const StrategyTab = ({ c, s }) => {
            const { user } = useAuth();
            const [strategy, setStrategy] = useState('');
            const [bottlenecks, setBottlenecks] = useState('');
            const [actions, setActions] = useState('');
            const [saving, setSaving] = useState(false);

            useEffect(() => { if (c?.client) loadStrategy(); }, [c?.client]);

            const loadStrategy = async () => {
                const { data } = await supabase.from('client_strategy').select('*').eq('client_name', c.client).single();
                if (data) { setStrategy(data.strategy_text || ''); setBottlenecks(data.bottlenecks || ''); setActions(data.action_items || ''); }
            };

            useEffect(() => {
                if (!c?.client) return;
                const timer = setTimeout(saveStrategy, 1500);
                return () => clearTimeout(timer);
            }, [strategy, bottlenecks, actions]);

            const saveStrategy = async () => {
                if (!c?.client || !user) return;
                setSaving(true);
                await supabase.from('client_strategy').upsert({ client_name: c.client, strategy_text: strategy, bottlenecks, action_items: actions, user_email: user.email, last_edited_by: user.email, updated_at: new Date().toISOString() }, { onConflict: 'client_name' });
                setSaving(false);
            };

            const detectedIssues = [];
            if (c?.cpl > 40) detectedIssues.push({ icon: 'üìà', text: 'High CPL (' + fmtD(c.cpl) + ')' });
            if (c?.appts7 === 0 && c?.days > 14) detectedIssues.push({ icon: 'üìÖ', text: 'No appointments this week' });
            if (c?.leads > 20 && c?.appts === 0) detectedIssues.push({ icon: 'üìû', text: c.leads + ' leads but 0 appts' });

            if (!c) return <div className="card p-12 text-center text-slate-500">Select a client</div>;

            return (
                <div className="space-y-6">
                    {detectedIssues.length > 0 && (
                        <div className="card p-6">
                            <h3 className="text-lg font-semibold text-white mb-4">üîç Detected Issues</h3>
                            <div className="space-y-2">
                                {detectedIssues.map((issue, i) => (
                                    <div key={i} className="flex items-center gap-3 p-3 bg-amber-500/10 rounded-xl text-amber-400 text-sm"><span>{issue.icon}</span><span>{issue.text}</span></div>
                                ))}
                            </div>
                        </div>
                    )}
                    <div className="card p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold text-white">üéØ Current Strategy</h3>
                            <span className="text-xs text-slate-500">{saving ? 'Saving...' : 'Auto-saved'}</span>
                        </div>
                        <textarea value={strategy} onChange={e => setStrategy(e.target.value)} placeholder="What's the current strategy?" className="w-full bg-dark-800 border border-dark-700 rounded-xl p-4 text-white min-h-[120px]" />
                    </div>
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üöß Bottlenecks</h3>
                        <textarea value={bottlenecks} onChange={e => setBottlenecks(e.target.value)} placeholder="What's blocking success?" className="w-full bg-dark-800 border border-dark-700 rounded-xl p-4 text-white min-h-[100px]" />
                    </div>
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">‚úÖ Action Plan</h3>
                        <textarea value={actions} onChange={e => setActions(e.target.value)} placeholder="What actions need to be taken?" className="w-full bg-dark-800 border border-dark-700 rounded-xl p-4 text-white min-h-[100px]" />
                    </div>
                </div>
            );
        };

        // ========== SAVE THE CLIENT TAB ==========
        const SaveClientTab = ({ c, s }) => {
            const score = getHealthScore(c, s);
            const playbooks = [
                { name: 'Payment Overdue', trigger: s?.duePayment?.includes('OVERDUE'), steps: ['Call immediately', 'Ask about service issues', 'Offer payment plan', 'Set deadline', 'Escalate if needed'] },
                { name: 'High CPL', trigger: c?.cpl > 50, steps: ['Review targeting', 'Check ad creative', 'Review landing page', 'Consider rebuild', 'Offer refresh'] },
                { name: 'No Appointments', trigger: c?.leads > 15 && c?.appts === 0, steps: ['Review lead quality', 'Check calling speed', 'Review scripts', 'Listen to recordings', 'Recommend ISA'] },
                { name: 'Client Wants to Cancel', trigger: false, steps: ['LISTEN first', 'Acknowledge frustration', 'Review wins', 'Propose solutions', 'Offer pause', 'Get manager'] },
            ];
            if (!c) return <div className="card p-12 text-center text-slate-500">Select a client</div>;
            return (
                <div className="space-y-6">
                    <div className={`card p-6 ${score < 60 ? 'border-red-500/30' : ''}`}>
                        <div className="flex items-center gap-4">
                            <span className="text-4xl">{score < 60 ? 'üö®' : '‚ö†Ô∏è'}</span>
                            <div><h3 className="text-lg font-bold text-white">Risk Assessment</h3><p className={score < 60 ? 'text-red-400' : 'text-amber-400'}>Score: {score}/100</p></div>
                        </div>
                    </div>
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üõü Playbooks</h3>
                        <div className="space-y-4">
                            {playbooks.map((pb, i) => (
                                <div key={i} className={`p-4 rounded-xl ${pb.trigger ? 'bg-red-500/10 border border-red-500/30' : 'bg-dark-800'}`}>
                                    <div className="flex items-center gap-2 mb-2">
                                        {pb.trigger && <span className="px-2 py-1 bg-red-500 text-white text-xs rounded">ACTIVE</span>}
                                        <h4 className="font-semibold text-white">{pb.name}</h4>
                                    </div>
                                    <ul className="space-y-1 text-sm text-slate-300">{pb.steps.map((step, j) => <li key={j}>{j+1}. {step}</li>)}</ul>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // ========== COMBINED NOTES, MEETINGS & ACTIVITY TAB (ALL ON ONE PAGE) ==========
        const NotesActivityTab = ({ c }) => {
            const { user } = useAuth();
            const [notes, setNotes] = useState([]);
            const [meetings, setMeetings] = useState([]);
            const [activities, setActivities] = useState([]);
            const [newNote, setNewNote] = useState('');
            const [transcript, setTranscript] = useState('');
            const [meetingDate, setMeetingDate] = useState(new Date().toISOString().split('T')[0]);
            const [meetingTitle, setMeetingTitle] = useState('');
            const [processing, setProcessing] = useState(false);
            const [summary, setSummary] = useState(null);
            const [expandedMeeting, setExpandedMeeting] = useState(null);
            const [editingNote, setEditingNote] = useState(null);
            const [editNoteText, setEditNoteText] = useState('');

            useEffect(() => { if (c?.client) { loadNotes(); loadMeetings(); loadActivities(); } }, [c?.client]);

            const loadNotes = async () => { const { data } = await supabase.from('client_notes').select('*').eq('client_name', c.client).order('created_at', { ascending: false }); if (data) setNotes(data); };
            const loadMeetings = async () => { const { data } = await supabase.from('meeting_notes').select('*').eq('client_name', c.client).order('meeting_date', { ascending: false }); if (data) setMeetings(data); };
            const loadActivities = async () => { const { data } = await supabase.from('activity_log').select('*').eq('client_name', c.client).order('created_at', { ascending: false }).limit(50); if (data) setActivities(data); };

            const addNote = async (noteText, source = 'manual') => {
                const text = noteText || newNote;
                if (!text || !text.trim()) return;
                if (!noteText) setNewNote('');
                const noteObj = { client_name: c.client, note_text: text, user_email: user?.email };
                const { data, error } = await supabase.from('client_notes').insert(noteObj).select().single();
                if (error) { console.error('addNote error:', error); alert('Failed to save note: ' + error.message); if (!noteText) setNewNote(text); return; }
                if (data) setNotes(prev => [data, ...prev]);
                await supabase.from('activity_log').insert({ user_email: user?.email, client_name: c.client, action: source === 'ai_extracted' ? 'AI extracted important note' : 'Added note', details: text.substring(0, 50) });
                return data;
            };

            const deleteNote = async (id) => {
                await supabase.from('client_notes').delete().eq('id', id);
                setNotes(notes.filter(n => n.id !== id));
                await supabase.from('activity_log').insert({ user_email: user?.email, client_name: c.client, action: 'Deleted note', details: '' });
            };

            const startEditNote = (note) => {
                setEditingNote(note.id);
                setEditNoteText(note.note_text);
            };

            const saveEditNote = async (id) => {
                if (!editNoteText.trim()) return;
                const { data } = await supabase.from('client_notes').update({
                    note_text: editNoteText,
                    edited_at: new Date().toISOString(),
                    edited_by: user?.email
                }).eq('id', id).select().single();
                if (data) {
                    setNotes(notes.map(n => n.id === id ? data : n));
                    setEditingNote(null);
                    setEditNoteText('');
                }
                await supabase.from('activity_log').insert({ user_email: user?.email, client_name: c.client, action: 'Edited note', details: editNoteText.substring(0, 50) });
            };

            const cancelEditNote = () => {
                setEditingNote(null);
                setEditNoteText('');
            };

            const processTranscript = async () => {
                setProcessing(true);
                try {
                    const promptContent = `Analyze this meeting transcript for client "${c?.client || 'Unknown'}".

Extract ALL details and return a comprehensive JSON object with this exact structure:
{
    "title": "Brief meeting title (e.g., 'Weekly Check-in', 'Onboarding Call')",
    "summary": "2-3 sentence executive summary of the meeting",
    "duration": "Estimated duration if mentioned (e.g., '30 minutes') or 'Not specified'",
    "participants": ["List of all people mentioned or who spoke in the meeting"],
    "topics": ["Main topics discussed in the meeting"],
    "clientSentiment": "positive/neutral/negative/frustrated/excited/concerned",
    "sentimentExplanation": "Brief explanation of why this sentiment was detected",
    "keyPoints": ["Important points discussed - be thorough, list ALL key points"],
    "actionItems": [{"task": "Specific task", "owner": "Person responsible", "dueDate": "If mentioned, otherwise null", "priority": "high/medium/low"}],
    "decisions": ["Any decisions made during the meeting"],
    "concerns": ["Any concerns or issues raised by the client"],
    "followUpNeeded": true,
    "followUpItems": ["Specific follow-up items needed"],
    "riskLevel": "low/medium/high",
    "riskFactors": ["Reasons for the risk level"],
    "importantNotes": ["Critical notes that should be flagged for attention - these will be added to the Notes History"],
    "nextSteps": ["Agreed next steps"],
    "clientRequests": ["Specific requests made by the client"],
    "positiveSignals": ["Any positive indicators about the client relationship"],
    "warningSignals": ["Any warning signs or red flags detected"]
}

Be thorough and extract as much information as possible. If something isn't mentioned, use null or empty array.
Return ONLY the JSON object, no markdown formatting.

TRANSCRIPT:
${transcript}`;

                    const res = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            max_tokens: 2000,
                            messages: [{ role: 'user', content: promptContent }]
                        })
                    });

                    const data = await res.json();

                    if (data.error) {
                        throw new Error(data.error.message || 'API error');
                    }

                    const responseText = data.content?.[0]?.text || '{}';
                    // Extract JSON from response (handle markdown code blocks or text before JSON)
                    let jsonStr = responseText;
                    // Try markdown code blocks first
                    const codeBlockMatch = responseText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                    if (codeBlockMatch) {
                        jsonStr = codeBlockMatch[1];
                    } else {
                        // Find JSON object in text (starts with { ends with })
                        const jsonObjMatch = responseText.match(/\{[\s\S]*\}/);
                        if (jsonObjMatch) {
                            jsonStr = jsonObjMatch[0];
                        }
                    }
                    const parsedSummary = JSON.parse(jsonStr);
                    setSummary(parsedSummary);
                    // Auto-set meeting title if extracted
                    if (parsedSummary.title && !meetingTitle) {
                        setMeetingTitle(parsedSummary.title);
                    }
                } catch (err) {
                    console.error('AI Analysis error:', err);
                    alert('AI Analysis failed: ' + err.message);
                    setSummary({
                        summary: 'Transcript saved (AI analysis failed: ' + err.message + ')',
                        keyPoints: [],
                        actionItems: [],
                        riskLevel: 'medium',
                        importantNotes: [],
                        participants: [],
                        topics: []
                    });
                }
                setProcessing(false);
            };

            const saveMeeting = async () => {
                if (!summary && !transcript.trim()) return;

                const mTitle = meetingTitle || summary?.title || 'Meeting Notes';

                // Store all analysis in ad_performance_notes JSON as a reliable fallback
                const allAnalysis = summary ? JSON.stringify({
                    title: mTitle,
                    summary: summary.summary || null,
                    clientSentiment: summary.clientSentiment || 'neutral',
                    sentimentExplanation: summary.sentimentExplanation || null,
                    keyPoints: summary.keyPoints || [],
                    actionItems: summary.actionItems || [],
                    concerns: summary.concerns || [],
                    riskLevel: summary.riskLevel || 'medium',
                    nextSteps: summary.nextSteps || [],
                    duration: summary.duration || null,
                    participants: summary.participants || [],
                    topics: summary.topics || [],
                    decisions: summary.decisions || [],
                    followUpNeeded: summary.followUpNeeded || false,
                    followUpItems: summary.followUpItems || [],
                    riskFactors: summary.riskFactors || [],
                    clientRequests: summary.clientRequests || [],
                    positiveSignals: summary.positiveSignals || [],
                    warningSignals: summary.warningSignals || [],
                    importantNotes: summary.importantNotes || [],
                    createdByName: getDisplayName(user?.email, user)
                }) : null;

                // Base columns that always exist
                const baseData = {
                    client_name: c.client,
                    meeting_date: meetingDate,
                    meeting_type: mTitle,
                    transcript,
                    summary: summary?.summary || 'Manual entry',
                    ad_performance_notes: allAnalysis,
                    user_email: user?.email,
                    user_id: user?.id
                };

                // Extended columns (require migration)
                const extData = {
                    meeting_title: mTitle,
                    duration: summary?.duration || null,
                    participants: summary?.participants || [],
                    topics: summary?.topics || [],
                    client_sentiment: summary?.clientSentiment || 'neutral',
                    sentiment_explanation: summary?.sentimentExplanation || null,
                    key_points: summary?.keyPoints || [],
                    action_items: summary?.actionItems || [],
                    decisions: summary?.decisions || [],
                    concerns: summary?.concerns || [],
                    follow_up_needed: summary?.followUpNeeded || false,
                    follow_up_items: summary?.followUpItems || [],
                    risk_level: summary?.riskLevel || 'medium',
                    risk_factors: summary?.riskFactors || [],
                    next_steps: summary?.nextSteps || [],
                    client_requests: summary?.clientRequests || [],
                    positive_signals: summary?.positiveSignals || [],
                    warning_signals: summary?.warningSignals || [],
                    created_by_name: getDisplayName(user?.email, user)
                };

                // Try with all columns first, fall back to base-only
                let result = await supabase.from('meeting_notes').insert({ ...baseData, ...extData }).select().single();
                if (result.error) {
                    result = await supabase.from('meeting_notes').insert(baseData).select().single();
                }
                const { data } = result;

                if (data) {
                    setMeetings([data, ...meetings]);

                    // Automatically add important notes to Notes History
                    if (summary?.importantNotes && summary.importantNotes.length > 0) {
                        for (const importantNote of summary.importantNotes) {
                            await addNote(`üìå [From ${meetingTitle || summary?.title || 'Meeting'} on ${meetingDate}] ${importantNote}`, 'ai_extracted');
                        }
                    }

                    // Add high-priority action items as notes
                    const highPriorityActions = (summary?.actionItems || []).filter(a => a.priority === 'high');
                    for (const action of highPriorityActions) {
                        await addNote(`‚ö†Ô∏è HIGH PRIORITY ACTION [${meetingDate}]: ${action.task} (Owner: ${action.owner})`, 'ai_extracted');
                    }

                    // Add concerns as notes if risk level is high
                    if (summary?.riskLevel === 'high' && summary?.concerns?.length > 0) {
                        await addNote(`üö® CLIENT CONCERNS [${meetingDate}]: ${summary.concerns.join('; ')}`, 'ai_extracted');
                    }

                    setTranscript('');
                    setSummary(null);
                    setMeetingTitle('');

                    // Reload notes to show newly added ones
                    loadNotes();
                }

                await supabase.from('activity_log').insert({
                    user_email: user?.email,
                    client_name: c.client,
                    action: 'Added meeting notes',
                    details: `${meetingTitle || summary?.title || 'Meeting'}: ${(summary?.summary || 'Manual entry').substring(0, 100)}`
                });
            };

            const deleteMeeting = async (id) => {
                await supabase.from('meeting_notes').delete().eq('id', id);
                setMeetings(meetings.filter(m => m.id !== id));
                await supabase.from('activity_log').insert({ user_email: user?.email, client_name: c.client, action: 'Deleted meeting record', details: '' });
            };

            if (!c) return <div className="card p-12 text-center text-slate-500">Select a client</div>;

            return (
                <div className="space-y-6">
                    {/* ===== QUICK NOTES SECTION ===== */}
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üìù Quick Notes</h3>
                        <div className="flex gap-3">
                            <input value={newNote} onChange={e => setNewNote(e.target.value)} onKeyPress={e => e.key === 'Enter' && addNote()} placeholder="Add a note..." className="flex-1 bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white" />
                            <button onClick={() => addNote()} className="px-6 py-3 bg-brand-cyan text-dark-900 font-semibold rounded-xl">Add</button>
                        </div>
                    </div>

                    {/* ===== NOTES HISTORY ===== */}
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üìö Notes History</h3>
                        {notes.length === 0 ? <div className="text-slate-500 text-center py-4">No notes yet</div> : (
                            <div className="space-y-3 max-h-[400px] overflow-y-auto scrollbar">
                                {notes.map(n => (
                                    <div key={n.id} className={`p-4 bg-dark-800 rounded-xl group ${n.is_important ? 'border-l-4 border-amber-500' : ''} ${n.source === 'ai_extracted' ? 'bg-gradient-to-r from-dark-800 to-purple-900/20' : ''}`}>
                                        <div className="flex justify-between items-start">
                                            <div className="flex flex-wrap items-center gap-2">
                                                <span className="text-brand-purple text-sm font-medium">{getDisplayName(n.user_email)}</span>
                                                <span className="text-slate-600 text-sm">{new Date(n.created_at).toLocaleString()}</span>
                                                {n.source === 'ai_extracted' && <span className="px-2 py-0.5 bg-purple-500/20 text-purple-400 text-xs rounded">AI Extracted</span>}
                                                {n.is_important && <span className="px-2 py-0.5 bg-amber-500/20 text-amber-400 text-xs rounded">Important</span>}
                                                {n.edited_at && <span className="text-slate-500 text-xs">(edited by {getDisplayName(n.edited_by)} on {new Date(n.edited_at).toLocaleString()})</span>}
                                            </div>
                                            <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={() => startEditNote(n)} className="text-slate-500 hover:text-brand-cyan text-sm">‚úèÔ∏è</button>
                                                <button onClick={() => deleteNote(n.id)} className="text-slate-500 hover:text-red-400 text-sm">‚úï</button>
                                            </div>
                                        </div>
                                        {editingNote === n.id ? (
                                            <div className="mt-3">
                                                <textarea
                                                    value={editNoteText}
                                                    onChange={e => setEditNoteText(e.target.value)}
                                                    className="w-full bg-dark-700 border border-dark-600 rounded-lg p-3 text-white min-h-[80px]"
                                                />
                                                <div className="flex gap-2 mt-2">
                                                    <button onClick={() => saveEditNote(n.id)} className="px-4 py-2 bg-emerald-500/20 text-emerald-400 rounded-lg text-sm">Save</button>
                                                    <button onClick={cancelEditNote} className="px-4 py-2 bg-slate-500/20 text-slate-400 rounded-lg text-sm">Cancel</button>
                                                </div>
                                            </div>
                                        ) : (
                                            <p className="text-white mt-2 whitespace-pre-wrap">{n.note_text}</p>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* ===== MEETING TRANSCRIPT SECTION ===== */}
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üéôÔ∏è Meeting Transcript Summary</h3>
                        <div className="flex flex-wrap gap-4 mb-4">
                            <input type="date" value={meetingDate} onChange={e => setMeetingDate(e.target.value)} className="bg-dark-800 border border-dark-700 rounded-xl px-4 py-2 text-white" />
                            <input
                                type="text"
                                value={meetingTitle}
                                onChange={e => setMeetingTitle(e.target.value)}
                                placeholder="Meeting title (optional - AI will suggest)"
                                className="flex-1 min-w-[200px] bg-dark-800 border border-dark-700 rounded-xl px-4 py-2 text-white"
                            />
                        </div>
                        <textarea value={transcript} onChange={e => setTranscript(e.target.value)} placeholder="Paste transcript from Fathom, Otter, Zoom, etc..." className="w-full bg-dark-800 border border-dark-700 rounded-xl p-4 text-white min-h-[150px]" />
                        <div className="flex flex-wrap gap-3 mt-3">
                            <button onClick={processTranscript} disabled={!transcript.trim() || processing} className="px-6 py-3 bg-gradient-to-r from-brand-cyan to-brand-purple text-white font-semibold rounded-xl disabled:opacity-50 flex items-center gap-2">
                                {processing ? (<><span className="animate-spin">‚öôÔ∏è</span> Analyzing...</>) : 'ü§ñ Analyze with AI'}
                            </button>
                            <button onClick={saveMeeting} disabled={!transcript.trim()} className="px-6 py-3 bg-emerald-500/20 text-emerald-400 rounded-xl disabled:opacity-50">üíæ Save Meeting</button>
                        </div>

                        {/* Enhanced AI Analysis Display */}
                        {summary && (
                            <div className="mt-4 p-5 bg-dark-800 rounded-xl space-y-4">
                                {/* Header with title and sentiment */}
                                <div className="flex flex-wrap items-center justify-between gap-3 pb-3 border-b border-dark-700">
                                    <div>
                                        <h4 className="text-lg font-semibold text-white">{summary.title || 'Meeting Analysis'}</h4>
                                        {summary.duration && <span className="text-slate-400 text-sm">Duration: {summary.duration}</span>}
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {summary.clientSentiment && (
                                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                                ['positive', 'excited'].includes(summary.clientSentiment) ? 'bg-emerald-500/20 text-emerald-400' :
                                                ['negative', 'frustrated'].includes(summary.clientSentiment) ? 'bg-red-500/20 text-red-400' :
                                                summary.clientSentiment === 'concerned' ? 'bg-amber-500/20 text-amber-400' :
                                                'bg-slate-500/20 text-slate-400'
                                            }`}>
                                                {summary.clientSentiment === 'positive' ? 'üòä' : summary.clientSentiment === 'negative' ? 'üòü' : summary.clientSentiment === 'excited' ? 'üéâ' : summary.clientSentiment === 'frustrated' ? 'üò§' : summary.clientSentiment === 'concerned' ? 'üòü' : 'üòê'} {summary.clientSentiment}
                                            </span>
                                        )}
                                        {summary.riskLevel && (
                                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${summary.riskLevel === 'high' ? 'bg-red-500/20 text-red-400' : summary.riskLevel === 'medium' ? 'bg-amber-500/20 text-amber-400' : 'bg-emerald-500/20 text-emerald-400'}`}>
                                                Risk: {summary.riskLevel}
                                            </span>
                                        )}
                                    </div>
                                </div>

                                {/* Summary */}
                                <div>
                                    <span className="text-brand-cyan text-sm font-medium">Summary</span>
                                    <p className="text-white mt-1">{summary.summary}</p>
                                </div>

                                {/* Participants & Topics Row */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {summary.participants?.length > 0 && (
                                        <div>
                                            <span className="text-brand-cyan text-sm font-medium">üë• Participants</span>
                                            <div className="flex flex-wrap gap-2 mt-1">
                                                {summary.participants.map((p, i) => (
                                                    <span key={i} className="px-2 py-1 bg-dark-700 text-slate-300 text-sm rounded">{p}</span>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    {summary.topics?.length > 0 && (
                                        <div>
                                            <span className="text-brand-cyan text-sm font-medium">üìã Topics Discussed</span>
                                            <div className="flex flex-wrap gap-2 mt-1">
                                                {summary.topics.map((t, i) => (
                                                    <span key={i} className="px-2 py-1 bg-brand-purple/20 text-brand-purple text-sm rounded">{t}</span>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Key Points */}
                                {summary.keyPoints?.length > 0 && (
                                    <div>
                                        <span className="text-brand-cyan text-sm font-medium">üîë Key Points</span>
                                        <ul className="mt-1 space-y-1">
                                            {summary.keyPoints.map((kp, i) => <li key={i} className="text-slate-300 text-sm flex items-start gap-2"><span className="text-brand-cyan">‚Ä¢</span> {kp}</li>)}
                                        </ul>
                                    </div>
                                )}

                                {/* Action Items */}
                                {summary.actionItems?.length > 0 && (
                                    <div>
                                        <span className="text-brand-cyan text-sm font-medium">‚úÖ Action Items</span>
                                        <div className="mt-2 space-y-2">
                                            {summary.actionItems.map((ai, i) => (
                                                <div key={i} className={`p-3 rounded-lg ${ai.priority === 'high' ? 'bg-red-500/10 border border-red-500/30' : ai.priority === 'medium' ? 'bg-amber-500/10 border border-amber-500/30' : 'bg-dark-700'}`}>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-white text-sm">{ai.task}</span>
                                                        {ai.priority && <span className={`px-2 py-0.5 text-xs rounded ${ai.priority === 'high' ? 'bg-red-500/20 text-red-400' : ai.priority === 'medium' ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-500/20 text-slate-400'}`}>{ai.priority}</span>}
                                                    </div>
                                                    <div className="flex gap-4 mt-1 text-xs text-slate-400">
                                                        <span>üë§ {ai.owner}</span>
                                                        {ai.dueDate && <span>üìÖ {ai.dueDate}</span>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Decisions */}
                                {summary.decisions?.length > 0 && (
                                    <div>
                                        <span className="text-brand-cyan text-sm font-medium">üéØ Decisions Made</span>
                                        <ul className="mt-1 space-y-1">
                                            {summary.decisions.map((d, i) => <li key={i} className="text-slate-300 text-sm flex items-start gap-2"><span className="text-emerald-400">‚úì</span> {d}</li>)}
                                        </ul>
                                    </div>
                                )}

                                {/* Concerns & Warning Signals */}
                                {(summary.concerns?.length > 0 || summary.warningSignals?.length > 0) && (
                                    <div className="p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                                        <span className="text-red-400 text-sm font-medium">‚ö†Ô∏è Concerns & Warning Signals</span>
                                        <ul className="mt-1 space-y-1">
                                            {summary.concerns?.map((c, i) => <li key={`c-${i}`} className="text-red-300 text-sm">‚Ä¢ {c}</li>)}
                                            {summary.warningSignals?.map((w, i) => <li key={`w-${i}`} className="text-amber-300 text-sm">‚Ä¢ {w}</li>)}
                                        </ul>
                                    </div>
                                )}

                                {/* Positive Signals */}
                                {summary.positiveSignals?.length > 0 && (
                                    <div className="p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-lg">
                                        <span className="text-emerald-400 text-sm font-medium">‚ú® Positive Signals</span>
                                        <ul className="mt-1 space-y-1">
                                            {summary.positiveSignals.map((p, i) => <li key={i} className="text-emerald-300 text-sm">‚Ä¢ {p}</li>)}
                                        </ul>
                                    </div>
                                )}

                                {/* Next Steps */}
                                {summary.nextSteps?.length > 0 && (
                                    <div>
                                        <span className="text-brand-cyan text-sm font-medium">‚û°Ô∏è Next Steps</span>
                                        <ul className="mt-1 space-y-1">
                                            {summary.nextSteps.map((ns, i) => <li key={i} className="text-slate-300 text-sm">{i + 1}. {ns}</li>)}
                                        </ul>
                                    </div>
                                )}

                                {/* Important Notes Alert */}
                                {summary.importantNotes?.length > 0 && (
                                    <div className="p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
                                        <span className="text-amber-400 text-sm font-medium">üìå Important Notes (will be added to Notes History)</span>
                                        <ul className="mt-1 space-y-1">
                                            {summary.importantNotes.map((n, i) => <li key={i} className="text-amber-200 text-sm">‚Ä¢ {n}</li>)}
                                        </ul>
                                    </div>
                                )}

                                {/* Follow-up indicator */}
                                {summary.followUpNeeded && (
                                    <div className="flex items-center gap-2 p-2 bg-brand-purple/20 rounded-lg">
                                        <span className="text-brand-purple">üìû</span>
                                        <span className="text-brand-purple text-sm font-medium">Follow-up Required</span>
                                        {summary.followUpItems?.length > 0 && (
                                            <span className="text-slate-400 text-sm">({summary.followUpItems.join(', ')})</span>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* ===== MEETING HISTORY ===== */}
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üìÖ Meeting History</h3>
                        {meetings.length === 0 ? <div className="text-slate-500 text-center py-4">No meetings recorded</div> : (
                            <div className="space-y-4 max-h-[600px] overflow-y-auto scrollbar">
                                {meetings.map(m => {
                                    const ex = getExtra(m);
                                    const title = safeStr(m.meeting_title || ex.title || m.meeting_type || 'Meeting');
                                    const riskLevel = safeStr(m.risk_level || ex.riskLevel || 'medium');
                                    const sentiment = safeStr(m.client_sentiment || ex.clientSentiment || '');
                                    const participants = pickArr(m.participants, ex.participants);
                                    const topics = pickArr(m.topics, ex.topics);
                                    const keyPoints = pickArr(m.key_points, ex.keyPoints);
                                    const actionItems = pickArr(m.action_items, ex.actionItems);
                                    const decisions = pickArr(m.decisions, ex.decisions);
                                    const concerns = pickArr(m.concerns, m.client_concerns, ex.concerns);
                                    const riskFactors = pickArr(m.risk_factors, ex.riskFactors);
                                    const warningSignals = pickArr(m.warning_signals, ex.warningSignals);
                                    const positiveSignals = pickArr(m.positive_signals, ex.positiveSignals);
                                    const clientRequests = pickArr(m.client_requests, ex.clientRequests);
                                    const nextSteps = pickArr(m.next_steps, ex.nextSteps);
                                    const followUpItems = pickArr(m.follow_up_items, ex.followUpItems);
                                    const duration = m.duration || ex.duration;
                                    const followUpNeeded = m.follow_up_needed || ex.followUpNeeded || false;
                                    const sentimentExplanation = m.sentiment_explanation || ex.sentimentExplanation || '';

                                    return (
                                    <div key={m.id} className={`bg-dark-800 rounded-xl overflow-hidden ${riskLevel === 'high' ? 'border-l-4 border-red-500' : riskLevel === 'medium' ? 'border-l-4 border-amber-500' : 'border-l-4 border-emerald-500'}`}>
                                        {/* Meeting Header - Always Visible */}
                                        <div
                                            className="p-4 cursor-pointer hover:bg-dark-700/50 transition-colors"
                                            onClick={() => setExpandedMeeting(expandedMeeting === m.id ? null : m.id)}
                                        >
                                            <div className="flex flex-wrap justify-between items-start gap-2">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-white font-semibold">{title}</span>
                                                        <span className="text-slate-400 text-sm">{new Date(m.meeting_date).toLocaleDateString()}</span>
                                                    </div>
                                                    <p className="text-slate-400 text-sm mt-1 line-clamp-2">{safeStr(m.summary || ex.summary)}</p>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    {sentiment && (
                                                        <span className={`px-2 py-1 rounded text-xs ${
                                                            ['positive', 'excited'].includes(sentiment) ? 'bg-emerald-500/20 text-emerald-400' :
                                                            ['negative', 'frustrated'].includes(sentiment) ? 'bg-red-500/20 text-red-400' :
                                                            sentiment === 'concerned' ? 'bg-amber-500/20 text-amber-400' :
                                                            'bg-slate-500/20 text-slate-400'
                                                        }`}>{sentiment}</span>
                                                    )}
                                                    <span className={`px-2 py-1 rounded text-xs ${riskLevel === 'high' ? 'bg-red-500/20 text-red-400' : riskLevel === 'medium' ? 'bg-amber-500/20 text-amber-400' : 'bg-emerald-500/20 text-emerald-400'}`}>{riskLevel}</span>
                                                    <span className="text-slate-600 text-xs">‚ñº</span>
                                                </div>
                                            </div>
                                            <div className="flex flex-wrap items-center gap-4 mt-2 text-xs text-slate-500">
                                                <span>üìù Added by: <span className="text-brand-purple">{m.created_by_name || ex.createdByName || getDisplayName(m.user_email)}</span></span>
                                                {duration && <span>‚è±Ô∏è {safeStr(duration)}</span>}
                                                {participants.length > 0 && <span>üë• {participants.length} participants</span>}
                                                {actionItems.length > 0 && <span>‚úÖ {actionItems.length} action items</span>}
                                                {followUpNeeded && <span className="text-amber-400">üìû Follow-up needed</span>}
                                            </div>
                                        </div>

                                        {/* Expanded Meeting Details */}
                                        {expandedMeeting === m.id && (
                                            <div className="p-4 pt-0 border-t border-dark-700 space-y-4">
                                                {/* Participants & Topics */}
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {participants.length > 0 && (
                                                        <div>
                                                            <span className="text-brand-cyan text-xs font-medium">üë• Participants</span>
                                                            <div className="flex flex-wrap gap-1 mt-1">
                                                                {participants.map((p, i) => (
                                                                    <span key={i} className="px-2 py-0.5 bg-dark-700 text-slate-300 text-xs rounded">{safeStr(p)}</span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    {topics.length > 0 && (
                                                        <div>
                                                            <span className="text-brand-cyan text-xs font-medium">üìã Topics</span>
                                                            <div className="flex flex-wrap gap-1 mt-1">
                                                                {topics.map((t, i) => (
                                                                    <span key={i} className="px-2 py-0.5 bg-brand-purple/20 text-brand-purple text-xs rounded">{safeStr(t)}</span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Key Points */}
                                                {keyPoints.length > 0 && (
                                                    <div>
                                                        <span className="text-brand-cyan text-xs font-medium">üîë Key Points</span>
                                                        <ul className="mt-1 space-y-1">
                                                            {keyPoints.map((kp, i) => <li key={i} className="text-slate-300 text-xs">‚Ä¢ {safeStr(kp)}</li>)}
                                                        </ul>
                                                    </div>
                                                )}

                                                {/* Action Items */}
                                                {actionItems.length > 0 && (
                                                    <div>
                                                        <span className="text-brand-cyan text-xs font-medium">‚úÖ Action Items</span>
                                                        <div className="mt-1 space-y-1">
                                                            {actionItems.map((ai, i) => {
                                                                if (typeof ai === 'string') return <div key={i} className="p-2 rounded bg-dark-700 text-slate-300 text-xs">{ai}</div>;
                                                                const item = ai || {};
                                                                return (
                                                                <div key={i} className={`p-2 rounded ${item.priority === 'high' ? 'bg-red-500/10' : item.priority === 'medium' ? 'bg-amber-500/10' : 'bg-dark-700'}`}>
                                                                    <div className="flex items-center justify-between">
                                                                        <span className="text-slate-300 text-xs">{safeStr(item.task || ai)}</span>
                                                                        <div className="flex items-center gap-2">
                                                                            {item.owner && <span className="text-slate-500 text-xs">üë§ {safeStr(item.owner)}</span>}
                                                                            {item.priority && <span className={`px-1.5 py-0.5 text-[10px] rounded ${item.priority === 'high' ? 'bg-red-500/20 text-red-400' : item.priority === 'medium' ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-500/20 text-slate-400'}`}>{item.priority}</span>}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Decisions */}
                                                {decisions.length > 0 && (
                                                    <div>
                                                        <span className="text-brand-cyan text-xs font-medium">üéØ Decisions Made</span>
                                                        <ul className="mt-1 space-y-1">
                                                            {decisions.map((d, i) => <li key={i} className="text-slate-300 text-xs">‚úì {safeStr(d)}</li>)}
                                                        </ul>
                                                    </div>
                                                )}

                                                {/* Concerns & Risk Factors */}
                                                {(concerns.length > 0 || riskFactors.length > 0 || warningSignals.length > 0) && (
                                                    <div className="p-2 bg-red-500/10 rounded">
                                                        <span className="text-red-400 text-xs font-medium">‚ö†Ô∏è Concerns & Risks</span>
                                                        <ul className="mt-1 space-y-0.5">
                                                            {concerns.map((c, i) => <li key={`c-${i}`} className="text-red-300 text-xs">‚Ä¢ {safeStr(c)}</li>)}
                                                            {riskFactors.map((r, i) => <li key={`r-${i}`} className="text-amber-300 text-xs">‚Ä¢ {safeStr(r)}</li>)}
                                                            {warningSignals.map((w, i) => <li key={`w-${i}`} className="text-amber-300 text-xs">‚Ä¢ {safeStr(w)}</li>)}
                                                        </ul>
                                                    </div>
                                                )}

                                                {/* Positive Signals */}
                                                {positiveSignals.length > 0 && (
                                                    <div className="p-2 bg-emerald-500/10 rounded">
                                                        <span className="text-emerald-400 text-xs font-medium">‚ú® Positive Signals</span>
                                                        <ul className="mt-1 space-y-0.5">
                                                            {positiveSignals.map((p, i) => <li key={i} className="text-emerald-300 text-xs">‚Ä¢ {safeStr(p)}</li>)}
                                                        </ul>
                                                    </div>
                                                )}

                                                {/* Client Requests */}
                                                {clientRequests.length > 0 && (
                                                    <div>
                                                        <span className="text-brand-cyan text-xs font-medium">üôã Client Requests</span>
                                                        <ul className="mt-1 space-y-0.5">
                                                            {clientRequests.map((r, i) => <li key={i} className="text-slate-300 text-xs">‚Ä¢ {safeStr(r)}</li>)}
                                                        </ul>
                                                    </div>
                                                )}

                                                {/* Next Steps */}
                                                {nextSteps.length > 0 && (
                                                    <div>
                                                        <span className="text-brand-cyan text-xs font-medium">‚û°Ô∏è Next Steps</span>
                                                        <ul className="mt-1 space-y-0.5">
                                                            {nextSteps.map((ns, i) => <li key={i} className="text-slate-300 text-xs">{i + 1}. {safeStr(ns)}</li>)}
                                                        </ul>
                                                    </div>
                                                )}

                                                {/* Follow-up Items */}
                                                {followUpNeeded && followUpItems.length > 0 && (
                                                    <div className="p-2 bg-brand-purple/10 rounded">
                                                        <span className="text-brand-purple text-xs font-medium">üìû Follow-up Items</span>
                                                        <ul className="mt-1 space-y-0.5">
                                                            {followUpItems.map((f, i) => <li key={i} className="text-slate-300 text-xs">‚Ä¢ {safeStr(f)}</li>)}
                                                        </ul>
                                                    </div>
                                                )}

                                                {/* Full Transcript (Collapsible) */}
                                                {m.transcript && (
                                                    <details className="mt-2">
                                                        <summary className="text-brand-cyan text-xs font-medium cursor-pointer hover:text-brand-purple">üìú View Full Transcript</summary>
                                                        <div className="mt-2 p-3 bg-dark-700 rounded-lg max-h-[200px] overflow-y-auto scrollbar">
                                                            <pre className="text-slate-400 text-xs whitespace-pre-wrap font-sans">{m.transcript}</pre>
                                                        </div>
                                                    </details>
                                                )}

                                                {/* Sentiment Explanation */}
                                                {sentimentExplanation && (
                                                    <div className="text-xs text-slate-500 italic">
                                                        üí≠ Sentiment note: {safeStr(sentimentExplanation)}
                                                    </div>
                                                )}

                                                {/* Delete Button */}
                                                <div className="flex justify-end pt-2 border-t border-dark-700">
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); if (confirm('Delete this meeting record?')) deleteMeeting(m.id); }}
                                                        className="text-xs text-slate-500 hover:text-red-400 transition-colors"
                                                    >
                                                        üóëÔ∏è Delete Meeting
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    {/* ===== ACTIVITY LOG ===== */}
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üìã Activity Log</h3>
                        {activities.length === 0 ? <div className="text-slate-500 text-center py-4">No activity yet</div> : (
                            <div className="space-y-2 max-h-[250px] overflow-y-auto scrollbar">
                                {activities.map(a => (
                                    <div key={a.id} className="p-3 bg-dark-800 rounded-lg flex items-center gap-4">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2">
                                                <span className="text-brand-purple font-medium text-sm">{getDisplayName(a.user_email)}</span>
                                                <span className="text-slate-600 text-xs">{new Date(a.created_at).toLocaleString()}</span>
                                            </div>
                                            <div className="text-slate-400 text-sm">{a.action}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ========== OVERVIEW TAB ==========
        const OverviewTab = ({ clients, setupData, onSelectClient }) => {
            const [expandedSection, setExpandedSection] = useState(null);

            const getSetupInfo = (client) => {
                const name = client.client.toLowerCase().trim();
                return setupData.find(s => { const sn = (s.client||'').toLowerCase().trim(); return sn === name || sn.includes(name) || name.includes(sn); });
            };

            const enriched = clients.map(c => {
                const setup = getSetupInfo(c);
                const health = getHealth(c.cpl);
                const score = getHealthScore(c, setup);
                return { ...c, setup, health, score };
            });

            const struggling = enriched.filter(c => c.health === 'red' && c.days > 7).sort((a,b) => a.score - b.score);
            const doingWell = enriched.filter(c => c.health === 'green' && c.days > 7).sort((a,b) => b.score - a.score);
            const noLeads = enriched.filter(c => c.days >= 3 && c.last3DayLeads === 0).sort((a,b) => a.last7DayLeads - b.last7DayLeads);
            const gettingMoreLeads = enriched.filter(c => c.last3DayLeads > 0 && c.days > 3).sort((a,b) => b.last3DayLeads - a.last3DayLeads);

            // Best performing campaigns
            const campaignMap = {};
            enriched.forEach(c => {
                const name = (c.campaign||'').trim();
                if (!name) return;
                if (!campaignMap[name]) campaignMap[name] = { campaign: name, clients: [], totalLeads: 0, totalSpend: 0, totalAppts: 0, totalDeals: 0 };
                campaignMap[name].clients.push(c.client);
                campaignMap[name].totalLeads += c.leads;
                campaignMap[name].totalSpend += c.spend;
                campaignMap[name].totalAppts += c.appts;
                campaignMap[name].totalDeals += c.deals;
            });
            const campaigns = Object.values(campaignMap)
                .map(cp => ({ ...cp, cpl: cp.totalLeads > 0 ? cp.totalSpend / cp.totalLeads : 0 }))
                .filter(cp => cp.totalLeads > 0)
                .sort((a,b) => a.cpl - b.cpl);

            const totals = enriched.reduce((acc, c) => ({ spend: acc.spend+c.spend, leads: acc.leads+c.leads, appts: acc.appts+c.appts, deals: acc.deals+c.deals }), { spend:0, leads:0, appts:0, deals:0 });
            const avgCpl = totals.leads > 0 ? totals.spend / totals.leads : 0;

            const toggle = (section) => setExpandedSection(expandedSection === section ? null : section);

            const HealthDot = ({ color }) => <span className={`w-2.5 h-2.5 rounded-full inline-block flex-shrink-0 ${healthColors[color]||healthColors.gray}`}></span>;

            const ClientRow = ({ c, metrics }) => (
                <div className="p-4 hover:bg-dark-800 cursor-pointer transition-colors flex items-center justify-between" onClick={() => onSelectClient(c)}>
                    <div className="flex items-center gap-3">
                        <HealthDot color={c.health} />
                        <div>
                            <div className="font-medium text-white">{c.client}</div>
                            <div className="text-xs text-slate-500">{c.state||'‚Äî'} ¬∑ Day {c.days} ¬∑ {c.campaign||'No campaign'}{c.setup?.csmRep ? ` ¬∑ CSM: ${c.setup.csmRep}` : ''}</div>
                        </div>
                    </div>
                    <div className="flex items-center gap-6 text-right">{metrics}</div>
                </div>
            );

            const SectionCard = ({ id, icon, title, titleColor, subtitle, count, countColor, countBg, children, items }) => (
                <div className="card overflow-hidden">
                    <div className="p-4 border-b border-dark-700/50 flex items-center justify-between cursor-pointer hover:bg-dark-800 transition-colors" onClick={() => toggle(id)}>
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">{icon}</span>
                            <div><h3 className={`text-lg font-semibold ${titleColor}`}>{title}</h3><p className="text-xs text-slate-500">{subtitle}</p></div>
                        </div>
                        <div className="flex items-center gap-3">
                            <span className={`${countBg} ${countColor} px-3 py-1 rounded-full text-sm font-bold`}>{count}</span>
                            <span className="text-slate-500">{expandedSection === id ? '‚ñæ' : '‚ñ∏'}</span>
                        </div>
                    </div>
                    {(expandedSection === id || expandedSection === null) && (
                        <div className="divide-y divide-dark-700">
                            {items.length === 0 ? <div className="p-6 text-center text-slate-500 text-sm">{children}</div> : (
                                <>
                                    {items.slice(0, expandedSection === id ? undefined : 5).map(item => item)}
                                    {expandedSection !== id && items.length > 5 && (
                                        <div className="p-3 text-center"><button onClick={(e) => { e.stopPropagation(); toggle(id); }} className="text-brand-cyan text-sm hover:underline">Show all {items.length}</button></div>
                                    )}
                                </>
                            )}
                        </div>
                    )}
                </div>
            );

            return (
                <div className="space-y-6">
                    {/* Summary Stats */}
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div className="card p-4 text-center"><div className="text-3xl font-bold text-white">{enriched.length}</div><div className="text-xs text-slate-400">Total Clients</div></div>
                        <div className="card p-4 text-center"><div className="text-3xl font-bold text-brand-cyan">{fmt(totals.spend)}</div><div className="text-xs text-slate-400">Total Spend</div></div>
                        <div className="card p-4 text-center"><div className="text-3xl font-bold text-brand-purple">{fmtN(totals.leads)}</div><div className="text-xs text-slate-400">Total Leads</div></div>
                        <div className="card p-4 text-center"><div className="text-3xl font-bold text-emerald-400">{fmtN(totals.appts)}</div><div className="text-xs text-slate-400">Total Appts</div></div>
                        <div className="card p-4 text-center"><div className="text-3xl font-bold text-amber-400">{fmtD(avgCpl)}</div><div className="text-xs text-slate-400">Avg CPL</div></div>
                    </div>

                    {/* Health Distribution */}
                    <div className="card overflow-hidden">
                        <div className="p-4 border-b border-dark-700/50"><h3 className="text-lg font-semibold text-white">Client Health Distribution</h3></div>
                        <div className="p-4 grid grid-cols-4 gap-4">
                            {[
                                { label: 'Healthy', color: 'emerald', count: enriched.filter(c => c.health === 'green').length },
                                { label: 'Moderate', color: 'amber', count: enriched.filter(c => c.health === 'yellow').length },
                                { label: 'At Risk', color: 'red', count: enriched.filter(c => c.health === 'red').length },
                                { label: 'New/No Data', color: 'slate', count: enriched.filter(c => c.health === 'gray').length },
                            ].map(item => (
                                <div key={item.label} className="text-center">
                                    <div className={`text-2xl font-bold text-${item.color}-400`}>{item.count}</div>
                                    <div className="text-xs text-slate-400">{item.label}</div>
                                    <div className="mt-2 h-2 rounded-full bg-dark-700 overflow-hidden">
                                        <div className={`h-full bg-${item.color}-500 rounded-full`} style={{ width: `${enriched.length > 0 ? (item.count / enriched.length) * 100 : 0}%` }}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Struggling Clients */}
                    <SectionCard id="struggling" icon="üö®" title="Struggling Clients" titleColor="text-red-400" subtitle="High CPL (>$50), poor performance" count={struggling.length} countColor="text-red-400" countBg="bg-red-500/20"
                        items={struggling.map(c => <ClientRow key={c.client} c={c} metrics={<><div><div className="text-red-400 font-bold">{fmtD(c.cpl)}</div><div className="text-xs text-slate-500">CPL</div></div><div><div className="text-white font-medium">{fmtN(c.leads)}</div><div className="text-xs text-slate-500">Leads</div></div><div><div className="text-white font-medium">{fmtN(c.appts)}</div><div className="text-xs text-slate-500">Appts</div></div></>} />)}>
                        No struggling clients
                    </SectionCard>

                    {/* Doing Well */}
                    <SectionCard id="doingWell" icon="üåü" title="Doing Well" titleColor="text-emerald-400" subtitle="Low CPL (‚â§$25), healthy performance" count={doingWell.length} countColor="text-emerald-400" countBg="bg-emerald-500/20"
                        items={doingWell.map(c => <ClientRow key={c.client} c={c} metrics={<><div><div className="text-emerald-400 font-bold">{fmtD(c.cpl)}</div><div className="text-xs text-slate-500">CPL</div></div><div><div className="text-white font-medium">{fmtN(c.leads)}</div><div className="text-xs text-slate-500">Leads</div></div><div><div className="text-white font-medium">{fmtN(c.deals)}</div><div className="text-xs text-slate-500">Deals</div></div></>} />)}>
                        No clients in healthy range yet
                    </SectionCard>

                    {/* Not Getting Leads */}
                    <SectionCard id="noLeads" icon="üìâ" title="Not Getting Leads" titleColor="text-amber-400" subtitle="0 leads in the last 3 days" count={noLeads.length} countColor="text-amber-400" countBg="bg-amber-500/20"
                        items={noLeads.map(c => <ClientRow key={c.client} c={c} metrics={<><div><div className="text-amber-400 font-bold">0</div><div className="text-xs text-slate-500">3-Day Leads</div></div><div><div className="text-white font-medium">{fmtN(c.last7DayLeads)}</div><div className="text-xs text-slate-500">7-Day Leads</div></div><div><div className="text-white font-medium">{fmt(c.spend)}</div><div className="text-xs text-slate-500">Spend</div></div></>} />)}>
                        All clients getting leads
                    </SectionCard>

                    {/* Getting Leads */}
                    <SectionCard id="gettingLeads" icon="üìà" title="Getting Leads" titleColor="text-cyan-400" subtitle="Active lead generation in last 3 days" count={gettingMoreLeads.length} countColor="text-cyan-400" countBg="bg-cyan-500/20"
                        items={gettingMoreLeads.map(c => <ClientRow key={c.client} c={c} metrics={<><div><div className="text-cyan-400 font-bold">{fmtN(c.last3DayLeads)}</div><div className="text-xs text-slate-500">3-Day Leads</div></div><div><div className="text-white font-medium">{fmtN(c.last7DayLeads)}</div><div className="text-xs text-slate-500">7-Day Leads</div></div><div><div className="text-white font-medium">{fmtD(c.cpl)}</div><div className="text-xs text-slate-500">CPL</div></div></>} />)}>
                        No clients with recent leads
                    </SectionCard>

                    {/* Best Performing Ad Names */}
                    <div className="card overflow-hidden">
                        <div className="p-4 border-b border-dark-700/50">
                            <div className="flex items-center gap-3"><span className="text-2xl">üèÜ</span><div><h3 className="text-lg font-semibold text-brand-purple">Best Performing Ad Names</h3><p className="text-xs text-slate-500">Campaign types ranked by CPL (lowest = best)</p></div></div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-dark-800">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Rank</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Campaign / Ad Name</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Clients</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Leads</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Spend</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">CPL</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Appts</th>
                                        <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Deals</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-dark-700">
                                    {campaigns.length === 0 ? (
                                        <tr><td colSpan="8" className="px-4 py-8 text-center text-slate-500 text-sm">No campaign data available</td></tr>
                                    ) : campaigns.map((cp, i) => (
                                        <tr key={cp.campaign} className="hover:bg-dark-800 transition-colors">
                                            <td className="px-4 py-3">
                                                <span className={`inline-flex items-center justify-center w-7 h-7 rounded-full text-xs font-bold ${i===0 ? 'bg-amber-500/20 text-amber-400' : i===1 ? 'bg-slate-400/20 text-slate-300' : i===2 ? 'bg-orange-500/20 text-orange-400' : 'bg-dark-700 text-slate-500'}`}>{i+1}</span>
                                            </td>
                                            <td className="px-4 py-3"><div className="font-medium text-white">{cp.campaign}</div></td>
                                            <td className="px-4 py-3">
                                                <div className="text-slate-300 text-sm">{cp.clients.length}</div>
                                                <div className="text-xs text-slate-500 truncate max-w-[200px]" title={cp.clients.join(', ')}>{cp.clients.slice(0,3).join(', ')}{cp.clients.length > 3 ? ` +${cp.clients.length-3}` : ''}</div>
                                            </td>
                                            <td className="px-4 py-3 text-right text-brand-purple font-medium">{fmtN(cp.totalLeads)}</td>
                                            <td className="px-4 py-3 text-right text-slate-300">{fmt(cp.totalSpend)}</td>
                                            <td className="px-4 py-3 text-right"><span className={`font-bold ${cp.cpl<=25?'text-emerald-400':cp.cpl<=50?'text-amber-400':'text-red-400'}`}>{fmtD(cp.cpl)}</span></td>
                                            <td className="px-4 py-3 text-right text-slate-300">{fmtN(cp.totalAppts)}</td>
                                            <td className="px-4 py-3 text-right text-emerald-400 font-medium">{fmtN(cp.totalDeals)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== RED FLAGS DASHBOARD ==========
        const RedFlagsTab = ({ clients, setupData, onSelectClient }) => {
            // Helper to get setup info for a client
            const getSetupInfo = (client) => {
                const name = client.client.toLowerCase().trim();
                return setupData.find(s => { 
                    const sn = (s.client || '').toLowerCase().trim(); 
                    return sn === name || sn.includes(name) || name.includes(sn); 
                });
            };

            // Analyze all clients for red flags
            const analyzeClient = (c) => {
                const s = getSetupInfo(c);
                const flags = [];
                
                // Payment Issues
                if (s && s.duePayment && s.duePayment.toUpperCase().includes('OVERDUE')) {
                    flags.push({ type: 'payment', severity: 'high', icon: 'üí≥', text: 'Payment Overdue', detail: s.duePayment });
                }
                
                // No Leads Recently (0 leads in last 3 days for clients running 3+ days)
                if (c.days >= 3 && c.last3DayLeads === 0) {
                    flags.push({ type: 'leads', severity: 'high', icon: 'üìâ', text: 'No Leads (3 Days)', detail: '0 leads in the last 3 days' });
                }
                
                // No Leads in Last 7 Days
                if (c.days >= 7 && c.last7DayLeads === 0) {
                    flags.push({ type: 'leads', severity: 'high', icon: 'üö®', text: 'No Leads (7 Days)', detail: '0 leads in the last 7 days' });
                }
                
                // High CPL (over $50)
                if (c.cpl > 50) {
                    flags.push({ type: 'performance', severity: 'medium', icon: 'üìà', text: 'High CPL', detail: fmtD(c.cpl) + ' (above $50 threshold)' });
                }
                
                // Missing Lead Sync
                if (!c.leadySync || c.leadySync.trim() === '') {
                    flags.push({ type: 'setup', severity: 'medium', icon: 'üîÑ', text: 'Missing Leady Sync', detail: 'Lead sync not configured' });
                }
                
                // Missing Campaign Type
                if (!c.campaign || c.campaign.trim() === '') {
                    flags.push({ type: 'setup', severity: 'low', icon: 'üéØ', text: 'Missing Campaign Type', detail: 'Campaign type not specified' });
                }
                
                // Missing Start Date
                if (!c.startDate || c.startDate.trim() === '') {
                    flags.push({ type: 'setup', severity: 'low', icon: 'üìÖ', text: 'Missing Start Date', detail: 'No start date recorded' });
                }
                
                // Missing State
                if (!c.state || c.state.trim() === '') {
                    flags.push({ type: 'setup', severity: 'low', icon: 'üìç', text: 'Missing State', detail: 'State not specified' });
                }
                
                // No Appointments (for clients with 20+ leads)
                if (c.leads >= 20 && c.appts === 0) {
                    flags.push({ type: 'performance', severity: 'medium', icon: 'üìû', text: 'No Appointments', detail: c.leads + ' leads but 0 appointments' });
                }
                
                // Red Flags from Setup Timing
                if (s && s.redFlags && s.redFlags.trim() !== '') {
                    flags.push({ type: 'manual', severity: 'high', icon: 'üö©', text: 'Manual Red Flag', detail: s.redFlags });
                }
                
                // Missing from Setup Timing
                if (!s) {
                    flags.push({ type: 'setup', severity: 'low', icon: 'üìã', text: 'Not in Setup Timing', detail: 'Client not found in Setup Timing sheet' });
                }
                
                return flags;
            };

            // Get all clients with their flags
            const clientsWithFlags = clients.map(c => ({
                client: c,
                setup: getSetupInfo(c),
                flags: analyzeClient(c)
            })).filter(c => c.flags.length > 0);

            // Sort by severity (high first, then by number of flags)
            clientsWithFlags.sort((a, b) => {
                const aHigh = a.flags.filter(f => f.severity === 'high').length;
                const bHigh = b.flags.filter(f => f.severity === 'high').length;
                if (aHigh !== bHigh) return bHigh - aHigh;
                return b.flags.length - a.flags.length;
            });

            // Count by severity
            const highCount = clientsWithFlags.filter(c => c.flags.some(f => f.severity === 'high')).length;
            const mediumCount = clientsWithFlags.filter(c => c.flags.some(f => f.severity === 'medium') && !c.flags.some(f => f.severity === 'high')).length;
            const lowCount = clientsWithFlags.filter(c => !c.flags.some(f => f.severity === 'high') && !c.flags.some(f => f.severity === 'medium')).length;

            // Count by type
            const paymentIssues = clientsWithFlags.filter(c => c.flags.some(f => f.type === 'payment')).length;
            const leadIssues = clientsWithFlags.filter(c => c.flags.some(f => f.type === 'leads')).length;
            const setupIssues = clientsWithFlags.filter(c => c.flags.some(f => f.type === 'setup')).length;
            const perfIssues = clientsWithFlags.filter(c => c.flags.some(f => f.type === 'performance')).length;

            const severityColors = {
                high: 'bg-red-500/20 border-red-500/50 text-red-400',
                medium: 'bg-amber-500/20 border-amber-500/50 text-amber-400',
                low: 'bg-slate-500/20 border-slate-500/50 text-slate-400'
            };

            return (
                <div className="space-y-6">
                    {/* Summary Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="card p-4 border-l-4 border-red-500">
                            <div className="text-3xl font-bold text-red-400">{highCount}</div>
                            <div className="text-xs text-slate-400">Critical Issues</div>
                        </div>
                        <div className="card p-4 border-l-4 border-amber-500">
                            <div className="text-3xl font-bold text-amber-400">{mediumCount}</div>
                            <div className="text-xs text-slate-400">Warnings</div>
                        </div>
                        <div className="card p-4 border-l-4 border-slate-500">
                            <div className="text-3xl font-bold text-slate-400">{lowCount}</div>
                            <div className="text-xs text-slate-400">Minor Issues</div>
                        </div>
                        <div className="card p-4 border-l-4 border-emerald-500">
                            <div className="text-3xl font-bold text-emerald-400">{clients.length - clientsWithFlags.length}</div>
                            <div className="text-xs text-slate-400">Healthy Clients</div>
                        </div>
                    </div>

                    {/* Issue Type Breakdown */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="card p-4 flex items-center gap-3">
                            <span className="text-2xl">üí≥</span>
                            <div><div className="text-xl font-bold text-white">{paymentIssues}</div><div className="text-xs text-slate-400">Payment Issues</div></div>
                        </div>
                        <div className="card p-4 flex items-center gap-3">
                            <span className="text-2xl">üìâ</span>
                            <div><div className="text-xl font-bold text-white">{leadIssues}</div><div className="text-xs text-slate-400">Lead Issues</div></div>
                        </div>
                        <div className="card p-4 flex items-center gap-3">
                            <span className="text-2xl">‚öôÔ∏è</span>
                            <div><div className="text-xl font-bold text-white">{setupIssues}</div><div className="text-xs text-slate-400">Setup Issues</div></div>
                        </div>
                        <div className="card p-4 flex items-center gap-3">
                            <span className="text-2xl">üìä</span>
                            <div><div className="text-xl font-bold text-white">{perfIssues}</div><div className="text-xs text-slate-400">Performance Issues</div></div>
                        </div>
                    </div>

                    {/* Client List with Flags */}
                    <div className="card">
                        <div className="p-4 border-b border-dark-700">
                            <h3 className="text-lg font-semibold text-white">üö© Clients Needing Attention ({clientsWithFlags.length})</h3>
                        </div>
                        <div className="divide-y divide-dark-700">
                            {clientsWithFlags.length === 0 ? (
                                <div className="p-8 text-center text-slate-500">
                                    <span className="text-4xl">‚úÖ</span>
                                    <p className="mt-2">No red flags detected! All clients look healthy.</p>
                                </div>
                            ) : (
                                clientsWithFlags.map(({ client, setup, flags }) => (
                                    <div 
                                        key={client.client} 
                                        className="p-4 hover:bg-dark-800 cursor-pointer transition-colors"
                                        onClick={() => onSelectClient(client)}
                                    >
                                        <div className="flex items-start justify-between mb-2">
                                            <div>
                                                <div className="font-semibold text-white">{client.client}</div>
                                                <div className="text-xs text-slate-500">
                                                    {client.state || 'No state'} ‚Ä¢ Day {client.days} ‚Ä¢ {fmtN(client.leads)} leads ‚Ä¢ {fmtD(client.cpl)} CPL
                                                    {setup && setup.csmRep && ' ‚Ä¢ CSM: ' + setup.csmRep}
                                                </div>
                                            </div>
                                            <div className="flex gap-1">
                                                {flags.some(f => f.severity === 'high') && <span className="px-2 py-1 text-xs rounded bg-red-500/20 text-red-400">Critical</span>}
                                                {flags.some(f => f.severity === 'medium') && !flags.some(f => f.severity === 'high') && <span className="px-2 py-1 text-xs rounded bg-amber-500/20 text-amber-400">Warning</span>}
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {flags.map((flag, i) => (
                                                <div 
                                                    key={i} 
                                                    className={'px-2 py-1 rounded border text-xs ' + severityColors[flag.severity]}
                                                    title={flag.detail}
                                                >
                                                    {flag.icon} {flag.text}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // ========== CLIENT TIMELINE TAB ==========
        const ClientTimelineTab = ({ clients, setupData }) => {
            const [searchFilter, setSearchFilter] = useState('');
            const [filterUrgency, setFilterUrgency] = useState('');
            const [filterCsm, setFilterCsm] = useState('');

            const getUrgency = (daysLeft) => {
                if (daysLeft <= 30) return 'red';
                if (daysLeft <= 90) return 'yellow';
                return 'green';
            };

            const urgencyConfig = {
                red: { row: 'bg-red-500/10 border-l-4 border-red-500', badge: 'bg-red-500/20 text-red-400 border border-red-500/40', text: 'text-red-400', label: 'Urgent', dot: 'bg-red-500' },
                yellow: { row: 'bg-amber-500/10 border-l-4 border-amber-500', badge: 'bg-amber-500/20 text-amber-400 border border-amber-500/40', text: 'text-amber-400', label: 'Upcoming', dot: 'bg-amber-500' },
                green: { row: 'border-l-4 border-transparent', badge: 'bg-emerald-500/20 text-emerald-400', text: 'text-emerald-400', label: 'Safe', dot: 'bg-emerald-500' },
            };

            // Build renewal data from setup sheet using "Days left for end of Contract" and "Contract End Date"
            const renewalData = [];
            setupData.forEach(setup => {
                const daysLeftVal = pn(setup.daysLeftForEndOfContract);
                const clientName = setup.client || '';
                // Skip clients with no contract end data
                if (!daysLeftVal && daysLeftVal !== 0 && !setup.daysLeftForEndOfContract) return;
                const adsClient = clients.find(c => {
                    const cn = c.client.toLowerCase().trim();
                    const sn = clientName.toLowerCase().trim();
                    return cn === sn || cn.includes(sn) || sn.includes(cn);
                });
                renewalData.push({
                    client: clientName,
                    daysLeft: daysLeftVal,
                    contractEndDate: setup.contractEndDate || '',
                    contractLength: setup.contractLength || '',
                    contractCategory: setup.contractCategory || '',
                    csmRep: setup.csmRep || '',
                    mrr: setup.mrr || '',
                    status: adsClient?.status || setup.status || '',
                    duePayment: setup.duePayment || '',
                    state: adsClient?.state || setup.state || '',
                    campaign: adsClient?.campaign || setup.campaign || '',
                    urgency: getUrgency(daysLeftVal),
                });
            });
            renewalData.sort((a, b) => a.daysLeft - b.daysLeft);

            // Get unique CSMs for filter
            const csmOptions = [...new Set(renewalData.map(d => d.csmRep).filter(Boolean))].sort();

            // Apply filters
            const filtered = renewalData.filter(d => {
                const matchesSearch = !searchFilter ||
                    d.client.toLowerCase().includes(searchFilter.toLowerCase()) ||
                    d.csmRep.toLowerCase().includes(searchFilter.toLowerCase()) ||
                    d.state.toLowerCase().includes(searchFilter.toLowerCase());
                const matchesUrgency = !filterUrgency || d.urgency === filterUrgency;
                const matchesCsm = !filterCsm || d.csmRep === filterCsm;
                return matchesSearch && matchesUrgency && matchesCsm;
            });

            const urgentCount = renewalData.filter(d => d.urgency === 'red').length;
            const upcomingCount = renewalData.filter(d => d.urgency === 'yellow').length;
            const safeCount = renewalData.filter(d => d.urgency === 'green').length;

            const clearFilters = () => { setSearchFilter(''); setFilterUrgency(''); setFilterCsm(''); };
            const hasFilters = filterUrgency || filterCsm || searchFilter;

            return (
                <div className="space-y-6">
                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="card rounded-2xl p-6 text-center">
                            <div className="text-3xl font-bold text-white">{renewalData.length}</div>
                            <div className="text-xs text-slate-400 mt-1">Total Contracts</div>
                        </div>
                        <div className={'card rounded-2xl p-6 text-center cursor-pointer ' + (filterUrgency === 'red' ? 'ring-2 ring-red-500' : '')} onClick={() => setFilterUrgency(filterUrgency === 'red' ? '' : 'red')}>
                            <div className="text-3xl font-bold text-red-400">{urgentCount}</div>
                            <div className="text-xs text-slate-400 mt-1">Renewing Within 1 Month</div>
                            <div className="mt-2 h-1.5 rounded-full bg-dark-700 overflow-hidden">
                                <div className="h-full bg-red-500 rounded-full" style={{width: `${renewalData.length > 0 ? (urgentCount / renewalData.length) * 100 : 0}%`}}></div>
                            </div>
                        </div>
                        <div className={'card rounded-2xl p-6 text-center cursor-pointer ' + (filterUrgency === 'yellow' ? 'ring-2 ring-amber-500' : '')} onClick={() => setFilterUrgency(filterUrgency === 'yellow' ? '' : 'yellow')}>
                            <div className="text-3xl font-bold text-amber-400">{upcomingCount}</div>
                            <div className="text-xs text-slate-400 mt-1">Renewing Within 3 Months</div>
                            <div className="mt-2 h-1.5 rounded-full bg-dark-700 overflow-hidden">
                                <div className="h-full bg-amber-500 rounded-full" style={{width: `${renewalData.length > 0 ? (upcomingCount / renewalData.length) * 100 : 0}%`}}></div>
                            </div>
                        </div>
                        <div className={'card rounded-2xl p-6 text-center cursor-pointer ' + (filterUrgency === 'green' ? 'ring-2 ring-emerald-500' : '')} onClick={() => setFilterUrgency(filterUrgency === 'green' ? '' : 'green')}>
                            <div className="text-3xl font-bold text-emerald-400">{safeCount}</div>
                            <div className="text-xs text-slate-400 mt-1">Safe (3+ Months)</div>
                            <div className="mt-2 h-1.5 rounded-full bg-dark-700 overflow-hidden">
                                <div className="h-full bg-emerald-500 rounded-full" style={{width: `${renewalData.length > 0 ? (safeCount / renewalData.length) * 100 : 0}%`}}></div>
                            </div>
                        </div>
                    </div>

                    {/* Visual Timeline Bar */}
                    <div className="card rounded-2xl">
                        <div className="p-4 border-b border-dark-700">
                            <h3 className="text-lg font-semibold text-white">Renewal Timeline</h3>
                            <p className="text-xs text-slate-500 mt-1">Visual overview of contract renewals sorted by urgency</p>
                        </div>
                        <div className="p-4">
                            <div className="flex items-center gap-6 mb-4 text-xs text-slate-400">
                                <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-red-500"></span> Within 1 month</div>
                                <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-amber-500"></span> Within 3 months</div>
                                <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-emerald-500"></span> 3+ months away</div>
                            </div>
                            <div className="space-y-2 max-h-[300px] overflow-y-auto scrollbar">
                                {renewalData.map(d => {
                                    const cfg = urgencyConfig[d.urgency];
                                    const barWidth = Math.min(100, Math.max(2, (d.daysLeft / 365) * 100));
                                    return (
                                        <div key={d.client} className="flex items-center gap-3">
                                            <div className="w-40 truncate text-sm text-slate-300 flex-shrink-0" title={d.client}>{d.client}</div>
                                            <div className="flex-1 h-6 bg-dark-700 rounded-full overflow-hidden relative">
                                                <div className={'h-full rounded-full ' + cfg.dot} style={{width: `${barWidth}%`}}></div>
                                                <span className="absolute inset-0 flex items-center justify-center text-xs font-medium text-white/80">{d.daysLeft} days</span>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* Search and Filters */}
                    <div className="card rounded-2xl p-4 space-y-3">
                        <div className="flex items-center gap-3">
                            <input type="text" value={searchFilter} onChange={e => setSearchFilter(e.target.value)} placeholder="Search by client, CSM, or state..." className="w-72 input-field border rounded-xl px-3 py-2 text-sm" />
                            {hasFilters && <button onClick={clearFilters} className="px-3 py-2 rounded-lg bg-red-500/10 border border-red-500/30 text-red-400 text-xs font-medium hover:bg-red-500/20">Clear Filters</button>}
                            {hasFilters && <span className="text-xs text-slate-500">Showing {filtered.length} of {renewalData.length}</span>}
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div>
                                <label className="block text-xs text-slate-500 mb-1">Urgency</label>
                                <select value={filterUrgency} onChange={e => setFilterUrgency(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-lg px-3 py-2 text-sm text-white">
                                    <option value="">All</option>
                                    <option value="red">Urgent (within 1 month)</option>
                                    <option value="yellow">Upcoming (within 3 months)</option>
                                    <option value="green">Safe (3+ months)</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs text-slate-500 mb-1">CSM Rep</label>
                                <select value={filterCsm} onChange={e => setFilterCsm(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-lg px-3 py-2 text-sm text-white">
                                    <option value="">All</option>
                                    {csmOptions.map(csm => <option key={csm} value={csm}>{csm}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Detailed Table */}
                    <div className="card rounded-2xl">
                        <div className="p-4 border-b border-dark-700">
                            <h3 className="text-lg font-semibold text-white">All Client Renewals</h3>
                            <p className="text-xs text-slate-500 mt-1">Sorted by days remaining (most urgent first)</p>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-dark-800">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Client</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Days Left</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Contract End</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Urgency</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">CSM Rep</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Contract</th>
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">MRR</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Status</th>
                                        <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Payment</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-dark-700">
                                    {filtered.length === 0 ? (
                                        <tr><td colSpan={9} className="px-4 py-8 text-center text-slate-500 text-sm">No clients match the current filters</td></tr>
                                    ) : filtered.map(d => {
                                        const cfg = urgencyConfig[d.urgency];
                                        const isOverdue = d.daysLeft <= 0;
                                        return (
                                            <tr key={d.client} className={cfg.row + ' hover:bg-dark-800/50 transition-colors'}>
                                                <td className="px-4 py-3">
                                                    <div className="font-medium text-white">{d.client}</div>
                                                    <div className="text-xs text-slate-500">{d.state || '‚Äî'}{d.campaign ? ` ¬∑ ${d.campaign}` : ''}</div>
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <span className={'text-lg font-bold ' + cfg.text}>{isOverdue ? 'OVERDUE' : d.daysLeft}</span>
                                                    {!isOverdue && <div className="text-xs text-slate-500">days</div>}
                                                </td>
                                                <td className="px-4 py-3 text-center text-sm text-slate-300">{d.contractEndDate || '‚Äî'}</td>
                                                <td className="px-4 py-3 text-center">
                                                    <span className={'inline-block px-2.5 py-1 rounded-full text-xs font-bold ' + cfg.badge}>{isOverdue ? 'OVERDUE' : cfg.label}</span>
                                                </td>
                                                <td className="px-4 py-3 text-sm text-slate-300">{d.csmRep || '‚Äî'}</td>
                                                <td className="px-4 py-3 text-sm text-slate-300">{d.contractLength ? d.contractLength + ' mo' : '‚Äî'}</td>
                                                <td className="px-4 py-3 text-sm text-brand-cyan font-medium">{d.mrr || '‚Äî'}</td>
                                                <td className="px-4 py-3 text-center">
                                                    <span className={'px-2 py-0.5 rounded-full text-xs font-medium ' + ((d.status||'').toLowerCase() === 'active' ? 'bg-emerald-500/20 text-emerald-400' : (d.status||'').toLowerCase() === 'paused' ? 'bg-red-500/20 text-red-400' : 'bg-slate-500/20 text-slate-400')}>{d.status || '‚Äî'}</span>
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    {d.duePayment ? <span className={'px-2 py-0.5 rounded-full text-xs font-medium ' + (d.duePayment.includes('OVERDUE') ? 'bg-red-500/20 text-red-400' : 'bg-slate-500/20 text-slate-400')}>{d.duePayment}</span> : <span className="text-slate-500">‚Äî</span>}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== MAIN APP ==========
        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [clients, setClients] = useState([]);
            const [setupData, setSetupData] = useState([]);
            const [selected, setSelected] = useState(null);
            const [tab, setTab] = useState('overview');
            const [loading, setLoading] = useState(true);
            const [theme, setTheme] = useState('dark');

            // Theme toggle function
            const toggleTheme = () => {
                const newTheme = theme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                document.body.className = 'min-h-screen ' + newTheme;
            };

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => { setUser(session?.user || null); setAuthLoading(false); });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => setUser(session?.user || null));
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const params = new URLSearchParams(window.location.search);
                const clientParam = params.get('client');
                
                // Try to load from cache first for instant display
                const cachedClients = localStorage.getItem('vam_clients');
                const cachedSetup = localStorage.getItem('vam_setup');
                const cacheTime = localStorage.getItem('vam_cache_time');
                const cacheAge = cacheTime ? Date.now() - parseInt(cacheTime) : Infinity;
                
                // Use cache if less than 5 minutes old
                if (cachedClients && cachedSetup && cacheAge < 300000) {
                    const c = JSON.parse(cachedClients);
                    const s = JSON.parse(cachedSetup);
                    setClients(c);
                    setSetupData(s);
                    if (clientParam) { 
                        const found = c.find(x => x.client.toLowerCase() === decodeURIComponent(clientParam).toLowerCase()); 
                        if (found) setSelected(found); 
                    }
                    setLoading(false);
                    // Still fetch fresh data in background
                    fetchFreshData(clientParam, false);
                } else {
                    // No cache or expired, fetch fresh
                    fetchFreshData(clientParam, true);
                }
            }, [user]);

            const fetchFreshData = (clientParam, updateLoading) => {
                Promise.all([
                    // Client Ads Performance - headers in row 2, skip row 1
                    fetch(URLS.clientAdsPerformance).then(r => r.text()).then(csv => {
                        const lines = csv.split('\n');
                        const newCsv = [lines[1], ...lines.slice(2)].join('\n');
                        return Papa.parse(newCsv, { header: true, skipEmptyLines: true }).data.map(mapClient).filter(r => r.client);
                    }),
                    // Setup Timing - headers in row 1, skip row 2
                    fetch(URLS.setupTiming).then(r => r.text()).then(csv => { 
                        const lines = csv.split('\n'); 
                        return Papa.parse([lines[0], ...lines.slice(2)].join('\n'), { header: true, skipEmptyLines: true }).data.map(mapSetupTiming).filter(r => r.client); 
                    })
                ]).then(([c, s]) => {
                    // Save to cache
                    localStorage.setItem('vam_clients', JSON.stringify(c));
                    localStorage.setItem('vam_setup', JSON.stringify(s));
                    localStorage.setItem('vam_cache_time', Date.now().toString());
                    
                    setClients(c); 
                    setSetupData(s);
                    if (clientParam) { 
                        const found = c.find(x => x.client.toLowerCase() === decodeURIComponent(clientParam).toLowerCase()); 
                        if (found) setSelected(found); 
                    }
                    if (updateLoading) setLoading(false);
                });
            };

            const getSetupInfo = (client) => {
                if (!client) return null;
                const name = client.client.toLowerCase().trim();
                return setupData.find(s => { const sn = (s.client || '').toLowerCase().trim(); return sn === name || sn.includes(name) || name.includes(sn) || name.split(' ').filter(p => p.length > 2).some(p => sn.includes(p)); });
            };

            // Show loading only while checking auth status
            if (authLoading) return <div className="min-h-screen flex items-center justify-center px-8"><div className="max-w-2xl text-center"><p className="text-2xl md:text-4xl font-bold text-white leading-relaxed">"The only work that matters is the work that no one sees. It shows who you really are rather than who you say you are."</p><p className="mt-6 text-lg font-semibold text-brand-purple">‚Äî Alex Hormozi</p><div className="mt-8 w-full h-1 bg-dark-700 rounded-full overflow-hidden"><div className="h-full rounded-full bg-gradient-to-r from-brand-cyan to-brand-purple loading-bar"></div></div></div></div>;
            // Show login page if not authenticated
            if (!user) return <LoginPage onLogin={setUser} />;
            // Show loading while fetching data (only for authenticated users)
            if (loading) return <div className="min-h-screen flex items-center justify-center px-8"><div className="max-w-2xl text-center"><p className="text-2xl md:text-4xl font-bold text-white leading-relaxed">"The only work that matters is the work that no one sees. It shows who you really are rather than who you say you are."</p><p className="mt-6 text-lg font-semibold text-brand-purple">‚Äî Alex Hormozi</p><div className="mt-8 w-full h-1 bg-dark-700 rounded-full overflow-hidden"><div className="h-full rounded-full bg-gradient-to-r from-brand-cyan to-brand-purple loading-bar"></div></div></div></div>;

            const s = getSetupInfo(selected);

            // Check if selected client exists in ads performance data
            const isMissingFromAdsSheet = selected ? false : false; // Will be set properly below

            const renderTab = () => {
                switch (tab) {
                    case 'overview': return <OverviewTab clients={clients} setupData={setupData} onSelectClient={(c) => { setSelected(c); setTab('health'); }} />;
                    case 'redflags': return <RedFlagsTab clients={clients} setupData={setupData} onSelectClient={(c) => { setSelected(c); setTab('health'); }} />;
                    case 'health': return <ClientHealthTab c={selected} s={s} isMissingFromAdsSheet={false} />;
                    case 'notes': return <NotesActivityTab c={selected} />;
                    case 'timeline': return <ClientTimelineTab clients={clients} setupData={setupData} />;
                    default: return <OverviewTab clients={clients} setupData={setupData} onSelectClient={(c) => { setSelected(c); setTab('health'); }} />;
                }
            };

            return (
                <AuthContext.Provider value={{ user }}>
                    <ThemeContext.Provider value={{ theme, toggleTheme }}>
                        <div className="flex min-h-screen">
                            <aside className="w-72 sidebar border-r flex flex-col divider">
                                <div className="p-5 border-b divider">
                                    <h1 className="text-xl font-bold bg-gradient-to-r from-brand-cyan to-brand-purple bg-clip-text text-transparent">VAM Client Success Hub</h1>
                                    <div className="flex items-center gap-2 mt-2"><div className="w-2 h-2 bg-emerald-500 rounded-full"></div><span className="text-xs text-secondary">{getDisplayName(user.email, user)}</span></div>
                                </div>
                                <div className="p-4">
                                    <select value={selected ? selected.client : ''} onChange={e => setSelected(clients.find(c => c.client === e.target.value))} className="w-full input-field border rounded-xl px-4 py-3 text-sm">
                                        <option value="">Select a client...</option>
                                        {clients.map(c => <option key={c.client} value={c.client}>{c.client}</option>)}
                                    </select>
                                </div>
                                <nav className="py-2">
                                    {tabs.map(t => (
                                        <button key={t.id} onClick={() => setTab(t.id)} className={'w-full flex items-start gap-3 px-5 py-3 text-left ' + (tab === t.id ? 'tab-active text-primary' : 'text-secondary hover-bg')}>
                                            <span className="text-lg">{t.icon}</span>
                                            <div><div className="text-sm font-medium">{t.name}</div><div className="text-xs text-muted">{t.desc}</div></div>
                                        </button>
                                    ))}
                                </nav>
                            
                            {/* Client Comparison Section */}
                            <div className="flex-1 overflow-y-auto border-t border-dark-700">
                                <div className="p-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase mb-3">All Clients</h3>
                                    <div className="space-y-1 max-h-[400px] overflow-y-auto scrollbar">
                                        {setupData.map(setup => {
                                            const inAdsPerf = clients.some(c => {
                                                const cn = c.client.toLowerCase().trim();
                                                const sn = setup.client.toLowerCase().trim();
                                                return cn === sn || cn.includes(sn) || sn.includes(cn);
                                            });
                                            const adsClient = clients.find(c => {
                                                const cn = c.client.toLowerCase().trim();
                                                const sn = setup.client.toLowerCase().trim();
                                                return cn === sn || cn.includes(sn) || sn.includes(cn);
                                            });
                                            return (
                                                <div 
                                                    key={setup.client}
                                                    onClick={() => { if (adsClient) setSelected(adsClient); }}
                                                    className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm cursor-pointer transition-colors ${
                                                        selected && adsClient && selected.client === adsClient.client 
                                                            ? 'bg-brand-cyan/20 text-white' 
                                                            : inAdsPerf 
                                                                ? 'hover:bg-dark-800 text-slate-300' 
                                                                : 'hover:bg-dark-800 text-slate-500'
                                                    }`}
                                                >
                                                    <span className={`w-2 h-2 rounded-full flex-shrink-0 ${inAdsPerf ? 'bg-emerald-500' : 'bg-red-500'}`}></span>
                                                    <span className="truncate flex-1">{setup.client}</span>
                                                    {!inAdsPerf && <span className="text-xs text-red-400">Missing</span>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div className="mt-3 pt-3 border-t border-dark-700 text-xs text-slate-500">
                                        <div className="flex items-center gap-2 mb-1"><span className="w-2 h-2 rounded-full bg-emerald-500"></span> In Ads Performance</div>
                                        <div className="flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-red-500"></span> Missing from Ads</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="p-4 border-t border-dark-700 space-y-2">
                                <a href="dashboard.html" className="block w-full text-center py-2 bg-dark-800 hover:bg-dark-700 text-slate-300 rounded-lg text-sm">‚Üí Media Buyer Overview</a>
                                <button onClick={() => supabase.auth.signOut()} className="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg text-sm">Logout</button>
                            </div>
                        </aside>
                        <main className="flex-1 flex flex-col">
                            <header className="header-bar backdrop-blur border-b px-8 py-4 flex items-center justify-between divider">
                                <div>
                                    {selected ? (
                                        <div className="flex items-center gap-4">
                                            <h2 className="text-xl font-bold text-primary">{selected.client}</h2>
                                            <span className={'px-3 py-1 rounded-full text-sm ' + getHealthColor(getHealthScore(selected, s)).text + ' bg-dark-800'}>{getHealthColor(getHealthScore(selected, s)).label}</span>
                                            <span className="text-secondary">Day {selected.days}</span>
                                            {s && s.csmRep && <span className="text-brand-purple text-sm">CSM: {s.csmRep}</span>}
                                            {s && s.mrr && <span className="text-emerald-400 text-sm">MRR: {s.mrr}</span>}
                                        </div>
                                    ) : (
                                        <h2 className="text-xl text-secondary">{tab === 'overview' ? 'üìä Overview' : tab === 'redflags' ? 'üö© Red Flags Dashboard' : tab === 'timeline' ? 'üìÖ Renewals Timeline' : 'Select a client to get started'}</h2>
                                    )}
                                </div>
                                <button 
                                    onClick={toggleTheme}
                                    className="flex items-center gap-2 px-4 py-2 rounded-lg bg-dark-800 hover:bg-dark-700 transition-colors text-sm"
                                >
                                    {theme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark'}
                                </button>
                            </header>
                            <div className="flex-1 overflow-y-auto p-8 scrollbar">{renderTab()}</div>
                        </main>
                    </div>
                </ThemeContext.Provider>
                </AuthContext.Provider>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
