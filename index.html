<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAM Client Success Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 950: '#030712', 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569' },
                        brand: { cyan: '#06b6d4', purple: '#8b5cf6', blue: '#3b82f6' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #030712; color: #f1f5f9; }
        .card { background: #0f172a; border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; }
        .tab-active { background: linear-gradient(135deg, rgba(6,182,212,0.15), rgba(139,92,246,0.15)); border-left: 3px solid #06b6d4; }
        .scrollbar::-webkit-scrollbar { width: 4px; }
        .scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        .section-title { font-size: 0.75rem; font-weight: 600; color: #8b5cf6; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;

        const SUPABASE_URL = 'https://ecmhhonjazfbletyvncw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjbWhob25qYXpmYmxldHl2bmN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDMwMjYsImV4cCI6MjA4MTUxOTAyNn0.3LZ8dAOX_ZpoUNkgY_jSeC10SaCknfPfBaZsDRjFt7c';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const AuthContext = createContext(null);
        const useAuth = () => useContext(AuthContext);

        const URLS = {
            clientAdsPerformance: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4LTw-15NE0j25eIOpY_bTPSAipW7-F2eXnL0xtdXMWCZtK9z3MYWxHr6ltnMChLk-YDLzwiXAfvwE/pub?gid=964722332&single=true&output=csv',
            setupTiming: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4LTw-15NE0j25eIOpY_bTPSAipW7-F2eXnL0xtdXMWCZtK9z3MYWxHr6ltnMChLk-YDLzwiXAfvwE/pub?gid=646836237&single=true&output=csv'
        };

        const pn = v => parseFloat(String(v||'0').replace(/[$,%]/g,'').replace(/,/g,''))||0;
        const fmt = v => '$'+(pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});
        const fmtD = v => '$'+(pn(v)).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        const fmtN = v => (pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});
        const fmtP = v => (pn(v)).toFixed(1)+'%';
        const clean = v => (v && v.toString().trim()) ? v.toString().trim() : '‚Äî';
        const getDisplayName = (email, user) => {
            // First try to get full_name from user metadata
            if (user?.user_metadata?.full_name) return user.user_metadata.full_name;
            if (user?.user_metadata?.name) return user.user_metadata.name;
            // Fall back to email parsing
            return email ? email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : 'Unknown';
        };

        // Map Client Ads Performance sheet - headers in row 2 (A2:BA2)
        const mapClient = r => {
            const sellerLeads = pn(r['Lifetime Seller Leads']);
            const buyerLeads = pn(r['Lifetime Buyer Leads']);
            const listingLeads = pn(r['Listing Leads']);
            const totalLeads = sellerLeads + buyerLeads + listingLeads;
            const spend = pn(r['Total Ad Spend']);
            const sellerAppts7 = pn(r['Seller Appts in the Last 7 Days']);
            const buyerAppts7 = pn(r['Buyer Appts in the Last 7 Days']);
            
            return {
                client: r['Client']||'', 
                adAccount: r['Ad Account Name']||'',
                dailySetAdSpend: pn(r['Daily Set Ad Spend']),
                state: r['State']||'', 
                campaign: r['CAMPAIGN']||'',
                callingStatus: r['Calling/Non-calling']||'',
                startDate: r['CORRECT SETUP TIMING START DATE']||r['OLD Start Date']||'',
                leadySync: r['Leady Sync']||'',
                months: pn(r['Months Running']),
                weeks: pn(r['Weeks Running']),
                days: pn(r['Days Running']),
                spend: spend, 
                spendPerMonth: pn(r['Ad Spend Per Month']),
                spendPerDay: pn(r['Ad Spend Per Day']),
                // Last 3 Days - Seller
                last3DaySellerLeads: pn(r['Last 3 Day Seller Leads']),
                last3DaySellerSpend: pn(r['Last 3 Days Seller Ad Spend']),
                last3DaySellerCPL: pn(r['Last 3 Days Seller CPL']),
                // Last 7 Days - Seller
                last7DaySellerLeads: pn(r['Last 7 Day Seller Leads']),
                last7DaySellerSpend: pn(r['Last 7 Day Seller Spend']),
                last7DaySellerCPL: pn(r['Last 7 Days Seller CPL']),
                // Lifetime - Seller
                sellerLeads: sellerLeads,
                sellerSpend: pn(r['Lifetime Seller Ad Spend']),
                sellerCPL: pn(r['Lifetime Seller CPL']),
                // Last 3 Days - Buyer
                last3DayBuyerLeads: pn(r['Last 3 Day Buyer Leads']),
                last3DayBuyerSpend: pn(r['Last 3 Days Buyer Ad Spend']),
                last3DayBuyerCPL: pn(r['Last 3 Days Buyer CPL']),
                // Last 7 Days - Buyer
                last7DayBuyerLeads: pn(r['Last 7 Day Buyer Leads']),
                last7DayBuyerSpend: pn(r['Last 7 Day Buyer Spend']),
                last7DayBuyerCPL: pn(r['Last 7 Days Buyer CPL']),
                // Lifetime - Buyer
                buyerLeads: buyerLeads,
                buyerSpend: pn(r['Lifetime Buyer Ad Spend']),
                buyerCPL: pn(r['Lifetime Buyer CPL']),
                // Other lead types
                listingLeads: listingLeads,
                mortgageLeads: pn(r['Mortgage Leads']),
                agentAttraction: pn(r['Agent Attraction']),
                // Appointments
                appts: pn(r['Total Appts (Seller + Buyers)']),
                sellerAppts: pn(r['Total Seller Appts']),
                sellerAppts7: sellerAppts7,
                avgSellerApptsWeek: pn(r['Avg Seller Appts per Week']),
                sellerLeadToAppt: pn(r['Seller Lead To Appt Ratio']),
                costPerSellerAppt: pn(r['Total Ad Spend Cost Per Seller Appts']),
                buyerAppts: pn(r['Total Buyer Appts']),
                buyerAppts7: buyerAppts7,
                avgBuyerApptsWeek: pn(r['Avg Buyer Appts per Week']),
                buyerLeadToAppt: pn(r['Buyer Lead To Appt Ratio']),
                costPerBuyerAppt: pn(r['Ad Spend Cost Per Buyer Appts']),
                // Deals
                deals: pn(r['Potential Deals']),
                listings: pn(r['Listing']),
                buyerSigned: pn(r['Buyer Signed']),
                leadsPerListing: pn(r['Leads/Listing']),
                leadsPerDeal: pn(r['Leads/Potential Deal']),
                leadsPerSignedBuyer: pn(r['Leads/Signed Buyer']),
                // Computed totals
                leads: totalLeads,
                cpl: totalLeads > 0 ? spend / totalLeads : 0,
                appts7: sellerAppts7 + buyerAppts7,
                last3DayLeads: pn(r['Last 3 Day Seller Leads']) + pn(r['Last 3 Day Buyer Leads']),
                last7DayLeads: pn(r['Last 7 Day Seller Leads']) + pn(r['Last 7 Day Buyer Leads'])
            };
        };

        // Full setup timing mapping
        const mapSetupTiming = r => ({
            client: r['VAM'] || '', csmRep: r['CSM'] || '', lastForm: r['Last Form'] || '', lastFormDate: r['Date'] || '',
            status: r['Status'] || '', concern: r['Concern'] || '', referral: r['Referral'] || '', testimonial: r['Testmonial'] || '',
            lender: r['Status_1'] || '', state: r['State'] || '', campaign: r['Campaign'] || '', contractCategory: r['Contract Category'] || '',
            spanish: r['Spanish'] || '', mrr: r['MRR'] || '', fulfilled: r['Fullfilled'] || '', info: r['Info'] || '',
            daysLeft: r['Days left'] || '', duePayment: r['Due Payment'] || '', lastCsmNote: r['Last CSM Rep - Note - date'] || '',
            upcomingCsmDate: r['upcoming CSM rep - date'] || '', paidDate: r['Paid date'] || '', onboardedDate: r['Onboarded date'] || '',
            launchCallDate: r['Launch call date'] || '', adLiveDate: r[' Ad Live date'] || r['Ad Live date'] || '',
            billingCycle: r['Billing cycle'] || '', freeTrialDays: r['Free trial Days'] || '', adsOnPauseDays: r['ADs on pause total days'] || '',
            closings: r['Closings'] || '', signed: r['Signed'] || '', appts: r[' Appts '] || r['Appts'] || '',
            behindSchedule: r['Behind schedule'] || '', missing: r['Missing'] || '', shuPercent: r['SHU%'] || '',
            calling: r['Calling'] || '', dialer: r['Dialer'] || '', sLeads: r['S Leads'] || '', bLeads: r['B Leads'] || '',
            cpl: r['CPL'] || '', cpa: r['CPA'] || '', sAppts: r['(S)appts'] || '', bAppts: r['(B)appts'] || '',
            shu: r['SHU'] || '', ns: r['NS'] || '', stageOnCrm: r['Stage on CRM'] || '', timezone: r['Timezone'] || '',
            onboardingRep: r['Rep'] || '', redFlags: r['Red flags'] || '', crmFees: r['CRM Fees'] || '',
            adSpendFees: r['ad spend fees'] || '', responsiveness: r['Responsivness'] || '', leadGenExp: r['Lead gen exp'] || '',
            callingExpectations: r['Calling expectaions'] || '', fathom1: r['Fathom'] || '', adsOnPauseDaysDetail: r['ads on pause days'] || '',
            adAccountName: r['Ad Account name'] || '', adSpend: r['Ad Spend'] || '', radius: r['radius'] || '',
            city: r['City'] || '', target: r['Target'] || '', launch: r['Launch'] || '', adsRep: r['Rep'] || '',
            readiness: r['Readiness'] || '', personality: r['Personality'] || '', expectations: r['Expectations'] || '',
            unresolvedConcerns: r['Unresolved Concerns'] || '', firstCheckin: r['1st Check-in'] || '', firstCsm: r['1st CSM'] || '',
            revenueContracted: r['Revenue Contracted'] || '', contractLength: r['Contract length'] || '',
            moPaymentsCollected: r['mo payments collected'] || '', billingAdjust: r['Billing adjust'] || '',
            platform: r['Platform'] || '', nameEmail: r['Name/email'] || '', contractNotes: r['contract notes'] || '',
            paymentNotes: r['Payment notes'] || '', amountCollected: r['Amount collected'] || '', b2b: r['B2B'] || '',
            closedOn: r['Closed on'] || '', commission: r['commision'] || '', setterCloser: r['Setter & Closer'] || '',
        });

        const getHealthScore = (c, s) => {
            if (!c) return 0;
            let score = 50;
            if (c.cpl <= 15) score += 25; else if (c.cpl <= 25) score += 20; else if (c.cpl <= 35) score += 10; else if (c.cpl <= 50) score += 5;
            if (c.appts7 >= 5) score += 15; else if (c.appts7 >= 3) score += 10; else if (c.appts7 >= 1) score += 5;
            if (c.deals > 0 || c.listings > 0) score += 10;
            if (s?.duePayment?.includes('OVERDUE')) score -= 15;
            if (s?.redFlags) score -= 10;
            return Math.max(0, Math.min(100, score));
        };

        const getHealthColor = (score) => {
            if (score >= 80) return { text: 'text-emerald-400', bg: 'bg-emerald-500', label: 'Healthy' };
            if (score >= 60) return { text: 'text-amber-400', bg: 'bg-amber-500', label: 'Needs Attention' };
            return { text: 'text-red-400', bg: 'bg-red-500', label: 'At Risk' };
        };

        // UPDATED TABS - Removed "Weekly Updates" and "GHL Help"
        const tabs = [
            { id: 'health', name: 'Client Health', icon: '‚ù§Ô∏è', desc: 'Overview of client status and metrics' },
            { id: 'scripts', name: 'Call Scripts', icon: 'üìû', desc: 'Phone scripts for different scenarios' },
            { id: 'livehelp', name: 'Live Call Help', icon: 'üéß', desc: 'Real-time support during client calls' },
            { id: 'strategy', name: 'Strategy', icon: 'üéØ', desc: 'Bottleneck identification and action planning' },
            { id: 'save', name: 'Save the Client', icon: 'üö®', desc: 'Intervention playbooks for at-risk clients' },
            { id: 'notes', name: 'Notes & Activity', icon: 'üìù', desc: 'Notes, meetings, and activity log' },
        ];

        // ========== LOGIN ==========
        const LoginPage = ({ onLogin }) => {
            const [isSignUp, setIsSignUp] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [fullName, setFullName] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setSuccess('');
                
                try {
                    if (isSignUp) {
                        // Sign up new user
                        const result = await supabase.auth.signUp({ 
                            email, 
                            password,
                            options: {
                                data: {
                                    full_name: fullName,
                                    name: fullName
                                }
                            }
                        });
                        if (result.error) throw result.error;
                        
                        // Check if email confirmation is required
                        if (result.data?.user?.identities?.length === 0) {
                            setError('This email is already registered. Please sign in instead.');
                        } else {
                            setSuccess('Account created! Please check your email to confirm, then sign in.');
                            setIsSignUp(false);
                        }
                    } else {
                        // Sign in existing user
                        const result = await supabase.auth.signInWithPassword({ email, password });
                        if (result.error) throw result.error;
                        onLogin(result.data.user);
                    }
                } catch (err) { 
                    setError(err.message); 
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="card p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold bg-gradient-to-r from-brand-cyan to-brand-purple bg-clip-text text-transparent">VAM Client Success Hub</h1>
                            <p className="text-slate-500 mt-2">{isSignUp ? 'Create your account' : 'Sign in to continue'}</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {isSignUp && (
                                <input 
                                    type="text" 
                                    value={fullName} 
                                    onChange={e => setFullName(e.target.value)} 
                                    className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white" 
                                    placeholder="Full Name" 
                                    required 
                                />
                            )}
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white" placeholder="Email" required />
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white" placeholder="Password" required minLength={6} />
                            {error && <div className="p-3 rounded-xl bg-red-500/10 text-red-400 text-sm">{error}</div>}
                            {success && <div className="p-3 rounded-xl bg-emerald-500/10 text-emerald-400 text-sm">{success}</div>}
                            <button type="submit" disabled={loading} className="w-full py-3 bg-gradient-to-r from-brand-cyan to-brand-purple text-white font-semibold rounded-xl">
                                {loading ? (isSignUp ? 'Creating Account...' : 'Signing in...') : (isSignUp ? 'Create Account' : 'Sign In')}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button 
                                onClick={() => { setIsSignUp(!isSignUp); setError(''); setSuccess(''); }} 
                                className="text-brand-cyan hover:text-brand-purple text-sm transition-colors"
                            >
                                {isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== DATA ROW & SECTION COMPONENTS ==========
        const DataRow = ({label, value, highlight, color}) => {
            const displayVal = clean(value);
            const isEmpty = displayVal === '‚Äî';
            return (
                <div className="flex justify-between items-center py-1.5">
                    <span className="text-slate-400 text-sm">{label}</span>
                    <span className={`text-sm font-medium ${isEmpty ? 'text-slate-600' : highlight ? (color || 'text-brand-cyan') : 'text-white'}`}>{displayVal}</span>
                </div>
            );
        };

        const Section = ({title, children, cols = 1}) => (
            <div className="card p-5">
                <div className="section-title">{title}</div>
                <div className={cols === 2 ? 'grid md:grid-cols-2 gap-x-6' : ''}>{children}</div>
            </div>
        );

        // ========== CLIENT HEALTH TAB - FULL DETAILS ==========
        const ClientHealthTab = ({ c, s, isMissingFromAdsSheet }) => {
            if (!c && !isMissingFromAdsSheet) return <div className="card p-12 text-center text-slate-500">Select a client to view details</div>;
            
            // If client is missing from Ads Performance sheet
            if (isMissingFromAdsSheet) {
                return (
                    <div className="space-y-6">
                        <div className="card p-8 border-l-4 border-purple-500">
                            <div className="flex items-center gap-4 mb-4">
                                <span className="text-4xl">üìã</span>
                                <div>
                                    <h3 className="text-xl font-bold text-purple-400">Missing from Client Ads Performance Sheet</h3>
                                    <p className="text-slate-400">This client needs to be added to the Client Ads Performance tracking sheet.</p>
                                </div>
                            </div>
                            <div className="bg-purple-500/10 rounded-xl p-4 mt-4">
                                <p className="text-white font-medium mb-2">Action Required:</p>
                                <ol className="text-slate-300 space-y-1 text-sm">
                                    <li>1. Open the Client Ads Performance Google Sheet</li>
                                    <li>2. Add a new row for this client</li>
                                    <li>3. Fill in their ad account details and metrics</li>
                                    <li>4. Refresh this dashboard to see their data</li>
                                </ol>
                            </div>
                        </div>
                        {s && (
                            <Section title="üìã Available Info from Setup Timing">
                                <DataRow label="CSM Rep" value={s?.csmRep} highlight color="text-brand-purple"/>
                                <DataRow label="Status" value={s?.status}/>
                                <DataRow label="MRR" value={s?.mrr} highlight color="text-emerald-400"/>
                                <DataRow label="Due Payment" value={s?.duePayment}/>
                            </Section>
                        )}
                    </div>
                );
            }

            const score = getHealthScore(c, s);
            const color = getHealthColor(score);

            return (
                <div className="space-y-6">
                    {/* Quick Stats */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="card p-4 border-l-4 border-brand-cyan"><div className="text-2xl font-bold text-white">{fmt(c.spend)}</div><div className="text-xs text-slate-400">Total Spend</div></div>
                        <div className="card p-4 border-l-4 border-brand-cyan"><div className="text-2xl font-bold text-brand-cyan">{fmtN(c.leads)}</div><div className="text-xs text-slate-400">Total Leads</div></div>
                        <div className="card p-4 border-l-4 border-brand-purple"><div className="text-2xl font-bold text-white">{fmtD(c.cpl)}</div><div className="text-xs text-slate-400">Cost Per Lead</div></div>
                        <div className="card p-4 border-l-4 border-brand-purple"><div className="text-2xl font-bold text-brand-purple">{fmtN(c.appts)}</div><div className="text-xs text-slate-400">Appointments</div></div>
                    </div>

                    {/* Last 3 Days / Last 7 Days Performance */}
                    <div className="grid md:grid-cols-2 gap-6">
                        <div className="card p-5 border-l-4 border-amber-500">
                            <div className="section-title">üìä Last 3 Days</div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><div className="text-2xl font-bold text-white">{fmtN(c.last3DaySellerLeads + c.last3DayBuyerLeads)}</div><div className="text-xs text-slate-400">Leads</div></div>
                                <div><div className="text-2xl font-bold text-brand-cyan">{fmtD(c.last3DaySellerCPL || c.last3DayBuyerCPL || 0)}</div><div className="text-xs text-slate-400">CPL</div></div>
                            </div>
                        </div>
                        <div className="card p-5 border-l-4 border-brand-cyan">
                            <div className="section-title">üìà Last 7 Days</div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><div className="text-2xl font-bold text-white">{fmtN(c.last7DaySellerLeads + c.last7DayBuyerLeads)}</div><div className="text-xs text-slate-400">Leads</div></div>
                                <div><div className="text-2xl font-bold text-brand-cyan">{fmtD(c.last7DaySellerCPL || c.last7DayBuyerCPL || 0)}</div><div className="text-xs text-slate-400">CPL</div></div>
                            </div>
                        </div>
                    </div>

                    {/* Alerts */}
                    {(s?.duePayment?.includes('OVERDUE') || s?.redFlags || s?.unresolvedConcerns || (c.last3DaySellerLeads + c.last3DayBuyerLeads === 0 && c.days >= 3)) && (
                        <div className="space-y-2">
                            {(c.last3DaySellerLeads + c.last3DayBuyerLeads === 0 && c.days >= 3) && <div className="p-4 rounded-xl bg-amber-500/10 border border-amber-500/20"><span className="text-amber-400 font-semibold">‚ö†Ô∏è NO LEADS IN LAST 3 DAYS</span> <span className="text-slate-300 ml-2">Check ad account status</span></div>}
                            {s?.duePayment?.includes('OVERDUE') && <div className="p-4 rounded-xl bg-red-500/10 border border-red-500/20"><span className="text-red-400 font-semibold">üí≥ PAYMENT OVERDUE</span></div>}
                            {s?.redFlags && <div className="p-4 rounded-xl bg-red-500/10 border border-red-500/20"><span className="text-red-400 font-semibold">üö© Red Flags:</span> <span className="text-slate-300 ml-2">{s.redFlags}</span></div>}
                            {s?.unresolvedConcerns && <div className="p-4 rounded-xl bg-amber-500/10 border border-amber-500/20"><span className="text-amber-400 font-semibold">‚ö†Ô∏è Concerns:</span> <span className="text-slate-300 ml-2">{s.unresolvedConcerns}</span></div>}
                        </div>
                    )}

                    {/* CSM & Status */}
                    <div className="grid lg:grid-cols-2 gap-6">
                        <Section title="üë§ CSM & Status">
                            <DataRow label="CSM Rep" value={s?.csmRep} highlight color="text-brand-purple"/>
                            <DataRow label="Status" value={s?.status}/>
                            <DataRow label="Concern" value={s?.concern}/>
                            <DataRow label="Referral" value={s?.referral}/>
                            <DataRow label="Testimonial" value={s?.testimonial}/>
                            <DataRow label="Lender" value={s?.lender}/>
                            <DataRow label="Last CSM Note" value={s?.lastCsmNote}/>
                            <DataRow label="Upcoming CSM Date" value={s?.upcomingCsmDate}/>
                        </Section>

                        <Section title="üìã Client Details">
                            <DataRow label="State" value={s?.state || c.state}/>
                            <DataRow label="Campaign" value={s?.campaign || c.campaign}/>
                            <DataRow label="Contract Category" value={s?.contractCategory} highlight/>
                            <DataRow label="MRR" value={s?.mrr} highlight color="text-emerald-400"/>
                            <DataRow label="Fulfilled" value={s?.fulfilled} highlight color="text-emerald-400"/>
                            <DataRow label="Days Left" value={s?.daysLeft} highlight color={pn(s?.daysLeft) < 0 ? 'text-red-400' : 'text-brand-cyan'}/>
                            <DataRow label="Due Payment" value={s?.duePayment} highlight color={s?.duePayment?.includes('OVERDUE') ? 'text-red-400' : 'text-emerald-400'}/>
                            <DataRow label="Spanish" value={s?.spanish}/>
                        </Section>
                    </div>

                    {/* Key Dates */}
                    <Section title="üìÖ Key Dates">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="bg-dark-800 rounded-xl p-4 text-center"><div className="text-2xl mb-1">üí∞</div><div className="text-lg font-bold text-white">{clean(s?.paidDate)}</div><div className="text-xs text-slate-400">Paid</div></div>
                            <div className="bg-dark-800 rounded-xl p-4 text-center"><div className="text-2xl mb-1">üöÄ</div><div className="text-lg font-bold text-white">{clean(s?.onboardedDate)}</div><div className="text-xs text-slate-400">Onboarded</div></div>
                            <div className="bg-dark-800 rounded-xl p-4 text-center"><div className="text-2xl mb-1">üìû</div><div className="text-lg font-bold text-white">{clean(s?.launchCallDate)}</div><div className="text-xs text-slate-400">Launch Call</div></div>
                            <div className="bg-dark-800 rounded-xl p-4 text-center"><div className="text-2xl mb-1">üì¢</div><div className="text-lg font-bold text-white">{clean(s?.adLiveDate)}</div><div className="text-xs text-slate-400">Ads Live</div></div>
                        </div>
                    </Section>

                    {/* Seller Performance */}
                    <Section title="üè† Seller Performance" cols={2}>
                        <DataRow label="Lifetime Seller Leads" value={fmtN(c.sellerLeads)} highlight color="text-brand-cyan"/>
                        <DataRow label="Lifetime Seller CPL" value={fmtD(c.sellerCPL)} highlight/>
                        <DataRow label="Last 7 Day Seller Leads" value={fmtN(c.last7DaySellerLeads)}/>
                        <DataRow label="Last 7 Day Seller CPL" value={fmtD(c.last7DaySellerCPL)}/>
                        <DataRow label="Last 3 Day Seller Leads" value={fmtN(c.last3DaySellerLeads)}/>
                        <DataRow label="Last 3 Day Seller CPL" value={fmtD(c.last3DaySellerCPL)}/>
                        <DataRow label="Seller Appts (Total)" value={fmtN(c.sellerAppts)} highlight color="text-brand-purple"/>
                        <DataRow label="Seller Appts (7 Days)" value={fmtN(c.sellerAppts7)}/>
                        <DataRow label="Avg Seller Appts/Week" value={c.avgSellerApptsWeek?.toFixed(1)}/>
                        <DataRow label="Seller Lead‚ÜíAppt Ratio" value={fmtP(c.sellerLeadToAppt)}/>
                        <DataRow label="Cost Per Seller Appt" value={fmtD(c.costPerSellerAppt)}/>
                    </Section>

                    {/* Buyer Performance */}
                    <Section title="üõí Buyer Performance" cols={2}>
                        <DataRow label="Lifetime Buyer Leads" value={fmtN(c.buyerLeads)} highlight color="text-brand-cyan"/>
                        <DataRow label="Lifetime Buyer CPL" value={fmtD(c.buyerCPL)} highlight/>
                        <DataRow label="Last 7 Day Buyer Leads" value={fmtN(c.last7DayBuyerLeads)}/>
                        <DataRow label="Last 7 Day Buyer CPL" value={fmtD(c.last7DayBuyerCPL)}/>
                        <DataRow label="Last 3 Day Buyer Leads" value={fmtN(c.last3DayBuyerLeads)}/>
                        <DataRow label="Last 3 Day Buyer CPL" value={fmtD(c.last3DayBuyerCPL)}/>
                        <DataRow label="Buyer Appts (Total)" value={fmtN(c.buyerAppts)} highlight color="text-brand-purple"/>
                        <DataRow label="Buyer Appts (7 Days)" value={fmtN(c.buyerAppts7)}/>
                        <DataRow label="Avg Buyer Appts/Week" value={c.avgBuyerApptsWeek?.toFixed(1)}/>
                        <DataRow label="Buyer Lead‚ÜíAppt Ratio" value={fmtP(c.buyerLeadToAppt)}/>
                        <DataRow label="Cost Per Buyer Appt" value={fmtD(c.costPerBuyerAppt)}/>
                    </Section>

                    {/* Other Leads & Deals */}
                    <div className="grid lg:grid-cols-2 gap-6">
                        <Section title="üìä Other Leads">
                            <DataRow label="Listing Leads" value={fmtN(c.listingLeads)} highlight/>
                            <DataRow label="Mortgage Leads" value={fmtN(c.mortgageLeads)}/>
                            <DataRow label="Agent Attraction" value={fmtN(c.agentAttraction)}/>
                        </Section>

                        <Section title="üéØ Deals & Conversions">
                            <DataRow label="Potential Deals" value={fmtN(c.deals)} highlight color="text-emerald-400"/>
                            <DataRow label="Listings" value={fmtN(c.listings)} highlight color="text-amber-400"/>
                            <DataRow label="Buyer Signed" value={fmtN(c.buyerSigned)} highlight color="text-emerald-400"/>
                            <DataRow label="Leads/Listing" value={c.leadsPerListing?.toFixed(1)}/>
                            <DataRow label="Leads/Potential Deal" value={c.leadsPerDeal?.toFixed(1)}/>
                            <DataRow label="Leads/Signed Buyer" value={c.leadsPerSignedBuyer?.toFixed(1)}/>
                        </Section>
                    </div>

                    {/* Ad Account Info */}
                    <Section title="üì¢ Ad Account & Spend" cols={2}>
                        <DataRow label="Ad Account" value={c.adAccount} highlight/>
                        <DataRow label="Daily Set Ad Spend" value={fmtD(c.dailySetAdSpend)}/>
                        <DataRow label="Total Ad Spend" value={fmt(c.spend)} highlight color="text-brand-cyan"/>
                        <DataRow label="Ad Spend Per Month" value={fmt(c.spendPerMonth)}/>
                        <DataRow label="Ad Spend Per Day" value={fmtD(c.spendPerDay)}/>
                        <DataRow label="Days Running" value={c.days}/>
                        <DataRow label="Weeks Running" value={c.weeks}/>
                        <DataRow label="Months Running" value={c.months}/>
                        <DataRow label="Calling Status" value={c.callingStatus}/>
                        <DataRow label="Leady Sync" value={c.leadySync}/>
                    </Section>

                    {/* Performance from Setup Timing */}
                    <div className="grid lg:grid-cols-2 gap-6">
                        <Section title="üìä Performance (Setup Timing)">
                            <DataRow label="Closings" value={s?.closings} highlight color="text-emerald-400"/>
                            <DataRow label="Signed" value={s?.signed} highlight color="text-emerald-400"/>
                            <DataRow label="SHU%" value={s?.shuPercent}/>
                            <DataRow label="Behind Schedule" value={s?.behindSchedule}/>
                            <DataRow label="Missing" value={s?.missing}/>
                        </Section>

                        <Section title="üìû Calling & Leads (Setup Timing)">
                            <DataRow label="Calling" value={s?.calling}/>
                            <DataRow label="Dialer" value={s?.dialer}/>
                            <DataRow label="S Leads" value={s?.sLeads} highlight color="text-brand-cyan"/>
                            <DataRow label="B Leads" value={s?.bLeads} highlight color="text-brand-cyan"/>
                            <DataRow label="CPL" value={s?.cpl}/>
                            <DataRow label="CPA" value={s?.cpa}/>
                        </Section>
                    </div>

        // ========== CALL SCRIPTS TAB ==========
        const CallScriptsTab = ({ c, s }) => {
            const scripts = [
                { name: 'Check-In Call', icon: 'üìû', content: `Hi ${c?.client || '[Client]'}, this is [Your Name] from Veriad Marketing! How are you doing today?\n\n[Wait for response]\n\nGreat! I wanted to check in and see how things are going with your leads. Have you been able to connect with any of them this week?\n\n[Listen and take notes]\n\nThat's great to hear! Let me pull up your account... I can see you've gotten ${c?.leads || 'X'} leads so far with a CPL of ${fmtD(c?.cpl || 0)}.\n\n[If good CPL]: Your cost per lead is looking really solid!\n[If high CPL]: I noticed your CPL is a bit higher than we'd like. Let me look into optimizing your campaigns.\n\nAny questions for me?` },
                { name: 'Concern/Complaint Call', icon: 'üòü', content: `Hi ${c?.client || '[Client]'}, thank you for reaching out. I understand you have some concerns and I want to make sure we address them properly.\n\nCan you tell me more about what's been happening?\n\n[Listen carefully, don't interrupt]\n\nI really appreciate you sharing that with me. I can understand how that would be frustrating.\n\nHere's what I'd like to do:\n1. [Immediate action you can take]\n2. [Follow-up action]\n3. [Timeline for resolution]\n\nDoes that sound like a good plan?` },
                { name: 'Lead Quality Issue', icon: 'üéØ', content: `Hi ${c?.client || '[Client]'}, I wanted to follow up on the lead quality feedback you shared.\n\nI've reviewed your recent leads and here's what I found:\n- Total leads: ${c?.leads || 'X'}\n- Seller leads: ${c?.sellerLeads || 'X'}\n- Buyer leads: ${c?.buyerLeads || 'X'}\n\nA few questions to help me optimize:\n1. What percentage of leads are answering when you call?\n2. Are they motivated sellers/buyers?\n3. What's your typical follow-up process?\n\n[Based on answers, suggest optimization]` },
                { name: 'Upsell/Expansion', icon: 'üìà', content: `Hi ${c?.client || '[Client]'}, I've been looking at your results and I'm really impressed!\n\nYou've generated ${c?.leads || 'X'} leads and ${c?.appts || 'X'} appointments. That's a ${fmtP(c?.sellerLeadToAppt || 0)} conversion rate!\n\nI wanted to discuss an opportunity to scale your success. Have you considered:\n- Adding buyer leads to your campaign?\n- Expanding to additional zip codes?\n- Increasing your daily budget?\n\nWhat do you think would help you close more deals?` },
            ];

            return (
                <div className="space-y-4">
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-2">üìû Call Scripts</h3>
                        <p className="text-slate-400 text-sm">Phone scripts customized for {c?.client || 'your client'}. Click to expand.</p>
                    </div>
                    {scripts.map((script, i) => (
                        <details key={i} className="card">
                            <summary className="p-4 cursor-pointer flex items-center gap-3 hover:bg-dark-800 rounded-xl">
                                <span className="text-xl">{script.icon}</span>
                                <span className="font-medium text-white">{script.name}</span>
                            </summary>
                            <div className="p-4 pt-0 border-t border-dark-700">
                                <pre className="whitespace-pre-wrap text-sm text-slate-300 font-sans leading-relaxed">{script.content}</pre>
                                <button onClick={() => navigator.clipboard.writeText(script.content)} className="mt-4 px-4 py-2 bg-brand-cyan/20 text-brand-cyan rounded-lg text-sm">üìã Copy Script</button>
                            </div>
                        </details>
                    ))}
                </div>
            );
        };

        // ========== LIVE CALL HELP TAB ==========
        const LiveCallHelpTab = ({ c, s }) => {
            const [situation, setSituation] = useState('');
            const [response, setResponse] = useState('');
            const [loading, setLoading] = useState(false);

            const quickResponses = [
                { q: 'Client says leads are bad', a: 'I understand your concern. Let me ask: How quickly are you calling these leads? Studies show calling within 5 minutes increases contact rate by 400%. Also, are you using the scripts we provided?' },
                { q: 'Client wants to cancel', a: 'I hear you, and I want to make sure we find the right solution. Before we discuss cancellation, can you help me understand what specific results you were hoping for?' },
                { q: 'Client not answering leads', a: 'Try: 1) Call within 5 minutes, 2) Try different times of day, 3) Send a text first, 4) Follow up at least 6-8 times.' },
                { q: 'CPL is too high', a: `Your CPL is ${fmtD(c?.cpl || 0)}. We can: 1) Review targeting, 2) Test new creative, 3) Adjust budget, 4) Check landing page.` },
            ];

            const getAIHelp = async () => {
                if (!situation.trim()) return;
                setLoading(true);
                try {
                    const res = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 500,
                            messages: [{ role: 'user', content: `You're a CSM helping on a live call. Client: ${c?.client}, ${c?.leads} leads, ${fmtD(c?.cpl)} CPL, ${c?.appts} appts. Help with: "${situation}". Brief, practical response.` }]
                        })
                    });
                    const data = await res.json();
                    setResponse(data.content?.[0]?.text || 'Could not generate response.');
                } catch { setResponse('AI unavailable. Try quick responses below.'); }
                setLoading(false);
            };

            return (
                <div className="space-y-6">
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üéß Live Call Help</h3>
                        <textarea value={situation} onChange={e => setSituation(e.target.value)} placeholder="Describe the situation..." className="w-full bg-dark-800 border border-dark-700 rounded-xl p-4 text-white min-h-[100px]" />
                        <button onClick={getAIHelp} disabled={loading || !situation.trim()} className="mt-3 px-6 py-3 bg-gradient-to-r from-brand-cyan to-brand-purple text-white font-semibold rounded-xl disabled:opacity-50">
                            {loading ? 'ü§ñ Thinking...' : 'ü§ñ Get AI Help'}
                        </button>
                        {response && <div className="mt-4 p-4 bg-dark-800 rounded-xl text-sm text-slate-300">{response}</div>}
                    </div>
                    <div className="card p-6">
                        <h4 className="font-semibold text-white mb-4">‚ö° Quick Responses</h4>
                        <div className="space-y-3">
                            {quickResponses.map((qr, i) => (
                                <details key={i} className="bg-dark-800 rounded-xl">
                                    <summary className="p-3 cursor-pointer text-brand-cyan text-sm">{qr.q}</summary>
                                    <div className="p-3 pt-0 text-sm text-slate-300">{qr.a}</div>
                                </details>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // ========== STRATEGY TAB ==========
        const StrategyTab = ({ c, s }) => {
            const { user } = useAuth();
            const [strategy, setStrategy] = useState('');
            const [bottlenecks, setBottlenecks] = useState('');
            const [actions, setActions] = useState('');
            const [saving, setSaving] = useState(false);

            useEffect(() => { if (c?.client) loadStrategy(); }, [c?.client]);

            const loadStrategy = async () => {
                const { data } = await supabase.from('client_strategy').select('*').eq('client_name', c.client).single();
                if (data) { setStrategy(data.strategy_text || ''); setBottlenecks(data.bottlenecks || ''); setActions(data.action_items || ''); }
            };

            useEffect(() => {
                if (!c?.client) return;
                const timer = setTimeout(saveStrategy, 1500);
                return () => clearTimeout(timer);
            }, [strategy, bottlenecks, actions]);

            const saveStrategy = async () => {
                if (!c?.client || !user) return;
                setSaving(true);
                await supabase.from('client_strategy').upsert({ client_name: c.client, strategy_text: strategy, bottlenecks, action_items: actions, user_email: user.email, last_edited_by: user.email, updated_at: new Date().toISOString() }, { onConflict: 'client_name' });
                setSaving(false);
            };

            const detectedIssues = [];
            if (c?.cpl > 40) detectedIssues.push({ icon: 'üìà', text: `High CPL (${fmtD(c.cpl)})` });
            if (c?.appts7 === 0 && c?.days > 14) detectedIssues.push({ icon: 'üìÖ', text: 'No appointments this week' });
            if (c?.leads > 20 && c?.appts === 0) detectedIssues.push({ icon: 'üìû', text: `${c.leads} leads but 0 appts` });

            if (!c) return <div className="card p-12 text-center text-slate-500">Select a client</div>;

            return (
                <div className="space-y-6">
                    {detectedIssues.length > 0 && (
                        <div className="card p-6">
                            <h3 className="text-lg font-semibold text-white mb-4">üîç Detected Issues</h3>
                            <div className="space-y-2">
                                {detectedIssues.map((issue, i) => (
                                    <div key={i} className="flex items-center gap-3 p-3 bg-amber-500/10 rounded-xl text-amber-400 text-sm"><span>{issue.icon}</span><span>{issue.text}</span></div>
                                ))}
                            </div>
                        </div>
                    )}
                    <div className="card p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold text-white">üéØ Current Strategy</h3>
                            <span className="text-xs text-slate-500">{saving ? 'Saving...' : 'Auto-saved'}</span>
                        </div>
                        <textarea value={strategy} onChange={e => setStrategy(e.target.value)} placeholder="What's the current strategy?" className="w-full bg-dark-800 border border-dark-700 rounded-xl p-4 text-white min-h-[120px]" />
                    </div>
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üöß Bottlenecks</h3>
                        <textarea value={bottlenecks} onChange={e => setBottlenecks(e.target.value)} placeholder="What's blocking success?" className="w-full bg-dark-800 border border-dark-700 rounded-xl p-4 text-white min-h-[100px]" />
                    </div>
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">‚úÖ Action Plan</h3>
                        <textarea value={actions} onChange={e => setActions(e.target.value)} placeholder="What actions need to be taken?" className="w-full bg-dark-800 border border-dark-700 rounded-xl p-4 text-white min-h-[100px]" />
                    </div>
                </div>
            );
        };

        // ========== SAVE THE CLIENT TAB ==========
        const SaveClientTab = ({ c, s }) => {
            const score = getHealthScore(c, s);
            const playbooks = [
                { name: 'Payment Overdue', trigger: s?.duePayment?.includes('OVERDUE'), steps: ['Call immediately', 'Ask about service issues', 'Offer payment plan', 'Set deadline', 'Escalate if needed'] },
                { name: 'High CPL', trigger: c?.cpl > 50, steps: ['Review targeting', 'Check ad creative', 'Review landing page', 'Consider rebuild', 'Offer refresh'] },
                { name: 'No Appointments', trigger: c?.leads > 15 && c?.appts === 0, steps: ['Review lead quality', 'Check calling speed', 'Review scripts', 'Listen to recordings', 'Recommend ISA'] },
                { name: 'Client Wants to Cancel', trigger: false, steps: ['LISTEN first', 'Acknowledge frustration', 'Review wins', 'Propose solutions', 'Offer pause', 'Get manager'] },
            ];
            if (!c) return <div className="card p-12 text-center text-slate-500">Select a client</div>;
            return (
                <div className="space-y-6">
                    <div className={`card p-6 ${score < 60 ? 'border-red-500/30' : ''}`}>
                        <div className="flex items-center gap-4">
                            <span className="text-4xl">{score < 60 ? 'üö®' : '‚ö†Ô∏è'}</span>
                            <div><h3 className="text-lg font-bold text-white">Risk Assessment</h3><p className={score < 60 ? 'text-red-400' : 'text-amber-400'}>Score: {score}/100</p></div>
                        </div>
                    </div>
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üõü Playbooks</h3>
                        <div className="space-y-4">
                            {playbooks.map((pb, i) => (
                                <div key={i} className={`p-4 rounded-xl ${pb.trigger ? 'bg-red-500/10 border border-red-500/30' : 'bg-dark-800'}`}>
                                    <div className="flex items-center gap-2 mb-2">
                                        {pb.trigger && <span className="px-2 py-1 bg-red-500 text-white text-xs rounded">ACTIVE</span>}
                                        <h4 className="font-semibold text-white">{pb.name}</h4>
                                    </div>
                                    <ul className="space-y-1 text-sm text-slate-300">{pb.steps.map((step, j) => <li key={j}>{j+1}. {step}</li>)}</ul>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // ========== COMBINED NOTES, MEETINGS & ACTIVITY TAB (ALL ON ONE PAGE) ==========
        const NotesActivityTab = ({ c }) => {
            const { user } = useAuth();
            const [notes, setNotes] = useState([]);
            const [meetings, setMeetings] = useState([]);
            const [activities, setActivities] = useState([]);
            const [newNote, setNewNote] = useState('');
            const [transcript, setTranscript] = useState('');
            const [meetingDate, setMeetingDate] = useState(new Date().toISOString().split('T')[0]);
            const [processing, setProcessing] = useState(false);
            const [summary, setSummary] = useState(null);

            useEffect(() => { if (c?.client) { loadNotes(); loadMeetings(); loadActivities(); } }, [c?.client]);

            const loadNotes = async () => { const { data } = await supabase.from('client_notes').select('*').eq('client_name', c.client).order('created_at', { ascending: false }); if (data) setNotes(data); };
            const loadMeetings = async () => { const { data } = await supabase.from('meeting_notes').select('*').eq('client_name', c.client).order('meeting_date', { ascending: false }); if (data) setMeetings(data); };
            const loadActivities = async () => { const { data } = await supabase.from('activity_log').select('*').eq('client_name', c.client).order('created_at', { ascending: false }).limit(50); if (data) setActivities(data); };

            const addNote = async () => {
                if (!newNote.trim()) return;
                const { data } = await supabase.from('client_notes').insert({ client_name: c.client, note_text: newNote, user_email: user?.email, user_id: user?.id }).select().single();
                if (data) { setNotes([data, ...notes]); setNewNote(''); }
                await supabase.from('activity_log').insert({ user_email: user?.email, client_name: c.client, action: 'Added note', details: newNote.substring(0, 50) });
            };

            const deleteNote = async (id) => { await supabase.from('client_notes').delete().eq('id', id); setNotes(notes.filter(n => n.id !== id)); };

            const processTranscript = async () => {
                setProcessing(true);
                try {
                    const res = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1000,
                            messages: [{ role: 'user', content: `Summarize this meeting for ${c?.client}. Return JSON: {summary, clientSentiment, keyPoints[], actionItems[{task,owner}], riskLevel}\n\n${transcript}` }]
                        })
                    });
                    const data = await res.json();
                    setSummary(JSON.parse(data.content?.[0]?.text || '{}'));
                } catch { setSummary({ summary: 'Transcript saved.', keyPoints: [], actionItems: [], riskLevel: 'medium' }); }
                setProcessing(false);
            };

            const saveMeeting = async () => {
                if (!summary && !transcript.trim()) return;
                const { data } = await supabase.from('meeting_notes').insert({
                    client_name: c.client, meeting_date: meetingDate,
                    transcript, summary: summary?.summary || 'Manual entry',
                    client_sentiment: summary?.clientSentiment || 'neutral',
                    key_points: summary?.keyPoints || [], action_items: summary?.actionItems || [],
                    risk_level: summary?.riskLevel || 'medium',
                    user_email: user?.email
                }).select().single();
                if (data) { setMeetings([data, ...meetings]); setTranscript(''); setSummary(null); }
                await supabase.from('activity_log').insert({ user_email: user?.email, client_name: c.client, action: 'Added meeting notes', details: (summary?.summary || 'Manual entry').substring(0, 50) });
            };

            if (!c) return <div className="card p-12 text-center text-slate-500">Select a client</div>;

            return (
                <div className="space-y-6">
                    {/* ===== QUICK NOTES SECTION ===== */}
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üìù Quick Notes</h3>
                        <div className="flex gap-3">
                            <input value={newNote} onChange={e => setNewNote(e.target.value)} onKeyPress={e => e.key === 'Enter' && addNote()} placeholder="Add a note..." className="flex-1 bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white" />
                            <button onClick={addNote} className="px-6 py-3 bg-brand-cyan text-dark-900 font-semibold rounded-xl">Add</button>
                        </div>
                    </div>

                    {/* ===== NOTES HISTORY ===== */}
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üìö Notes History</h3>
                        {notes.length === 0 ? <div className="text-slate-500 text-center py-4">No notes yet</div> : (
                            <div className="space-y-3 max-h-[300px] overflow-y-auto scrollbar">
                                {notes.map(n => (
                                    <div key={n.id} className="p-4 bg-dark-800 rounded-xl group">
                                        <div className="flex justify-between items-start">
                                            <div><span className="text-brand-purple text-sm font-medium">{getDisplayName(n.user_email)}</span><span className="text-slate-600 text-sm ml-2">{new Date(n.created_at).toLocaleString()}</span></div>
                                            <button onClick={() => deleteNote(n.id)} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100">‚úï</button>
                                        </div>
                                        <p className="text-white mt-2">{n.note_text}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* ===== MEETING TRANSCRIPT SECTION ===== */}
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üéôÔ∏è Meeting Transcript Summary</h3>
                        <div className="flex gap-4 mb-4">
                            <input type="date" value={meetingDate} onChange={e => setMeetingDate(e.target.value)} className="bg-dark-800 border border-dark-700 rounded-xl px-4 py-2 text-white" />
                        </div>
                        <textarea value={transcript} onChange={e => setTranscript(e.target.value)} placeholder="Paste transcript from Fathom, Otter, Zoom, etc..." className="w-full bg-dark-800 border border-dark-700 rounded-xl p-4 text-white min-h-[150px]" />
                        <div className="flex gap-3 mt-3">
                            <button onClick={processTranscript} disabled={!transcript.trim() || processing} className="px-6 py-3 bg-gradient-to-r from-brand-cyan to-brand-purple text-white font-semibold rounded-xl disabled:opacity-50">{processing ? 'ü§ñ Analyzing...' : 'ü§ñ Analyze with AI'}</button>
                            <button onClick={saveMeeting} disabled={!transcript.trim()} className="px-6 py-3 bg-emerald-500/20 text-emerald-400 rounded-xl disabled:opacity-50">üíæ Save Meeting</button>
                        </div>
                        {summary && (
                            <div className="mt-4 p-4 bg-dark-800 rounded-xl space-y-3">
                                <div><span className="text-slate-400 text-sm">Summary:</span><p className="text-white">{summary.summary}</p></div>
                                {summary.clientSentiment && <div><span className="text-slate-400 text-sm">Sentiment:</span><span className="text-white ml-2">{summary.clientSentiment}</span></div>}
                                {summary.riskLevel && <div><span className="text-slate-400 text-sm">Risk Level:</span><span className={`ml-2 px-2 py-1 rounded text-xs ${summary.riskLevel === 'high' ? 'bg-red-500/20 text-red-400' : summary.riskLevel === 'medium' ? 'bg-amber-500/20 text-amber-400' : 'bg-emerald-500/20 text-emerald-400'}`}>{summary.riskLevel}</span></div>}
                                {summary.keyPoints?.length > 0 && <div><span className="text-slate-400 text-sm">Key Points:</span><ul className="mt-1 space-y-1">{summary.keyPoints.map((kp, i) => <li key={i} className="text-slate-300 text-sm">‚Ä¢ {kp}</li>)}</ul></div>}
                                {summary.actionItems?.length > 0 && <div><span className="text-slate-400 text-sm">Action Items:</span><ul className="mt-1 space-y-1">{summary.actionItems.map((ai, i) => <li key={i} className="text-slate-300 text-sm">‚Ä¢ {ai.task} ({ai.owner})</li>)}</ul></div>}
                            </div>
                        )}
                    </div>

                    {/* ===== MEETING HISTORY ===== */}
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üìÖ Meeting History</h3>
                        {meetings.length === 0 ? <div className="text-slate-500 text-center py-4">No meetings recorded</div> : (
                            <div className="space-y-3 max-h-[300px] overflow-y-auto scrollbar">
                                {meetings.map(m => (
                                    <div key={m.id} className="p-4 bg-dark-800 rounded-xl">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-white font-medium">{new Date(m.meeting_date).toLocaleDateString()}</span>
                                            <div className="flex items-center gap-2">
                                                <span className="text-slate-500 text-xs">{getDisplayName(m.user_email)}</span>
                                                <span className={`px-2 py-1 rounded text-xs ${m.risk_level === 'high' ? 'bg-red-500/20 text-red-400' : m.risk_level === 'medium' ? 'bg-amber-500/20 text-amber-400' : 'bg-emerald-500/20 text-emerald-400'}`}>{m.risk_level}</span>
                                            </div>
                                        </div>
                                        <p className="text-slate-400 text-sm">{m.summary}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* ===== ACTIVITY LOG ===== */}
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold text-white mb-4">üìã Activity Log</h3>
                        {activities.length === 0 ? <div className="text-slate-500 text-center py-4">No activity yet</div> : (
                            <div className="space-y-2 max-h-[250px] overflow-y-auto scrollbar">
                                {activities.map(a => (
                                    <div key={a.id} className="p-3 bg-dark-800 rounded-lg flex items-center gap-4">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2">
                                                <span className="text-brand-purple font-medium text-sm">{getDisplayName(a.user_email)}</span>
                                                <span className="text-slate-600 text-xs">{new Date(a.created_at).toLocaleString()}</span>
                                            </div>
                                            <div className="text-slate-400 text-sm">{a.action}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ========== MAIN APP ==========
        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [clients, setClients] = useState([]);
            const [setupData, setSetupData] = useState([]);
            const [selected, setSelected] = useState(null);
            const [tab, setTab] = useState('health');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => { setUser(session?.user || null); setAuthLoading(false); });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => setUser(session?.user || null));
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const params = new URLSearchParams(window.location.search);
                const clientParam = params.get('client');
                Promise.all([
                    // Client Ads Performance - headers in row 2, skip row 1
                    fetch(URLS.clientAdsPerformance).then(r => r.text()).then(csv => {
                        const lines = csv.split('\n');
                        const newCsv = [lines[1], ...lines.slice(2)].join('\n');
                        return Papa.parse(newCsv, { header: true, skipEmptyLines: true }).data.map(mapClient).filter(r => r.client);
                    }),
                    // Setup Timing - headers in row 1, skip row 2
                    fetch(URLS.setupTiming).then(r => r.text()).then(csv => { 
                        const lines = csv.split('\n'); 
                        return Papa.parse([lines[0], ...lines.slice(2)].join('\n'), { header: true, skipEmptyLines: true }).data.map(mapSetupTiming).filter(r => r.client); 
                    })
                ]).then(([c, s]) => {
                    setClients(c); setSetupData(s);
                    if (clientParam) { const found = c.find(x => x.client.toLowerCase() === decodeURIComponent(clientParam).toLowerCase()); if (found) setSelected(found); }
                    setLoading(false);
                });
            }, [user]);

            const getSetupInfo = (client) => {
                if (!client) return null;
                const name = client.client.toLowerCase().trim();
                return setupData.find(s => { const sn = (s.client || '').toLowerCase().trim(); return sn === name || sn.includes(name) || name.includes(sn) || name.split(' ').filter(p => p.length > 2).some(p => sn.includes(p)); });
            };

            // Show loading only while checking auth status
            if (authLoading) return <div className="min-h-screen flex items-center justify-center text-4xl">‚è≥</div>;
            // Show login page if not authenticated
            if (!user) return <LoginPage onLogin={setUser} />;
            // Show loading while fetching data (only for authenticated users)
            if (loading) return <div className="min-h-screen flex items-center justify-center text-4xl">‚è≥</div>;

            const s = getSetupInfo(selected);

            // Check if selected client exists in ads performance data
            const isMissingFromAdsSheet = selected ? false : false; // Will be set properly below

            const renderTab = () => {
                // Check if we have a client selected from Setup Timing but NOT in Ads Performance
                const selectedSetupOnly = !selected && tab === 'health';
                
                switch (tab) {
                    case 'health': return <ClientHealthTab c={selected} s={s} isMissingFromAdsSheet={false} />;
                    case 'scripts': return <CallScriptsTab c={selected} s={s} />;
                    case 'livehelp': return <LiveCallHelpTab c={selected} s={s} />;
                    case 'strategy': return <StrategyTab c={selected} s={s} />;
                    case 'save': return <SaveClientTab c={selected} s={s} />;
                    case 'notes': return <NotesActivityTab c={selected} />;
                    default: return <ClientHealthTab c={selected} s={s} isMissingFromAdsSheet={false} />;
                }
            };

            return (
                <AuthContext.Provider value={{ user }}>
                    <div className="flex min-h-screen">
                        <aside className="w-72 bg-dark-900 border-r border-dark-700 flex flex-col">
                            <div className="p-5 border-b border-dark-700">
                                <h1 className="text-xl font-bold bg-gradient-to-r from-brand-cyan to-brand-purple bg-clip-text text-transparent">VAM Client Success Hub</h1>
                                <div className="flex items-center gap-2 mt-2"><div className="w-2 h-2 bg-emerald-500 rounded-full"></div><span className="text-xs text-slate-400">{getDisplayName(user.email, user)}</span></div>
                            </div>
                            <div className="p-4">
                                <select value={selected?.client || ''} onChange={e => setSelected(clients.find(c => c.client === e.target.value))} className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white text-sm">
                                    <option value="">Select a client...</option>
                                    {clients.map(c => <option key={c.client} value={c.client}>{c.client}</option>)}
                                </select>
                            </div>
                            <nav className="flex-1 py-2 overflow-y-auto scrollbar">
                                {tabs.map(t => (
                                    <button key={t.id} onClick={() => setTab(t.id)} className={`w-full flex items-start gap-3 px-5 py-3 text-left ${tab === t.id ? 'tab-active text-white' : 'text-slate-400 hover:text-white hover:bg-dark-800'}`}>
                                        <span className="text-lg">{t.icon}</span>
                                        <div><div className="text-sm font-medium">{t.name}</div><div className="text-xs text-slate-500">{t.desc}</div></div>
                                    </button>
                                ))}
                                <div className="px-4 pt-4 pb-2 space-y-2">
                                    <a href="dashboard.html" className="block w-full text-center py-2 bg-dark-800 hover:bg-dark-700 text-slate-300 rounded-lg text-sm">‚Üí Media Buyer Overview</a>
                                    <button onClick={() => supabase.auth.signOut()} className="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg text-sm">Logout</button>
                                </div>
                            </nav>
                        </aside>
                        <main className="flex-1 flex flex-col">
                            <header className="bg-dark-900/80 backdrop-blur border-b border-dark-700 px-8 py-4">
                                {selected ? (
                                    <div className="flex items-center gap-4">
                                        <h2 className="text-xl font-bold text-white">{selected.client}</h2>
                                        <span className={`px-3 py-1 rounded-full text-sm ${getHealthColor(getHealthScore(selected, s)).text} bg-dark-800`}>{getHealthColor(getHealthScore(selected, s)).label}</span>
                                        <span className="text-slate-400">Day {selected.days}</span>
                                        {s?.csmRep && <span className="text-brand-purple text-sm">CSM: {s.csmRep}</span>}
                                        {s?.mrr && <span className="text-emerald-400 text-sm">MRR: {s.mrr}</span>}
                                    </div>
                                ) : <h2 className="text-xl text-slate-500">Select a client to get started</h2>}
                            </header>
                            <div className="flex-1 overflow-y-auto p-8 scrollbar">{renderTab()}</div>
                        </main>
                    </div>
                </AuthContext.Provider>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
