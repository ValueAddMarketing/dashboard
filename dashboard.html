<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAM Media Buyer Overview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 950: '#030712', 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569' },
                        brand: { cyan: '#06b6d4', purple: '#8b5cf6', blue: '#3b82f6' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #000000; color: #f1f5f9; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .card { background: #0f172a; border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; }
        .card:hover { border-color: rgba(6, 182, 212, 0.3); }
        .scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .scrollbar::-webkit-scrollbar-track { background: transparent; }
        .health-dot { width: 10px; height: 10px; border-radius: 50%; }
        .health-green { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .health-yellow { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
        .health-red { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        table { border-collapse: separate; border-spacing: 0; }
        th { position: sticky; top: 0; background: #1e293b; z-index: 10; }
        tr:hover td { background: rgba(6, 182, 212, 0.05); }
        .clickable-row { cursor: pointer; transition: all 0.2s; }
        .clickable-row:hover { background: rgba(6, 182, 212, 0.1) !important; }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="min-h-screen"></div>

    <script>
        // ========== CONFIG ==========
        const URLS = {
            clients: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRimOKUGksj-OVBSCpb9UGnkQU3Wu547GpcaUk4RT0oo5KM0fnVo2sk8mRpy4cwO5j9CckDORzmou-d/pub?gid=133498635&single=true&output=csv',
            last7: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRimOKUGksj-OVBSCpb9UGnkQU3Wu547GpcaUk4RT0oo5KM0fnVo2sk8mRpy4cwO5j9CckDORzmou-d/pub?gid=1447475730&single=true&output=csv',
            last30: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRimOKUGksj-OVBSCpb9UGnkQU3Wu547GpcaUk4RT0oo5KM0fnVo2sk8mRpy4cwO5j9CckDORzmou-d/pub?gid=1196243237&single=true&output=csv',
            setupTiming: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4LTw-15NE0j25eIOpY_bTPSAipW7-F2eXnL0xtdXMWCZtK9z3MYWxHr6ltnMChLk-YDLzwiXAfvwE/pub?gid=646836237&single=true&output=csv'
        };

        // ========== UTILITIES ==========
        const pn = v => parseFloat(String(v||'0').replace(/[$,%]/g,'').replace(/,/g,''))||0;
        const fmt = v => '$'+(pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});
        const fmtD = v => '$'+(pn(v)).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        const fmtN = v => (pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});

        const mapClient = r => ({
            client: r['Client']||'',
            adAccount: r['Ad Account Name']||'',
            state: r['State']||'',
            campaign: r['CAMPAIGN']||'',
            days: pn(r['Days Running']),
            weeks: pn(r['Weeks Running']),
            spend: pn(r['Total Ad Spend']),
            dailyBudget: pn(r['Daily Ad Spend Budget']),
            leads: pn(r['Total Leads']),
            cpl: pn(r['Cost Per Lead']),
            sellerLeads: pn(r['Seller Leads']),
            buyerLeads: pn(r['Buyer Leads']),
            appts: pn(r['Total Appts']),
            appts7: pn(r['Appts in the Last 7 Days']),
            deals: pn(r['Potential Deals']),
            listings: pn(r['Listing']),
            buyerSigned: pn(r['Buyer Signed'])
        });

        const getHealth = (cpl) => {
            if (cpl <= 25) return 'green';
            if (cpl <= 50) return 'yellow';
            return 'red';
        };

        const getPhase = (days) => {
            if (days <= 14) return 'Onboarding';
            if (days <= 30) return 'Optimization';
            if (days <= 60) return 'Scaling';
            return 'Systemization';
        };

        // ========== SAMPLE DATA ==========
        const sampleClients = [
            { client: 'Sample Client A', state: 'TX', campaign: 'Seller', days: 45, spend: 5000, leads: 120, cpl: 41.67, appts: 8, appts7: 2, deals: 1, listings: 1 },
            { client: 'Sample Client B', state: 'CA', campaign: 'Buyer', days: 30, spend: 3500, leads: 200, cpl: 17.50, appts: 15, appts7: 4, deals: 2, listings: 0 },
            { client: 'Sample Client C', state: 'FL', campaign: 'Seller & Buyer', days: 60, spend: 8000, leads: 95, cpl: 84.21, appts: 3, appts7: 0, deals: 0, listings: 0 },
        ];

        // ========== STATE ==========
        let clients = [];
        let setupData = {};
        let last7Data = [];
        let last30Data = [];
        let searchTerm = '';
        let sortCol = 'client';
        let sortDir = 'asc';
        let healthFilter = 'all';

        // ========== FETCH DATA ==========
        async function fetchData() {
            try {
                // Fetch ALL CLIENTS
                const clientsRes = await fetch(URLS.clients);
                const clientsCsv = await clientsRes.text();
                const clientsParsed = Papa.parse(clientsCsv, { header: true, skipEmptyLines: true });
                
                // Skip first 2 rows (summary rows)
                const clientRows = clientsParsed.data.slice(2);
                clients = clientRows.map(mapClient).filter(c => c.client && c.client.trim());
                
                if (clients.length === 0) {
                    clients = sampleClients;
                }
            } catch (err) {
                console.error('Error fetching clients:', err);
                clients = sampleClients;
            }

            try {
                // Fetch Setup Timing
                const setupRes = await fetch(URLS.setupTiming);
                const setupCsv = await setupRes.text();
                const setupParsed = Papa.parse(setupCsv, { header: true, skipEmptyLines: true });
                
                // Skip the summary row
                const setupRows = setupParsed.data.slice(1);
                setupRows.forEach(row => {
                    const name = row['VAM'] || '';
                    if (name) {
                        setupData[name.toLowerCase().trim()] = {
                            csmRep: row['CSM'] || '',
                            duePayment: row['Due Payment'] || '',
                            redFlags: row['Red flags'] || '',
                            mrr: row['MRR'] || ''
                        };
                    }
                });
            } catch (err) {
                console.error('Error fetching setup timing:', err);
            }

            try {
                // Fetch Last 7 Days
                const last7Res = await fetch(URLS.last7);
                const last7Csv = await last7Res.text();
                const last7Parsed = Papa.parse(last7Csv, { header: true, skipEmptyLines: true });
                last7Data = last7Parsed.data;
            } catch (err) {
                console.error('Error fetching last 7 days:', err);
            }

            try {
                // Fetch Last 30 Days
                const last30Res = await fetch(URLS.last30);
                const last30Csv = await last30Res.text();
                const last30Parsed = Papa.parse(last30Csv, { header: true, skipEmptyLines: true });
                last30Data = last30Parsed.data;
            } catch (err) {
                console.error('Error fetching last 30 days:', err);
            }

            render();
        }

        // ========== CALCULATIONS ==========
        function getTotals() {
            const total = clients.length;
            const totalSpend = clients.reduce((sum, c) => sum + c.spend, 0);
            const totalLeads = clients.reduce((sum, c) => sum + c.leads, 0);
            const avgCpl = totalLeads > 0 ? totalSpend / totalLeads : 0;
            const totalAppts = clients.reduce((sum, c) => sum + c.appts, 0);
            const totalDeals = clients.reduce((sum, c) => sum + c.deals, 0);
            
            const greenCount = clients.filter(c => getHealth(c.cpl) === 'green').length;
            const yellowCount = clients.filter(c => getHealth(c.cpl) === 'yellow').length;
            const redCount = clients.filter(c => getHealth(c.cpl) === 'red').length;

            return { total, totalSpend, totalLeads, avgCpl, totalAppts, totalDeals, greenCount, yellowCount, redCount };
        }

        function getLast7Totals() {
            let spend = 0, leads = 0;
            last7Data.forEach(row => {
                spend += pn(row['Total Cost'] || row['total_cost'] || 0);
                leads += pn(row['On Facebook Leads'] || row['leads'] || 0);
            });
            const cpl = leads > 0 ? spend / leads : 0;
            return { spend, leads, cpl, accounts: last7Data.length };
        }

        function getLast30Totals() {
            let spend = 0, leads = 0;
            last30Data.forEach(row => {
                spend += pn(row['Total Cost'] || row['total_cost'] || 0);
                leads += pn(row['On Facebook Leads'] || row['leads'] || 0);
            });
            const cpl = leads > 0 ? spend / leads : 0;
            return { spend, leads, cpl, accounts: last30Data.length };
        }

        // ========== SORTING & FILTERING ==========
        function getFilteredClients() {
            let filtered = [...clients];
            
            // Search
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(c => 
                    c.client.toLowerCase().includes(term) ||
                    c.state.toLowerCase().includes(term) ||
                    c.campaign.toLowerCase().includes(term)
                );
            }
            
            // Health filter
            if (healthFilter !== 'all') {
                filtered = filtered.filter(c => getHealth(c.cpl) === healthFilter);
            }
            
            // Sort
            filtered.sort((a, b) => {
                let aVal = a[sortCol];
                let bVal = b[sortCol];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            return filtered;
        }

        function handleSort(col) {
            if (sortCol === col) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortCol = col;
                sortDir = 'asc';
            }
            render();
        }

        function handleSearch(e) {
            searchTerm = e.target.value;
            render();
        }

        function handleHealthFilter(filter) {
            healthFilter = filter;
            render();
        }

        function goToClient(clientName) {
            window.location.href = `index.html?client=${encodeURIComponent(clientName)}`;
        }

        // ========== RENDER ==========
        function render() {
            const totals = getTotals();
            const last7 = getLast7Totals();
            const last30 = getLast30Totals();
            const filtered = getFilteredClients();

            const sortIcon = (col) => {
                if (sortCol !== col) return '';
                return sortDir === 'asc' ? ' â†‘' : ' â†“';
            };

            document.getElementById('app').innerHTML = `
                <div class="min-h-screen">
                    <!-- Header -->
                    <header class="glass sticky top-0 z-50 px-6 py-4 border-b border-white/5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-2xl font-bold bg-gradient-to-r from-brand-cyan to-brand-purple bg-clip-text text-transparent">
                                    VAM Media Buyer Overview
                                </h1>
                                <p class="text-slate-400 text-sm mt-1">Real-time client performance dashboard</p>
                            </div>
                            <a href="index.html" class="px-4 py-2 bg-dark-800 hover:bg-dark-700 rounded-lg text-sm text-slate-300 transition-colors">
                                â†’ Client Success Hub
                            </a>
                        </div>
                    </header>

                    <main class="p-6 space-y-6">
                        <!-- Summary Cards -->
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <div class="card p-4">
                                <div class="text-slate-400 text-xs uppercase tracking-wide mb-1">Total Clients</div>
                                <div class="text-2xl font-bold text-white">${totals.total}</div>
                            </div>
                            <div class="card p-4">
                                <div class="text-slate-400 text-xs uppercase tracking-wide mb-1">Total Ad Spend</div>
                                <div class="text-2xl font-bold text-white">${fmt(totals.totalSpend)}</div>
                            </div>
                            <div class="card p-4">
                                <div class="text-slate-400 text-xs uppercase tracking-wide mb-1">Total Leads</div>
                                <div class="text-2xl font-bold text-white">${fmtN(totals.totalLeads)}</div>
                            </div>
                            <div class="card p-4">
                                <div class="text-slate-400 text-xs uppercase tracking-wide mb-1">Avg CPL</div>
                                <div class="text-2xl font-bold ${totals.avgCpl <= 25 ? 'text-emerald-400' : totals.avgCpl <= 50 ? 'text-amber-400' : 'text-red-400'}">${fmtD(totals.avgCpl)}</div>
                            </div>
                            <div class="card p-4">
                                <div class="text-slate-400 text-xs uppercase tracking-wide mb-1">Total Appts</div>
                                <div class="text-2xl font-bold text-white">${fmtN(totals.totalAppts)}</div>
                            </div>
                            <div class="card p-4">
                                <div class="text-slate-400 text-xs uppercase tracking-wide mb-1">Potential Deals</div>
                                <div class="text-2xl font-bold text-white">${fmtN(totals.totalDeals)}</div>
                            </div>
                        </div>

                        <!-- Last 7 Days / Last 30 Days -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="card p-5">
                                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <span class="text-brand-cyan">ðŸ“Š</span> Last 7 Days
                                </h3>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <div class="text-slate-400 text-xs mb-1">Ad Spend</div>
                                        <div class="text-xl font-bold text-white">${fmt(last7.spend)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400 text-xs mb-1">Leads</div>
                                        <div class="text-xl font-bold text-white">${fmtN(last7.leads)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400 text-xs mb-1">Avg CPL</div>
                                        <div class="text-xl font-bold ${last7.cpl <= 25 ? 'text-emerald-400' : last7.cpl <= 50 ? 'text-amber-400' : 'text-red-400'}">${fmtD(last7.cpl)}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card p-5">
                                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <span class="text-brand-purple">ðŸ“ˆ</span> Last 30 Days
                                </h3>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <div class="text-slate-400 text-xs mb-1">Ad Spend</div>
                                        <div class="text-xl font-bold text-white">${fmt(last30.spend)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400 text-xs mb-1">Leads</div>
                                        <div class="text-xl font-bold text-white">${fmtN(last30.leads)}</div>
                                    </div>
                                    <div>
                                        <div class="text-slate-400 text-xs mb-1">Avg CPL</div>
                                        <div class="text-xl font-bold ${last30.cpl <= 25 ? 'text-emerald-400' : last30.cpl <= 50 ? 'text-amber-400' : 'text-red-400'}">${fmtD(last30.cpl)}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Health Distribution -->
                        <div class="card p-5">
                            <h3 class="text-lg font-semibold text-white mb-4">Health Distribution</h3>
                            <div class="flex items-center gap-6">
                                <button onclick="handleHealthFilter('all')" class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${healthFilter === 'all' ? 'bg-dark-700' : 'hover:bg-dark-800'}">
                                    <span class="text-slate-300">All</span>
                                    <span class="text-white font-bold">${totals.total}</span>
                                </button>
                                <button onclick="handleHealthFilter('green')" class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${healthFilter === 'green' ? 'bg-dark-700' : 'hover:bg-dark-800'}">
                                    <span class="health-dot health-green"></span>
                                    <span class="text-slate-300">Healthy</span>
                                    <span class="text-emerald-400 font-bold">${totals.greenCount}</span>
                                </button>
                                <button onclick="handleHealthFilter('yellow')" class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${healthFilter === 'yellow' ? 'bg-dark-700' : 'hover:bg-dark-800'}">
                                    <span class="health-dot health-yellow"></span>
                                    <span class="text-slate-300">Needs Attention</span>
                                    <span class="text-amber-400 font-bold">${totals.yellowCount}</span>
                                </button>
                                <button onclick="handleHealthFilter('red')" class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${healthFilter === 'red' ? 'bg-dark-700' : 'hover:bg-dark-800'}">
                                    <span class="health-dot health-red"></span>
                                    <span class="text-slate-300">At Risk</span>
                                    <span class="text-red-400 font-bold">${totals.redCount}</span>
                                </button>
                            </div>
                        </div>

                        <!-- Client Table -->
                        <div class="card">
                            <div class="p-4 border-b border-white/5 flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-white">All Clients</h3>
                                <input 
                                    type="text" 
                                    placeholder="Search clients..." 
                                    value="${searchTerm}"
                                    oninput="handleSearch(event)"
                                    class="bg-dark-800 border border-dark-700 rounded-lg px-4 py-2 text-white text-sm w-64 focus:outline-none focus:border-brand-cyan"
                                />
                            </div>
                            <div class="overflow-x-auto scrollbar" style="max-height: 600px;">
                                <table class="w-full">
                                    <thead>
                                        <tr class="text-left text-xs uppercase tracking-wide text-slate-400">
                                            <th class="px-4 py-3 cursor-pointer hover:text-white" onclick="handleSort('client')">Client${sortIcon('client')}</th>
                                            <th class="px-4 py-3 cursor-pointer hover:text-white" onclick="handleSort('state')">State${sortIcon('state')}</th>
                                            <th class="px-4 py-3 cursor-pointer hover:text-white" onclick="handleSort('days')">Days${sortIcon('days')}</th>
                                            <th class="px-4 py-3">Phase</th>
                                            <th class="px-4 py-3 cursor-pointer hover:text-white text-right" onclick="handleSort('spend')">Ad Spend${sortIcon('spend')}</th>
                                            <th class="px-4 py-3 cursor-pointer hover:text-white text-right" onclick="handleSort('leads')">Leads${sortIcon('leads')}</th>
                                            <th class="px-4 py-3 cursor-pointer hover:text-white text-right" onclick="handleSort('cpl')">CPL${sortIcon('cpl')}</th>
                                            <th class="px-4 py-3 cursor-pointer hover:text-white text-right" onclick="handleSort('appts')">Appts${sortIcon('appts')}</th>
                                            <th class="px-4 py-3 cursor-pointer hover:text-white text-right" onclick="handleSort('deals')">Deals${sortIcon('deals')}</th>
                                            <th class="px-4 py-3 cursor-pointer hover:text-white text-right" onclick="handleSort('listings')">Listings${sortIcon('listings')}</th>
                                            <th class="px-4 py-3 text-center">Health</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filtered.map(c => {
                                            const health = getHealth(c.cpl);
                                            const phase = getPhase(c.days);
                                            const setup = setupData[c.client.toLowerCase().trim()] || {};
                                            
                                            return `
                                                <tr class="border-t border-white/5 clickable-row" onclick="goToClient('${c.client.replace(/'/g, "\\'")}')">
                                                    <td class="px-4 py-3">
                                                        <div class="font-medium text-white">${c.client}</div>
                                                        ${setup.csmRep ? `<div class="text-xs text-slate-500">CSM: ${setup.csmRep}</div>` : ''}
                                                    </td>
                                                    <td class="px-4 py-3 text-slate-300">${c.state || 'â€”'}</td>
                                                    <td class="px-4 py-3 text-slate-300">${c.days}</td>
                                                    <td class="px-4 py-3">
                                                        <span class="px-2 py-1 rounded-full text-xs ${
                                                            phase === 'Onboarding' ? 'bg-cyan-500/20 text-cyan-400' :
                                                            phase === 'Optimization' ? 'bg-blue-500/20 text-blue-400' :
                                                            phase === 'Scaling' ? 'bg-purple-500/20 text-purple-400' :
                                                            'bg-emerald-500/20 text-emerald-400'
                                                        }">${phase}</span>
                                                    </td>
                                                    <td class="px-4 py-3 text-right text-slate-300">${fmt(c.spend)}</td>
                                                    <td class="px-4 py-3 text-right text-slate-300">${fmtN(c.leads)}</td>
                                                    <td class="px-4 py-3 text-right ${health === 'green' ? 'text-emerald-400' : health === 'yellow' ? 'text-amber-400' : 'text-red-400'}">${fmtD(c.cpl)}</td>
                                                    <td class="px-4 py-3 text-right text-slate-300">${fmtN(c.appts)}</td>
                                                    <td class="px-4 py-3 text-right text-slate-300">${fmtN(c.deals)}</td>
                                                    <td class="px-4 py-3 text-right text-slate-300">${fmtN(c.listings)}</td>
                                                    <td class="px-4 py-3 text-center">
                                                        <span class="health-dot health-${health} inline-block"></span>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="p-4 border-t border-white/5 text-sm text-slate-400">
                                Showing ${filtered.length} of ${clients.length} clients
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            render(); // Show loading state
            fetchData();
        });
    </script>
</body>
</html>
