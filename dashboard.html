<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAM Media Buyer Overview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 950: '#000000', 900: '#0a0a0a', 800: '#171717', 700: '#262626', 600: '#404040' },
                        light: { 50: '#fafafa', 100: '#f5f5f5', 200: '#e5e5e5', 300: '#d4d4d4', 400: '#a3a3a3' },
                        brand: { cyan: '#06b6d4', purple: '#8b5cf6', blue: '#3b82f6' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Dark Mode (default) */
        body.dark { background: #000000; color: #f5f5f5; }
        body.dark .card { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; }
        body.dark .sidebar { background: #0a0a0a; border-color: #262626; }
        body.dark .header-bar { background: rgba(10,10,10,0.9); border-color: #262626; }
        body.dark .input-field { background: #171717; border-color: #262626; color: #f5f5f5; }
        body.dark .text-primary { color: #f5f5f5; }
        body.dark .text-secondary { color: #a3a3a3; }
        body.dark .text-muted { color: #525252; }
        body.dark .hover-bg:hover { background: #171717; }
        body.dark .divider { border-color: #262626; }
        
        /* Light Mode */
        body.light { background: #ffffff; color: #171717; }
        body.light .card { background: #fafafa; border: 1px solid #e5e5e5; border-radius: 12px; }
        body.light .sidebar { background: #fafafa; border-color: #e5e5e5; }
        body.light .header-bar { background: rgba(250,250,250,0.9); border-color: #e5e5e5; }
        body.light .input-field { background: #ffffff; border-color: #d4d4d4; color: #171717; }
        body.light .text-primary { color: #171717; }
        body.light .text-secondary { color: #525252; }
        body.light .text-muted { color: #a3a3a3; }
        body.light .hover-bg:hover { background: #f5f5f5; }
        body.light .divider { border-color: #e5e5e5; }
        body.light .tab-active { background: linear-gradient(135deg, rgba(6,182,212,0.1), rgba(139,92,246,0.1)); }
        
        .tab-active { background: linear-gradient(135deg, rgba(6,182,212,0.15), rgba(139,92,246,0.15)); border-left: 3px solid #06b6d4; }
        .scrollbar::-webkit-scrollbar { width: 4px; }
        .scrollbar::-webkit-scrollbar-thumb { background: #404040; border-radius: 2px; }
    </style>
</head>
<body class="min-h-screen dark">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;

        const SUPABASE_URL = 'https://ecmhhonjazfbletyvncw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjbWhob25qYXpmYmxldHl2bmN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDMwMjYsImV4cCI6MjA4MTUxOTAyNn0.3LZ8dAOX_ZpoUNkgY_jSeC10SaCknfPfBaZsDRjFt7c';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const AuthContext = createContext(null);
        const ThemeContext = createContext(null);
        const useAuth = () => useContext(AuthContext);

        // Client Ads Performance sheet (gid=964722332) - headers in row 2
        // Setup Timing sheet (gid=646836237) - headers in row 1, data starts row 3
        const URLS = {
            clientAdsPerformance: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4LTw-15NE0j25eIOpY_bTPSAipW7-F2eXnL0xtdXMWCZtK9z3MYWxHr6ltnMChLk-YDLzwiXAfvwE/pub?gid=964722332&single=true&output=csv',
            setupTiming: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4LTw-15NE0j25eIOpY_bTPSAipW7-F2eXnL0xtdXMWCZtK9z3MYWxHr6ltnMChLk-YDLzwiXAfvwE/pub?gid=646836237&single=true&output=csv'
        };

        const pn = v => parseFloat(String(v||'0').replace(/[$,%]/g,'').replace(/,/g,''))||0;
        const fmt = v => '$'+(pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});
        const fmtD = v => '$'+(pn(v)).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        const fmtN = v => (pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});
        const fmtP = v => (pn(v)).toFixed(1)+'%';
        const getDisplayName = (email, user) => {
            if (user?.user_metadata?.full_name) return user.user_metadata.full_name;
            if (user?.user_metadata?.name) return user.user_metadata.name;
            return email ? email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : 'Unknown';
        };

        // Map Client Ads Performance sheet - headers in row 2 (A2:BA2)
        const mapClient = r => ({
            client: r['Client']||'',
            adAccount: r['Ad Account Name']||'',
            teamMember: r['Team Member']||'',
            status: r['Status']||'',
            dailySetAdSpend: pn(r['Daily Set Ad Spend']),
            state: r['State']||'',
            campaign: r['CAMPAIGN']||'',
            specificTarget: r['Specific Target']||'',
            overlap: r['Overlap']||'',
            overallStanding: r['Overall Standing']||'',
            callingStatus: r['Calling/Non-calling']||'',
            usingDqReasons: r['Using DQ Reasons']||'',
            callingUsingCrm: r['Calling using CRM']||'',
            mbNotes: r['MB Detailed Notes / Test Conducted']||'',
            currentTestings: r['Current Testings']||'',
            clientAvgHomeValue: r['Client Avg Home Value']||'',
            startDate: r['CORRECT SETUP TIMING START DATE']||r['OLD Start Date']||'',
            contract: r['Contract']||'',
            contractLengthMonths: r['Contract Length In Months']||'',
            remainingContractMonths: r['# Of Remaining Contract Months Left']||'',
            leadySync: r['Lead Sync']||r['Leady Sync']||'',
            months: pn(r['Months Running']),
            weeks: pn(r['Weeks Running']),
            days: pn(r['Days Running']),
            spend: pn(r['Total Ad Spend']),
            spendPerMonth: pn(r['Ad Spend Per Month']),
            spendPerDay: pn(r['Ad Spend Per Day']),
            // Last 3 Days - Seller
            last3DaySellerLeads: pn(r['Last 3 Day Seller Leads']),
            last3DaySellerSpend: pn(r['Last 3 Days Seller Ad Spend']),
            last3DaySellerCPL: pn(r['Last 3 Days Seller CPL']),
            // Last 7 Days - Seller
            last7DaySellerLeads: pn(r['Last 7 Day Seller Leads']),
            last7DaySellerSpend: pn(r['Last 7 Day Seller Spend']),
            last7DaySellerCPL: pn(r['Last 7 Days Seller CPL']),
            // Lifetime - Seller
            lifetimeSellerLeads: pn(r['Lifetime Seller Leads']),
            lifetimeSellerSpend: pn(r['Lifetime Seller Ad Spend']),
            lifetimeSellerCPL: pn(r['Lifetime Seller CPL']),
            // Last 3 Days - Buyer
            last3DayBuyerLeads: pn(r['Last 3 Day Buyer Leads']),
            last3DayBuyerSpend: pn(r['Last 3 Days Buyer Ad Spend']),
            last3DayBuyerCPL: pn(r['Last 3 Days Buyer CPL']),
            // Last 7 Days - Buyer
            last7DayBuyerLeads: pn(r['Last 7 Day Buyer Leads']),
            last7DayBuyerSpend: pn(r['Last 7 Day Buyer Spend']),
            last7DayBuyerCPL: pn(r['Last 7 Days Buyer CPL']),
            // Lifetime - Buyer
            lifetimeBuyerLeads: pn(r['Lifetime Buyer Leads']),
            lifetimeBuyerSpend: pn(r['Lifetime Buyer Ad Spend']),
            lifetimeBuyerCPL: pn(r['Lifetime Buyer CPL']),
            // Other lead types
            listingLeads: pn(r['Listing Leads']),
            // Mortgage
            last3DayMortgageLeads: pn(r['Last 3 Day Mortgage Leads']),
            last3DayMortgageSpend: pn(r['Last 3 Days Mortgage Ad Spend']),
            last3DayMortgageCPL: pn(r['Last 3 Days Mortgage CPL']),
            last7DayMortgageLeads: pn(r['Last 7 Day Mortgage Leads']),
            last7DayMortgageSpend: pn(r['Last 7 Day Mortgage Spend']),
            last7DayMortgageCPL: pn(r['Last 7 Days Mortgage CPL']),
            mortgageLeads: pn(r['Lifetime Mortgage Leads']),
            mortgageSpend: pn(r['Lifetime Mortgage Ad Spend']),
            mortgageCPL: pn(r['Lifetime Mortgage CPL']),
            mortgageAppts: pn(r['Total Appts Mortgage']),
            // Appointments
            appts: pn(r['Total Appts (Seller + Buyers)']),
            sellerAppts: pn(r['Total Seller Appts']),
            sellerAppts7: pn(r['Seller Appts in the Last 7 Days']),
            avgSellerApptsWeek: pn(r['Avg Seller Appts per Week']),
            sellerLeadToAppt: pn(r['Seller Lead To Appt Ratio']),
            costPerSellerAppt: pn(r['Total Ad Spend Cost Per Seller Appt']||r['Total Ad Spend Cost Per Seller Appts']),
            buyerAppts: pn(r['Total Buyer Appts']),
            buyerAppts7: pn(r['Buyer Appts in the Last 7 Days']),
            avgBuyerApptsWeek: pn(r['Avg Buyer Appts per Week']),
            buyerLeadToAppt: pn(r['Buyer Lead To Appt Ratio']),
            costPerBuyerAppt: pn(r['Total Ad Spend Cost Per Buyer Appts']||r['Ad Spend Cost Per Buyer Appts']),
            // Deals
            deals: pn(r['Potential Deals']),
            listings: pn(r['Listing']),
            buyerSigned: pn(r['Buyer Signed']),
            leadsPerListing: pn(r['Leads/Listing']),
            leadsPerDeal: pn(r['Leads/Potential Deal']),
            leadsPerSignedBuyer: pn(r['Leads/Signed Buyer']),
            adSpendPerDeal: pn(r['Ad Spend/Potential Deal']),
            adSpendPerListing: pn(r['Ad Spend/Listing']),
            adSpendPerBuyer: pn(r['Ad Spend/Buyer']),
        });

        // Computed properties helper
        const getClientMetrics = (c) => ({
            ...c,
            totalLeads: c.lifetimeSellerLeads + c.lifetimeBuyerLeads + c.listingLeads,
            last3DayLeads: c.last3DaySellerLeads + c.last3DayBuyerLeads,
            last7DayLeads: c.last7DaySellerLeads + c.last7DayBuyerLeads,
            appts7: c.sellerAppts7 + c.buyerAppts7,
            cpl: (c.lifetimeSellerLeads + c.lifetimeBuyerLeads + c.listingLeads) > 0 
                ? c.spend / (c.lifetimeSellerLeads + c.lifetimeBuyerLeads + c.listingLeads) 
                : 0
        });

        const mapSetupTiming = r => ({
            client: r['VAM'] || '', csmRep: r['CSM'] || '', status: r['Status'] || '',
            mrr: r['MRR'] || '', duePayment: r['Due Payment'] || '', redFlags: r['Red flags'] || '',
        });

        const getHealth = cpl => { if(!cpl) return 'gray'; if(cpl<=25) return 'green'; if(cpl<=50) return 'yellow'; return 'red'; };
        const healthColors = { green: 'bg-emerald-500', yellow: 'bg-amber-500', red: 'bg-red-500', gray: 'bg-slate-500' };

        // Color palettes for Team Member and Campaign badge pills
        const teamMemberColorMap = {};
        const teamMemberPalette = [
            'bg-violet-500/20 text-violet-400',
            'bg-sky-500/20 text-sky-400',
            'bg-pink-500/20 text-pink-400',
            'bg-teal-500/20 text-teal-400',
            'bg-orange-500/20 text-orange-400',
            'bg-indigo-500/20 text-indigo-400',
            'bg-rose-500/20 text-rose-400',
            'bg-cyan-500/20 text-cyan-400',
            'bg-lime-500/20 text-lime-400',
            'bg-fuchsia-500/20 text-fuchsia-400',
        ];
        let teamColorIndex = 0;
        const getTeamMemberColor = (name) => {
            if (!name || name.trim() === '' || name === '‚Äî') return 'bg-slate-500/20 text-slate-400';
            const key = name.trim().toLowerCase();
            if (!teamMemberColorMap[key]) {
                teamMemberColorMap[key] = teamMemberPalette[teamColorIndex % teamMemberPalette.length];
                teamColorIndex++;
            }
            return teamMemberColorMap[key];
        };

        const campaignColorMap = {};
        const campaignPalette = [
            'bg-blue-500/20 text-blue-400',
            'bg-amber-500/20 text-amber-400',
            'bg-emerald-500/20 text-emerald-400',
            'bg-purple-500/20 text-purple-400',
            'bg-red-500/20 text-red-400',
            'bg-cyan-500/20 text-cyan-400',
            'bg-yellow-500/20 text-yellow-400',
            'bg-indigo-500/20 text-indigo-400',
            'bg-pink-500/20 text-pink-400',
            'bg-teal-500/20 text-teal-400',
        ];
        let campaignColorIndex = 0;
        const getCampaignColor = (name) => {
            if (!name || name.trim() === '' || name === '‚Äî') return 'bg-slate-500/20 text-slate-400';
            const key = name.trim().toLowerCase();
            if (!campaignColorMap[key]) {
                campaignColorMap[key] = campaignPalette[campaignColorIndex % campaignPalette.length];
                campaignColorIndex++;
            }
            return campaignColorMap[key];
        };

        // ========== LOGIN ==========
        const LoginPage = ({ onLogin }) => {
            const [isSignUp, setIsSignUp] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [fullName, setFullName] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(''); setSuccess('');
                try {
                    if (isSignUp) {
                        const result = await supabase.auth.signUp({ email, password, options: { data: { full_name: fullName, name: fullName } } });
                        if (result.error) throw result.error;
                        if (result.data?.user?.identities?.length === 0) setError('This email is already registered.');
                        else { setSuccess('Account created! Check your email to confirm.'); setIsSignUp(false); }
                    } else {
                        const result = await supabase.auth.signInWithPassword({ email, password });
                        if (result.error) throw result.error;
                        onLogin(result.data.user);
                    }
                } catch (err) { setError(err.message); }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="card p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold bg-gradient-to-r from-brand-cyan to-brand-purple bg-clip-text text-transparent">VAM Media Buyer Overview</h1>
                            <p className="text-slate-500 mt-2">{isSignUp ? 'Create your account' : 'Sign in to continue'}</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {isSignUp && <input type="text" value={fullName} onChange={e => setFullName(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white" placeholder="Full Name" required />}
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white" placeholder="Email" required />
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white" placeholder="Password" required minLength={6} />
                            {error && <div className="p-3 rounded-xl bg-red-500/10 text-red-400 text-sm">{error}</div>}
                            {success && <div className="p-3 rounded-xl bg-emerald-500/10 text-emerald-400 text-sm">{success}</div>}
                            <button type="submit" disabled={loading} className="w-full py-3 bg-gradient-to-r from-brand-cyan to-brand-purple text-white font-semibold rounded-xl">
                                {loading ? (isSignUp ? 'Creating...' : 'Signing in...') : (isSignUp ? 'Create Account' : 'Sign In')}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button onClick={() => { setIsSignUp(!isSignUp); setError(''); setSuccess(''); }} className="text-brand-cyan hover:text-brand-purple text-sm">
                                {isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== ALL CLIENTS OVERVIEW ==========
        const AllClientsView = ({ clients, setupData, onClientClick }) => {
            const [sortBy, setSortBy] = useState('client');
            const [sortDir, setSortDir] = useState('asc');
            const [filter, setFilter] = useState('');
            const [filterStatus, setFilterStatus] = useState('');
            const [filterTeamMember, setFilterTeamMember] = useState('');
            const [filterState, setFilterState] = useState('');
            const [filterCampaign, setFilterCampaign] = useState('');
            const [filterCallingStatus, setFilterCallingStatus] = useState('');
            const [filterOverallStanding, setFilterOverallStanding] = useState('');

            const getSetupInfo = (clientName) => {
                const name = clientName.toLowerCase().trim();
                return setupData.find(s => {
                    const sn = (s.client || '').toLowerCase().trim();
                    return sn === name || sn.includes(name) || name.includes(sn);
                });
            };

            // Enrich clients with computed metrics
            const enrichedClients = clients.map(getClientMetrics);

            // Get unique values for filter dropdowns
            const uniqueValues = (key) => [...new Set(enrichedClients.map(c => c[key]).filter(Boolean))].sort();
            const statuses = uniqueValues('status');
            const teamMembers = uniqueValues('teamMember');
            const states = uniqueValues('state');
            const campaigns = uniqueValues('campaign');
            const callingStatuses = uniqueValues('callingStatus');
            const overallStandings = uniqueValues('overallStanding');

            // Count active filters
            const activeFilterCount = [filterStatus, filterTeamMember, filterState, filterCampaign, filterCallingStatus, filterOverallStanding].filter(Boolean).length;

            // Get at-risk clients (red health = CPL > $50)
            const atRiskClients = enrichedClients.filter(c => getHealth(c.cpl) === 'red' && c.days > 7);

            // Get clients with no leads in last 3 days
            const noRecentLeadsClients = enrichedClients.filter(c => c.days >= 3 && c.last3DayLeads === 0);

            // Get clients from Setup Timing that are NOT in Client Ads Performance
            const clientNames = clients.map(c => c.client.toLowerCase().trim());
            const missingFromAdsPerformance = setupData.filter(s => {
                const sn = (s.client || '').toLowerCase().trim();
                return sn && !clientNames.some(cn => cn === sn || cn.includes(sn) || sn.includes(cn));
            });

            const filteredClients = enrichedClients.filter(c => {
                const matchesSearch = !filter || c.client.toLowerCase().includes(filter.toLowerCase()) || c.state.toLowerCase().includes(filter.toLowerCase());
                const matchesStatus = !filterStatus || c.status === filterStatus;
                const matchesTeamMember = !filterTeamMember || c.teamMember === filterTeamMember;
                const matchesState = !filterState || c.state === filterState;
                const matchesCampaign = !filterCampaign || c.campaign === filterCampaign;
                const matchesCalling = !filterCallingStatus || c.callingStatus === filterCallingStatus;
                const matchesStanding = !filterOverallStanding || c.overallStanding === filterOverallStanding;
                return matchesSearch && matchesStatus && matchesTeamMember && matchesState && matchesCampaign && matchesCalling && matchesStanding;
            });

            const sortedClients = [...filteredClients].sort((a, b) => {
                let aVal = a[sortBy], bVal = b[sortBy];
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                if (sortDir === 'asc') return aVal > bVal ? 1 : -1;
                return aVal < bVal ? 1 : -1;
            });

            const totals = enrichedClients.reduce((acc, c) => ({
                spend: acc.spend + c.spend,
                leads: acc.leads + c.totalLeads,
                appts: acc.appts + c.appts,
                deals: acc.deals + c.deals
            }), { spend: 0, leads: 0, appts: 0, deals: 0 });

            const handleSort = (col) => {
                if (sortBy === col) setSortDir(sortDir === 'asc' ? 'desc' : 'asc');
                else { setSortBy(col); setSortDir('asc'); }
            };

            const clearAllFilters = () => {
                setFilter(''); setFilterStatus(''); setFilterTeamMember(''); setFilterState('');
                setFilterCampaign(''); setFilterCallingStatus(''); setFilterOverallStanding('');
            };

            const FilterSelect = ({ label, value, onChange, options }) => (
                <div>
                    <label className="block text-xs text-slate-500 mb-1">{label}</label>
                    <select value={value} onChange={e => onChange(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-lg px-3 py-2 text-sm text-white">
                        <option value="">All</option>
                        {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                    </select>
                </div>
            );

            return (
                <div className="space-y-6">
                    {/* Alert Sections */}
                    <div className="grid lg:grid-cols-3 gap-6">
                        {/* At-Risk Clients (Red Health) */}
                        <div className="card p-5 border-l-4 border-red-500">
                            <div className="flex items-center gap-3 mb-4">
                                <span className="text-2xl">üö®</span>
                                <div>
                                    <h3 className="text-lg font-bold text-red-400">At-Risk Clients</h3>
                                    <p className="text-slate-500 text-xs">High CPL (&gt;$50) - Needs attention</p>
                                </div>
                                <span className="ml-auto bg-red-500/20 text-red-400 px-3 py-1 rounded-full text-sm font-bold">{atRiskClients.length}</span>
                            </div>
                            {atRiskClients.length === 0 ? (
                                <div className="text-slate-500 text-sm text-center py-4">‚úÖ No at-risk clients</div>
                            ) : (
                                <div className="space-y-2 max-h-[200px] overflow-y-auto scrollbar">
                                    {atRiskClients.map(c => (
                                        <div key={c.client} onClick={() => onClientClick(c.client)} className="flex items-center justify-between p-3 bg-red-500/10 rounded-lg cursor-pointer hover:bg-red-500/20">
                                            <div>
                                                <div className="font-medium text-white">{c.client}</div>
                                                <div className="text-xs text-slate-400">{c.state} ‚Ä¢ Day {c.days}{c.teamMember && ` ‚Ä¢ ${c.teamMember}`}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-red-400 font-bold">{fmtD(c.cpl)}</div>
                                                <div className="text-xs text-slate-500">CPL</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* No Leads in Last 3 Days */}
                        <div className="card p-5 border-l-4 border-amber-500">
                            <div className="flex items-center gap-3 mb-4">
                                <span className="text-2xl">‚ö†Ô∏è</span>
                                <div>
                                    <h3 className="text-lg font-bold text-amber-400">No Leads (3 Days)</h3>
                                    <p className="text-slate-500 text-xs">Zero leads in last 3 days</p>
                                </div>
                                <span className="ml-auto bg-amber-500/20 text-amber-400 px-3 py-1 rounded-full text-sm font-bold">{noRecentLeadsClients.length}</span>
                            </div>
                            {noRecentLeadsClients.length === 0 ? (
                                <div className="text-slate-500 text-sm text-center py-4">‚úÖ All accounts active</div>
                            ) : (
                                <div className="space-y-2 max-h-[200px] overflow-y-auto scrollbar">
                                    {noRecentLeadsClients.map(c => (
                                        <div key={c.client} onClick={() => onClientClick(c.client)} className="flex items-center justify-between p-3 bg-amber-500/10 rounded-lg cursor-pointer hover:bg-amber-500/20">
                                            <div>
                                                <div className="font-medium text-white">{c.client}</div>
                                                <div className="text-xs text-slate-400">{c.state} ‚Ä¢ Day {c.days}{c.teamMember && ` ‚Ä¢ ${c.teamMember}`}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-amber-400 font-bold">0 leads</div>
                                                <div className="text-xs text-slate-500">Last 3 days</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Missing from Ads Performance Sheet */}
                        <div className="card p-5 border-l-4 border-purple-500">
                            <div className="flex items-center gap-3 mb-4">
                                <span className="text-2xl">üìã</span>
                                <div>
                                    <h3 className="text-lg font-bold text-purple-400">Missing from Ads Sheet</h3>
                                    <p className="text-slate-500 text-xs">Add to Client Ads Performance</p>
                                </div>
                                <span className="ml-auto bg-purple-500/20 text-purple-400 px-3 py-1 rounded-full text-sm font-bold">{missingFromAdsPerformance.length}</span>
                            </div>
                            {missingFromAdsPerformance.length === 0 ? (
                                <div className="text-slate-500 text-sm text-center py-4">‚úÖ All clients tracked</div>
                            ) : (
                                <div className="space-y-2 max-h-[200px] overflow-y-auto scrollbar">
                                    {missingFromAdsPerformance.map(s => (
                                        <div key={s.client} className="flex items-center justify-between p-3 bg-purple-500/10 rounded-lg">
                                            <div>
                                                <div className="font-medium text-white">{s.client}</div>
                                                <div className="text-xs text-slate-400">{s.csmRep && `CSM: ${s.csmRep}`}</div>
                                            </div>
                                            <div className="text-purple-400 text-xs font-medium">ADD TO SHEET</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="card p-4"><div className="text-slate-400 text-sm">Total Clients</div><div className="text-2xl font-bold text-white">{clients.length}</div></div>
                        <div className="card p-4"><div className="text-slate-400 text-sm">Total Spend</div><div className="text-2xl font-bold text-brand-cyan">{fmt(totals.spend)}</div></div>
                        <div className="card p-4"><div className="text-slate-400 text-sm">Total Leads</div><div className="text-2xl font-bold text-brand-purple">{fmtN(totals.leads)}</div></div>
                        <div className="card p-4"><div className="text-slate-400 text-sm">Total Appts</div><div className="text-2xl font-bold text-emerald-400">{fmtN(totals.appts)}</div></div>
                    </div>

                    {/* Search & Filters */}
                    <div className="card p-4 space-y-3">
                        <div className="flex items-center gap-3">
                            <input type="text" value={filter} onChange={e => setFilter(e.target.value)} placeholder="Search clients..." className="w-64 bg-dark-800 border border-dark-700 rounded-lg px-3 py-2 text-sm text-white" />
                            {activeFilterCount > 0 && (
                                <button onClick={clearAllFilters} className="px-3 py-2 rounded-lg bg-red-500/10 border border-red-500/30 text-red-400 text-xs font-medium hover:bg-red-500/20">Clear Filters ({activeFilterCount})</button>
                            )}
                            {(activeFilterCount > 0 || filter) && (
                                <span className="text-xs text-slate-500">Showing {sortedClients.length} of {enrichedClients.length}</span>
                            )}
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                            <FilterSelect label="Status" value={filterStatus} onChange={setFilterStatus} options={statuses} />
                            <FilterSelect label="Team Member" value={filterTeamMember} onChange={setFilterTeamMember} options={teamMembers} />
                            <FilterSelect label="State" value={filterState} onChange={setFilterState} options={states} />
                            <FilterSelect label="Campaign" value={filterCampaign} onChange={setFilterCampaign} options={campaigns} />
                            <FilterSelect label="Calling Status" value={filterCallingStatus} onChange={setFilterCallingStatus} options={callingStatuses} />
                            <FilterSelect label="Overall Standing" value={filterOverallStanding} onChange={setFilterOverallStanding} options={overallStandings} />
                        </div>
                    </div>

                    {/* Client Table */}
                    <div className="card overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-dark-800">
                                    <tr>
                                        {[
                                            { key: 'status', label: 'Status' },
                                            { key: 'teamMember', label: 'Team Member' },
                                            { key: 'client', label: 'Client' },
                                            { key: 'state', label: 'State' },
                                            { key: 'campaign', label: 'Campaign' },
                                            { key: 'overallStanding', label: 'Standing' },
                                            { key: 'callingStatus', label: 'Calling' },
                                            { key: 'days', label: 'Days' },
                                            { key: 'spend', label: 'Spend' },
                                            { key: 'last3DayLeads', label: '3-Day Leads' },
                                            { key: 'last7DayLeads', label: '7-Day Leads' },
                                            { key: 'totalLeads', label: 'Total Leads' },
                                            { key: 'cpl', label: 'CPL' },
                                            { key: 'appts', label: 'Appts' },
                                            { key: 'deals', label: 'Deals' },
                                        ].map(col => (
                                            <th key={col.key} onClick={() => handleSort(col.key)} className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer hover:text-white whitespace-nowrap">
                                                {col.label} {sortBy === col.key && (sortDir === 'asc' ? '‚Üë' : '‚Üì')}
                                            </th>
                                        ))}
                                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Health</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-dark-700">
                                    {sortedClients.map(c => {
                                        const s = getSetupInfo(c.client);
                                        const health = getHealth(c.cpl);
                                        const standingColor = (c.overallStanding || '').toLowerCase().includes('good') ? 'text-emerald-400' :
                                            (c.overallStanding || '').toLowerCase().includes('bad') || (c.overallStanding || '').toLowerCase().includes('poor') ? 'text-red-400' :
                                            (c.overallStanding || '').toLowerCase().includes('ok') || (c.overallStanding || '').toLowerCase().includes('average') ? 'text-amber-400' : 'text-slate-300';
                                        const standingBadge = (c.overallStanding || '').toLowerCase().includes('good') ? 'bg-emerald-500/20 text-emerald-400' :
                                            (c.overallStanding || '').toLowerCase().includes('bad') || (c.overallStanding || '').toLowerCase().includes('poor') ? 'bg-red-500/20 text-red-400' :
                                            (c.overallStanding || '').toLowerCase().includes('ok') || (c.overallStanding || '').toLowerCase().includes('average') ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-500/20 text-slate-400';
                                        const callingBadge = (c.callingStatus || '').toLowerCase().includes('calling') && !(c.callingStatus || '').toLowerCase().includes('non') ? 'bg-emerald-500/20 text-emerald-400' :
                                            (c.callingStatus || '').toLowerCase().includes('non') ? 'bg-red-500/20 text-red-400' : 'bg-slate-500/20 text-slate-400';
                                        const teamBadge = getTeamMemberColor(c.teamMember);
                                        const campaignBadge = getCampaignColor(c.campaign);
                                        return (
                                            <tr key={c.client} onClick={() => onClientClick(c.client)} className="hover:bg-dark-800 cursor-pointer transition-colors">
                                                <td className="px-4 py-3">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                        (c.status || '').toLowerCase() === 'active' ? 'bg-emerald-500/20 text-emerald-400' :
                                                        (c.status || '').toLowerCase() === 'paused' ? 'bg-red-500/20 text-red-400' :
                                                        (c.status || '').toLowerCase() === 'scheduled' ? 'bg-blue-500/20 text-blue-400' :
                                                        'bg-slate-500/20 text-slate-400'
                                                    }`}>{c.status || '‚Äî'}</span>
                                                </td>
                                                <td className="px-4 py-3 whitespace-nowrap">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${teamBadge}`}>{c.teamMember || '‚Äî'}</span>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <div className="font-medium text-white">{c.client}</div>
                                                    {s?.csmRep && <div className="text-xs text-slate-500">CSM: {s.csmRep}</div>}
                                                </td>
                                                <td className="px-4 py-3 text-slate-300">{c.state || '‚Äî'}</td>
                                                <td className="px-4 py-3">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${campaignBadge}`}>{c.campaign || '‚Äî'}</span>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${standingBadge}`}>{c.overallStanding || '‚Äî'}</span>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${callingBadge}`}>{c.callingStatus || '‚Äî'}</span>
                                                </td>
                                                <td className="px-4 py-3 text-slate-300">{c.days}</td>
                                                <td className="px-4 py-3 text-slate-300">{fmt(c.spend)}</td>
                                                <td className={`px-4 py-3 font-medium ${c.last3DayLeads === 0 && c.days >= 3 ? 'text-red-400' : 'text-brand-cyan'}`}>{fmtN(c.last3DayLeads)}</td>
                                                <td className="px-4 py-3 text-brand-cyan font-medium">{fmtN(c.last7DayLeads)}</td>
                                                <td className="px-4 py-3 text-brand-purple font-medium">{fmtN(c.totalLeads)}</td>
                                                <td className="px-4 py-3 text-white font-medium">{fmtD(c.cpl)}</td>
                                                <td className="px-4 py-3 text-brand-purple font-medium">{fmtN(c.appts)}</td>
                                                <td className="px-4 py-3 text-emerald-400 font-medium">{fmtN(c.deals)}</td>
                                                <td className="px-4 py-3"><span className={`w-3 h-3 rounded-full inline-block ${healthColors[health]}`}></span></td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <p className="text-center text-slate-500 text-sm">üí° Click any client to view details in Client Success Hub</p>
                </div>
            );
        };

        // ========== MAIN APP ==========
        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [clients, setClients] = useState([]);
            const [setupData, setSetupData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [theme, setTheme] = useState('dark');

            // Theme toggle function
            const toggleTheme = () => {
                const newTheme = theme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                document.body.className = 'min-h-screen ' + newTheme;
            };

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => { setUser(session?.user || null); setAuthLoading(false); });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => setUser(session?.user || null));
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                
                // Try to load from cache first for instant display
                const cachedClients = localStorage.getItem('vam_clients');
                const cachedSetup = localStorage.getItem('vam_setup');
                const cacheTime = localStorage.getItem('vam_cache_time');
                const cacheAge = cacheTime ? Date.now() - parseInt(cacheTime) : Infinity;
                
                // Use cache if less than 5 minutes old
                if (cachedClients && cachedSetup && cacheAge < 300000) {
                    const c = JSON.parse(cachedClients);
                    const s = JSON.parse(cachedSetup);
                    setClients(c);
                    setSetupData(s);
                    setLoading(false);
                    // Still fetch fresh data in background
                    fetchFreshData(false);
                } else {
                    // No cache or expired, fetch fresh
                    fetchFreshData(true);
                }
            }, [user]);

            const fetchFreshData = (updateLoading) => {
                Promise.all([
                    // Client Ads Performance - headers in row 2, skip row 1
                    fetch(URLS.clientAdsPerformance)
                        .then(r => r.text())
                        .then(csv => {
                            const lines = csv.split('\n');
                            const newCsv = [lines[1], ...lines.slice(2)].join('\n');
                            return Papa.parse(newCsv, { header: true, skipEmptyLines: true }).data.map(mapClient).filter(r => r.client);
                        })
                        .catch(err => {
                            console.error('Error fetching Client Ads Performance:', err);
                            return [];
                        }),
                    // Setup Timing - headers in row 1, skip row 2
                    fetch(URLS.setupTiming)
                        .then(r => r.text())
                        .then(csv => { 
                            const lines = csv.split('\n'); 
                            return Papa.parse([lines[0], ...lines.slice(2)].join('\n'), { header: true, skipEmptyLines: true }).data.map(mapSetupTiming).filter(r => r.client); 
                        })
                        .catch(err => {
                            console.error('Error fetching Setup Timing:', err);
                            return [];
                        })
                ]).then(([c, s]) => { 
                    // Save to cache
                    localStorage.setItem('vam_clients', JSON.stringify(c));
                    localStorage.setItem('vam_setup', JSON.stringify(s));
                    localStorage.setItem('vam_cache_time', Date.now().toString());
                    
                    setClients(c); 
                    setSetupData(s); 
                    if (updateLoading) setLoading(false);
                    if (c.length === 0) {
                        setError('No client data loaded. Make sure the Client Ads Performance sheet is published to web as CSV.');
                    }
                }).catch(err => {
                    console.error('Promise.all error:', err);
                    if (updateLoading) {
                        setError('Failed to load data: ' + err.message);
                        setLoading(false);
                    }
                });
            };

            const handleClientClick = (clientName) => {
                window.location.href = 'index.html?client=' + encodeURIComponent(clientName);
            };

            if (authLoading) return <div className="min-h-screen flex items-center justify-center text-4xl">‚è≥</div>;
            if (!user) return <LoginPage onLogin={setUser} />;
            if (loading) return <div className="min-h-screen flex items-center justify-center text-4xl">‚è≥</div>;
            if (error) return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="card p-8 max-w-lg text-center">
                        <div className="text-4xl mb-4">‚ö†Ô∏è</div>
                        <h2 className="text-xl font-bold text-red-400 mb-4">Error Loading Data</h2>
                        <p className="text-slate-400 mb-4">{error}</p>
                        <p className="text-slate-500 text-sm mb-4">Make sure the "Client Ads Performance" tab is published:</p>
                        <ol className="text-left text-slate-400 text-sm space-y-2 mb-4">
                            <li>1. Open Google Sheets</li>
                            <li>2. File ‚Üí Share ‚Üí Publish to web</li>
                            <li>3. Select "Client Ads Performance" tab</li>
                            <li>4. Format: CSV</li>
                            <li>5. Click Publish</li>
                        </ol>
                        <button onClick={() => window.location.reload()} className="px-6 py-2 bg-brand-cyan text-dark-900 rounded-lg font-medium">Retry</button>
                    </div>
                </div>
            );

            return (
                <AuthContext.Provider value={{ user }}>
                    <ThemeContext.Provider value={{ theme, toggleTheme }}>
                        <div className="flex min-h-screen">
                            <aside className="w-72 sidebar border-r flex flex-col divider">
                                <div className="p-5 border-b divider">
                                    <h1 className="text-xl font-bold bg-gradient-to-r from-brand-cyan to-brand-purple bg-clip-text text-transparent">VAM Media Buyer Overview</h1>
                                    <div className="flex items-center gap-2 mt-2"><div className="w-2 h-2 bg-emerald-500 rounded-full"></div><span className="text-xs text-secondary">{getDisplayName(user.email, user)}</span></div>
                                </div>
                                <nav className="flex-1 py-2">
                                    <button className="w-full flex items-start gap-3 px-5 py-3 text-left tab-active text-primary">
                                        <span className="text-lg">üìä</span>
                                        <div><div className="text-sm font-medium">All Clients</div><div className="text-xs text-muted">Overview of all client metrics</div></div>
                                    </button>
                                    <div className="px-4 pt-4 pb-2 space-y-2">
                                        <a href="index.html" className="block w-full text-center py-2 card hover-bg text-secondary rounded-lg text-sm">‚Üí Client Success Hub</a>
                                        <button onClick={() => supabase.auth.signOut()} className="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg text-sm">Logout</button>
                                    </div>
                                </nav>
                            </aside>
                            <main className="flex-1 flex flex-col">
                                <header className="header-bar backdrop-blur border-b px-8 py-4 flex items-center justify-between divider">
                                    <div>
                                        <h2 className="text-xl font-bold text-primary">Media Buyer Overview</h2>
                                        <p className="text-secondary text-sm">All clients at a glance ‚Ä¢ Data from Client Ads Performance sheet</p>
                                    </div>
                                    <button 
                                        onClick={toggleTheme}
                                        className="flex items-center gap-2 px-4 py-2 rounded-lg card hover-bg transition-colors text-sm"
                                    >
                                        {theme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark'}
                                    </button>
                                </header>
                                <div className="flex-1 overflow-y-auto p-8 scrollbar">
                                    <AllClientsView clients={clients} setupData={setupData} onClientClick={handleClientClick} />
                                </div>
                            </main>
                        </div>
                    </ThemeContext.Provider>
                </AuthContext.Provider>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
